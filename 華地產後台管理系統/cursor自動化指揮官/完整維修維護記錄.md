# ğŸ“‹ è¯åœ°ç”¢ç¶²ç«™ - å®Œæ•´ç¶­ä¿®ç¶­è­·è¨˜éŒ„

> **é …ç›®åç¨±**ï¼šBNIè¯åœ°ç”¢ç·šä¸Šé‘½çŸ³åˆ†æœƒ - é‚€è«‹é åœ–ç‰‡ä¸Šå‚³ç³»çµ±  
> **æŠ€è¡“æ£§**ï¼šHTML5 + JavaScript + Supabase (Storage + PostgreSQL)  
> **ç¶­è­·æ—¥æœŸ**ï¼š2025å¹´1æœˆ  
> **æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0

---

## ğŸ“‘ ç›®éŒ„

1. [é …ç›®æ¦‚è¿°](#é …ç›®æ¦‚è¿°)
2. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
3. [å®Œæ•´éŒ¯èª¤è¨˜éŒ„èˆ‡ä¿®å¾©](#å®Œæ•´éŒ¯èª¤è¨˜éŒ„èˆ‡ä¿®å¾©)
4. [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
5. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
6. [æ•…éšœæ’é™¤å¿«é€Ÿåƒè€ƒ](#æ•…éšœæ’é™¤å¿«é€Ÿåƒè€ƒ)

---

## ğŸ“– é …ç›®æ¦‚è¿°

### åŠŸèƒ½æè¿°
- å¯†ç¢¼ä¿è­·çš„åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼ˆå¯†ç¢¼ï¼š`888`ï¼‰
- æ”¯æŒå…©å¼µåœ–ç‰‡åŒæ™‚ä¸Šå‚³
- åœ–ç‰‡å­˜å„²åœ¨ Supabase Storage
- åœ–ç‰‡ URL å’Œå…ƒæ•¸æ“šå­˜å„²åœ¨ Supabase PostgreSQL æ•¸æ“šåº«
- è‡ªå‹•åˆªé™¤èˆŠåœ–ç‰‡ï¼ˆåŒæ—¥æœŸï¼‰
- å‹•æ…‹æ›´æ–°æ´»å‹•æ¨™é¡Œï¼ˆæ¯é€±å›› 09:00 å¾Œè‡ªå‹•åˆ‡æ›åˆ°ä¸‹é€±å››ï¼‰

### æ–‡ä»¶çµæ§‹
```
invite.html                    # ä¸»é é¢æ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰
supabase-invite-images-table.sql    # æ•¸æ“šåº«è¡¨çµæ§‹
supabase-storage-policies.sql        # å­˜å„²ç­–ç•¥é…ç½®
å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql                 # å¿«é€Ÿä¿®å¾© SQL
```

---

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

### å‰ç«¯
- **HTML5**ï¼šé é¢çµæ§‹
- **CSS3**ï¼šæ¨£å¼å’Œå‹•ç•«
- **JavaScript (ES6+)**ï¼šæ¥­å‹™é‚è¼¯
- **Supabase JS Client**ï¼šSupabase SDK

### å¾Œç«¯æœå‹™
- **Supabase Storage**ï¼šåœ–ç‰‡æ–‡ä»¶å­˜å„²
- **Supabase PostgreSQL**ï¼šåœ–ç‰‡ URL å’Œå…ƒæ•¸æ“šå­˜å„²
- **Supabase RLS (Row Level Security)**ï¼šå®‰å…¨ç­–ç•¥

### é…ç½®ä¿¡æ¯
```javascript
const SUPABASE_CONFIG = {
    url: 'https://sqgrnowrcvspxhuudrqc.supabase.co',
    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
    bucketName: 'hua-real-estate',
    projectName: 'hua-real-estate',
    moduleName: 'invite-photo'
};
```

---

## ğŸ”§ å®Œæ•´éŒ¯èª¤è¨˜éŒ„èˆ‡ä¿®å¾©

### éŒ¯èª¤ 1ï¼šR2 é…ç½®éŒ¯èª¤ï¼ˆå·²å»¢æ£„ï¼‰

#### âŒ éŒ¯èª¤è¨Šæ¯
```
ä¸Šå‚³å¤±æ•—: è«‹é…ç½® R2_CONFIG.apiEndpoint æˆ–è¨ªå•æ†‘è­‰
```

#### ğŸ” å•é¡ŒåŸå› 
- åˆå§‹è¨ˆåŠƒä½¿ç”¨ Cloudflare R2 å­˜å„²
- ç¼ºå°‘ R2 è¨ªå•æ†‘è­‰é…ç½®
- CORS å•é¡Œï¼ˆ`file://` å”è­°é™åˆ¶ï¼‰

#### âœ… è§£æ±ºæ–¹æ¡ˆ
- **æ±ºç­–**ï¼šæ”¹ç”¨ Supabase Storageï¼ˆæ›´ç°¡å–®ã€æ›´ç©©å®šï¼‰
- **åŸå› **ï¼šSupabase æä¾›å®Œæ•´çš„ SDK å’Œæ›´å¥½çš„ CORS æ”¯æŒ

---

### éŒ¯èª¤ 2ï¼šSupabase RLS ç­–ç•¥éŒ¯èª¤

#### âŒ éŒ¯èª¤è¨Šæ¯
```
StorageApiError: new row violates row-level security policy
```

#### ğŸ” å•é¡ŒåŸå› 
- Supabase Storage é»˜èªå•Ÿç”¨ RLSï¼ˆè¡Œç´šå®‰å…¨ï¼‰
- åŒ¿åç”¨æˆ¶æ²’æœ‰ä¸Šå‚³æ¬Šé™
- ç¼ºå°‘è®€å–æ¬Šé™ç­–ç•¥

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**æ­¥é©Ÿ 1ï¼šåŸ·è¡Œå­˜å„²ç­–ç•¥ SQL**

åŸ·è¡Œ `supabase-storage-policies.sql` æˆ– `å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql`ï¼š

```sql
-- å…è¨±å…¬é–‹è®€å–
CREATE POLICY "Allow public read all from hua-real-estate bucket"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'hua-real-estate');

-- å…è¨±å…¬é–‹ä¸Šå‚³ï¼ˆè·¯å¾‘é™åˆ¶ï¼‰
CREATE POLICY "Allow public uploads to hua-real-estate project"
ON storage.objects
FOR INSERT
TO public
WITH CHECK (
    bucket_id = 'hua-real-estate' 
    AND (storage.foldername(name))[1] = 'hua-real-estate'
);
```

**æ­¥é©Ÿ 2ï¼šè¨­ç½®å­˜å„²æ¡¶ç‚ºå…¬é–‹**

1. è¨ªå•ï¼šhttps://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/storage/buckets
2. é»æ“Š `hua-real-estate` å­˜å„²æ¡¶
3. **é–‹å•Ÿ "Public bucket" é–‹é—œ**
4. ä¿å­˜è¨­ç½®

**é©—è­‰**ï¼š
- å­˜å„²æ¡¶ç‹€æ…‹æ‡‰é¡¯ç¤ºç‚º "Public"
- å¯ä»¥é€šéå…¬é–‹ URL è¨ªå•åœ–ç‰‡

---

### éŒ¯èª¤ 3ï¼š`supabaseClient is not defined`

#### âŒ éŒ¯èª¤è¨Šæ¯
```
Uncaught (in promise) ReferenceError: supabaseClient is not defined
    at invite:2569:25
    at invite:2591:23
    at invite:2592:19
```

#### ğŸ” å•é¡ŒåŸå› 

1. **åŸ·è¡Œé †åºå•é¡Œ**
   - é é¢åŠ è¼‰è…³æœ¬åœ¨ `supabaseClient` è²æ˜ä¹‹å‰åŸ·è¡Œ
   - å˜—è©¦ä½¿ç”¨æœªåˆå§‹åŒ–çš„è®Šé‡

2. **ä½œç”¨åŸŸå•é¡Œ**
   - `supabaseClient` æ˜¯å±€éƒ¨è®Šé‡
   - ä¸åŒ `<script>` æ¨™ç±¤ç„¡æ³•å…±äº«

3. **ç•°æ­¥åˆå§‹åŒ–å•é¡Œ**
   - Supabase å®¢æˆ¶ç«¯éœ€è¦ç­‰å¾… CDN è¼‰å…¥
   - æ²’æœ‰ç­‰å¾…æ©Ÿåˆ¶

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**ä¿®æ”¹ 1ï¼šæ·»åŠ  `getSupabaseClient()` è¼”åŠ©å‡½æ•¸**

```javascript
// å®‰å…¨ç²å– supabaseClient çš„è¼”åŠ©å‡½æ•¸
function getSupabaseClient() {
    // å„ªå…ˆä½¿ç”¨ window.supabaseClientï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
    if (typeof window !== 'undefined' && window.supabaseClient) {
        return window.supabaseClient;
    }
    // å…¶æ¬¡ä½¿ç”¨å±€éƒ¨è®Šé‡
    if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
        return supabaseClient;
    }
    return null;
}
```

**ä¿®æ”¹ 2ï¼šè¨­ç½®å…¨å±€è®Šé‡**

```javascript
// è²æ˜æ™‚
let supabaseClient = null;
if (typeof window !== 'undefined') {
    window.supabaseClient = null;
}

// åˆå§‹åŒ–æ™‚
supabaseClient = supabaseLib.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
window.supabaseClient = supabaseClient; // é—œéµï¼
```

**ä¿®æ”¹ 3ï¼šå„ªåŒ–é é¢åŠ è¼‰ç­‰å¾…æ©Ÿåˆ¶**

```javascript
// åœ¨é é¢åŠ è¼‰è…³æœ¬ä¸­æå‰è²æ˜
if (typeof window.supabaseClient === 'undefined') {
    window.supabaseClient = null;
}

// æ·»åŠ ç­‰å¾…å’Œé‡è©¦æ©Ÿåˆ¶
(async function() {
    await new Promise(resolve => {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', resolve);
        } else {
            setTimeout(resolve, 100);
        }
    });
    
    // æª¢æŸ¥ä¸¦ç­‰å¾…åˆå§‹åŒ–
    let retryCount = 0;
    const maxRetries = 50; // æœ€å¤šç­‰å¾… 5 ç§’
    
    const checkAndLoad = setInterval(() => {
        retryCount++;
        const currentClient = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
        
        if (currentClient) {
            clearInterval(checkAndLoad);
            loadEventImagesFromSupabase();
            return;
        }
        
        if (typeof initSupabase === 'function') {
            initSupabase().then(() => {
                clearInterval(checkAndLoad);
                loadEventImagesFromSupabase();
            });
        }
        
        if (retryCount >= maxRetries) {
            clearInterval(checkAndLoad);
            console.warn('âš ï¸ Supabase åˆå§‹åŒ–è¶…æ™‚');
        }
    }, 100);
})();
```

**ä¿®æ”¹ 4ï¼šæ›´æ–°æ‰€æœ‰ä½¿ç”¨ `supabaseClient` çš„å‡½æ•¸**

å°‡æ‰€æœ‰ï¼š
- `if (!supabaseClient)` â†’ `const client = getSupabaseClient(); if (!client)`
- `supabaseClient.storage` â†’ `client.storage`
- `supabaseClient.from()` â†’ `client.from()`

**å½±éŸ¿çš„å‡½æ•¸**ï¼š
- `uploadToSupabase()`
- `deleteOldEventImages()`
- `saveEventImagesToSupabase()`
- `loadEventImagesFromSupabase()`

---

### éŒ¯èª¤ 4ï¼šåœ–ç‰‡ç„¡æ³•é¡¯ç¤ºï¼ˆå…¬é–‹è¨ªå•å•é¡Œï¼‰

#### âŒ éŒ¯èª¤è¨Šæ¯
```
åœ–ç‰‡ç„¡æ³•åŠ è¼‰
Failed to load resource: the server responded with a status of 403
```

#### ğŸ” å•é¡ŒåŸå› 

1. **å­˜å„²æ¡¶æœªè¨­ç½®ç‚ºå…¬é–‹**ï¼ˆæœ€å¸¸è¦‹ï¼‰
2. **RLS ç­–ç•¥ç¼ºå¤±æˆ–éŒ¯èª¤**
3. **URL æ ¼å¼ä¸æ­£ç¢º**

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**å¿«é€Ÿä¿®å¾©ï¼ˆ2 æ­¥ï¼‰**ï¼š

1. **åŸ·è¡Œ RLS ç­–ç•¥ SQL**
   - è¨ªå•ï¼šhttps://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/sql/new
   - åŸ·è¡Œ `å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql`

2. **è¨­ç½®å­˜å„²æ¡¶ç‚ºå…¬é–‹**
   - è¨ªå•ï¼šhttps://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/storage/buckets
   - é–‹å•Ÿ `hua-real-estate` çš„ "Public bucket" é–‹é—œ

**é©—è­‰æ–¹æ³•**ï¼š
```javascript
// åœ¨æ§åˆ¶å°æ¸¬è©¦åœ–ç‰‡å¯è¨ªå•æ€§
const testUrl = 'https://sqgrnowrcvspxhuudrqc.supabase.co/storage/v1/object/public/hua-real-estate/...';
fetch(testUrl, { method: 'HEAD', mode: 'no-cors' })
    .then(() => console.log('âœ… åœ–ç‰‡å¯è¨ªå•'))
    .catch(() => console.log('âŒ åœ–ç‰‡ç„¡æ³•è¨ªå•'));
```

---

### éŒ¯èª¤ 5ï¼š`InvalidKey` éŒ¯èª¤

#### âŒ éŒ¯èª¤è¨Šæ¯
```json
{
    "statusCode": "400",
    "error": "InvalidKey",
    "message": "Invalid key: [æ–‡ä»¶è·¯å¾„]"
}
```

#### ğŸ” å•é¡ŒåŸå› 

1. **æ–‡ä»¶è·¯å¾‘åŒ…å«éæ³•å­—ç¬¦**
   - ç‰¹æ®Šå­—ç¬¦ã€ç©ºæ ¼ã€ä¸­æ–‡ç­‰
2. **`getPublicUrl()` åƒæ•¸éŒ¯èª¤**
   - ä½¿ç”¨äº†ä¸æ”¯æŒçš„ `transform: null` åƒæ•¸
3. **è·¯å¾‘æ ¼å¼ä¸æ­£ç¢º**
   - é›™æ–œæ ã€å‰å°æ–œæ ç­‰

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**ä¿®æ”¹ 1ï¼šæ–‡ä»¶è·¯å¾‘æ¸…ç†**

```javascript
// æ¸…ç†é …ç›®åç¨±ã€æ¨¡å¡Šåç¨±å’Œæ–‡ä»¶å
const sanitizedProjectName = SUPABASE_CONFIG.projectName.replace(/[^a-zA-Z0-9_-]/g, '');
const sanitizedModuleName = SUPABASE_CONFIG.moduleName.replace(/[^a-zA-Z0-9_-]/g, '');
const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9._-]/g, '');

const filePath = `${sanitizedProjectName}/${sanitizedModuleName}/${sanitizedFileName}`;
```

**ä¿®æ”¹ 2ï¼šç§»é™¤éŒ¯èª¤çš„åƒæ•¸**

```javascript
// âŒ éŒ¯èª¤ï¼ˆæœƒå°è‡´ InvalidKeyï¼‰
const { data: urlData } = client.storage
    .from(bucketName)
    .getPublicUrl(filePath, { transform: null });

// âœ… æ­£ç¢º
const { data: urlData } = client.storage
    .from(bucketName)
    .getPublicUrl(filePath);
```

**ä¿®æ”¹ 3ï¼šè·¯å¾‘é©—è­‰**

```javascript
// é©—è­‰è·¯å¾‘æ ¼å¼
if (!filePath || filePath.trim() === '' || filePath.includes('//') || filePath.startsWith('/')) {
    throw new Error('æ–‡ä»¶è·¯å¾‘æ ¼å¼ç„¡æ•ˆ: ' + filePath);
}
```

---

### éŒ¯èª¤ 6ï¼šGoogle Sheets ä¾è³´å•é¡Œ

#### âŒ éŒ¯èª¤è¨Šæ¯
```
ç‚ºä»€éº¼å‰ç«¯é‚„æ˜¯æ¥sheets
```

#### ğŸ” å•é¡ŒåŸå› 
- ä»£ç¢¼ä¸­ä»æœ‰ Google Sheets ç›¸é—œå¼•ç”¨
- æœªå®Œå…¨é·ç§»åˆ° Supabase æ•¸æ“šåº«

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**ç§»é™¤æ‰€æœ‰ Google Sheets ç›¸é—œä»£ç¢¼**ï¼š

1. **ç§»é™¤ HTML ä¸­çš„å¼•ç”¨**
```html
<!-- âŒ åˆªé™¤é€™äº› -->
<link rel="stylesheet" href="sheets-data-loader-apps-script.css">
<script src="sheets-data-loader-apps-script.js"></script>
```

2. **ç§»é™¤å‡½æ•¸èª¿ç”¨**
```javascript
// âŒ åˆªé™¤
initInvitePage();

// âœ… æ›¿æ›ç‚º
loadEventImagesFromSupabase();
```

3. **ç¢ºèªæ•¸æ“šä¾†æº**
- æ‰€æœ‰åœ–ç‰‡æ•¸æ“šç¾åœ¨å¾ Supabase æ•¸æ“šåº«è®€å–
- ä¸å†ä¾è³´ Google Sheets

---

### éŒ¯èª¤ 7ï¼šåœ–ç‰‡é¡¯ç¤ºç·©æ…¢

#### âŒ å•é¡Œæè¿°
- åœ–ç‰‡åŠ è¼‰é€Ÿåº¦æ…¢
- ç”¨æˆ¶é«”é©—ä¸ä½³

#### âœ… è§£æ±ºæ–¹æ¡ˆ

**å„ªåŒ– 1ï¼šç§»é™¤ä¸å¿…è¦çš„å»¶é²**

```javascript
// âŒ åˆªé™¤
setTimeout(() => {
    loadEventImagesFromSupabase();
}, 500);

// âœ… ç«‹å³åŸ·è¡Œ
loadEventImagesFromSupabase();
```

**å„ªåŒ– 2ï¼šåœ–ç‰‡é åŠ è¼‰**

```javascript
function preloadEventImages(image1Url, image2Url) {
    // ä½¿ç”¨ Image å°è±¡é åŠ è¼‰
    const img1 = new Image();
    const img2 = new Image();
    img1.src = image1Url;
    img2.src = image2Url;
    
    // ä½¿ç”¨ link preload
    const link1 = document.createElement('link');
    link1.rel = 'preload';
    link1.as = 'image';
    link1.href = image1Url;
    link1.setAttribute('fetchpriority', 'high');
    document.head.appendChild(link1);
    
    // åŒæ¨£è™•ç† img2...
}
```

**å„ªåŒ– 3ï¼šä½¿ç”¨ `loading="eager"`**

```html
<!-- é—œéµåœ–ç‰‡ä½¿ç”¨ eager åŠ è¼‰ -->
<img src="..." loading="eager" fetchpriority="high" decoding="async">
```

---

## âš™ï¸ é…ç½®æŒ‡å—

### 1. Supabase é …ç›®é…ç½®

#### æ­¥é©Ÿ 1ï¼šå‰µå»ºæ•¸æ“šåº«è¡¨

åŸ·è¡Œ `supabase-invite-images-table.sql`ï¼š

```sql
CREATE TABLE IF NOT EXISTS invite_event_images (
    id BIGSERIAL PRIMARY KEY,
    event_title TEXT,
    event_date DATE,
    image1_url TEXT NOT NULL,
    image2_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_invite_event_images_date 
ON invite_event_images(event_date DESC);

-- å•Ÿç”¨ RLS
ALTER TABLE invite_event_images ENABLE ROW LEVEL SECURITY;

-- å…è¨±å…¬é–‹è®€å–å’Œå¯«å…¥
CREATE POLICY "Allow public read from invite_event_images" 
ON invite_event_images FOR SELECT TO public USING (true);

CREATE POLICY "Allow public insert to invite_event_images" 
ON invite_event_images FOR INSERT TO public WITH CHECK (true);
```

#### æ­¥é©Ÿ 2ï¼šé…ç½®å­˜å„²ç­–ç•¥

åŸ·è¡Œ `supabase-storage-policies.sql` æˆ– `å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql`

#### æ­¥é©Ÿ 3ï¼šè¨­ç½®å­˜å„²æ¡¶

1. å‰µå»ºå­˜å„²æ¡¶ï¼š`hua-real-estate`
2. **å¿…é ˆé–‹å•Ÿ "Public bucket"**
3. ç¢ºèªç­–ç•¥å·²æ‡‰ç”¨

#### æ­¥é©Ÿ 4ï¼šç²å– API å¯†é‘°

1. è¨ªå•ï¼šhttps://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/settings/api
2. è¤‡è£½ "anon" æˆ– "public" key
3. æ›´æ–° `invite.html` ä¸­çš„ `SUPABASE_CONFIG.anonKey`

---

### 2. ä»£ç¢¼é…ç½®

#### æ›´æ–°é…ç½®å°è±¡

åœ¨ `invite.html` ä¸­æ‰¾åˆ° `SUPABASE_CONFIG`ï¼ˆç´„ç¬¬ 3090 è¡Œï¼‰ï¼š

```javascript
const SUPABASE_CONFIG = {
    url: 'https://sqgrnowrcvspxhuudrqc.supabase.co',
    anonKey: 'ä½ çš„anon key', // âš ï¸ å¿…é ˆæ›´æ–°
    bucketName: 'hua-real-estate',
    projectName: 'hua-real-estate',
    moduleName: 'invite-photo'
};
```

#### ä¸Šå‚³å¯†ç¢¼é…ç½®

```javascript
const UPLOAD_PASSWORD = '888'; // å¯ä¿®æ”¹
```

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. è®Šé‡ä½œç”¨åŸŸç®¡ç†

âœ… **æ¨è–¦åšæ³•**ï¼š
```javascript
// ä½¿ç”¨å…¨å±€è®Šé‡ + è¼”åŠ©å‡½æ•¸
let supabaseClient = null;
window.supabaseClient = null;

function getSupabaseClient() {
    return window.supabaseClient || supabaseClient || null;
}
```

âŒ **é¿å…**ï¼š
```javascript
// ç›´æ¥ä½¿ç”¨å¯èƒ½æœªå®šç¾©çš„è®Šé‡
if (supabaseClient) { ... } // å¯èƒ½å ±éŒ¯
```

### 2. ç•°æ­¥åˆå§‹åŒ–è™•ç†

âœ… **æ¨è–¦åšæ³•**ï¼š
```javascript
// ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶
let retryCount = 0;
const maxRetries = 50;
const checkAndLoad = setInterval(() => {
    if (getSupabaseClient()) {
        clearInterval(checkAndLoad);
        // åŸ·è¡Œæ“ä½œ
    }
    if (retryCount++ >= maxRetries) {
        clearInterval(checkAndLoad);
    }
}, 100);
```

### 3. æ–‡ä»¶è·¯å¾‘è™•ç†

âœ… **æ¨è–¦åšæ³•**ï¼š
```javascript
// æ¸…ç†è·¯å¾‘ï¼Œç§»é™¤éæ³•å­—ç¬¦
const sanitize = (str) => str.replace(/[^a-zA-Z0-9._-]/g, '');
const filePath = `${sanitize(projectName)}/${sanitize(moduleName)}/${sanitize(fileName)}`;

// é©—è­‰è·¯å¾‘
if (!filePath || filePath.includes('//') || filePath.startsWith('/')) {
    throw new Error('ç„¡æ•ˆè·¯å¾‘');
}
```

### 4. éŒ¯èª¤è™•ç†

âœ… **æ¨è–¦åšæ³•**ï¼š
```javascript
try {
    const client = getSupabaseClient();
    if (!client) {
        throw new Error('å®¢æˆ¶ç«¯æœªåˆå§‹åŒ–');
    }
    // åŸ·è¡Œæ“ä½œ
} catch (error) {
    console.error('è©³ç´°éŒ¯èª¤:', error);
    showStatus(index, 'âŒ ' + error.message, 'error');
}
```

### 5. åœ–ç‰‡ URL é©—è­‰

âœ… **æ¨è–¦åšæ³•**ï¼š
```javascript
function ensurePublicUrl(url) {
    if (!url) return null;
    
    // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼ï¼Œç›´æ¥è¿”å›
    if (url.includes('/storage/v1/object/public/')) {
        return url;
    }
    
    // å¦å‰‡æ‰‹å‹•æ§‹å»º
    const filePath = extractFilePath(url);
    return `${SUPABASE_CONFIG.url}/storage/v1/object/public/${SUPABASE_CONFIG.bucketName}/${filePath}`;
}
```

---

## ğŸš¨ æ•…éšœæ’é™¤å¿«é€Ÿåƒè€ƒ

### å•é¡Œï¼šåœ–ç‰‡ç„¡æ³•ä¸Šå‚³

**æª¢æŸ¥æ¸…å–®**ï¼š
1. âœ… Supabase é…ç½®æ˜¯å¦æ­£ç¢ºï¼ˆURLã€anonKeyï¼‰
2. âœ… å­˜å„²æ¡¶æ˜¯å¦å­˜åœ¨
3. âœ… RLS ç­–ç•¥æ˜¯å¦å·²é…ç½®
4. âœ… å­˜å„²æ¡¶æ˜¯å¦ç‚ºå…¬é–‹
5. âœ… æ–‡ä»¶è·¯å¾‘æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦

**å¿«é€Ÿä¿®å¾©**ï¼š
```sql
-- åŸ·è¡Œå¿«é€Ÿä¿®å¾© SQL
-- æ–‡ä»¶ï¼šå¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql
```

---

### å•é¡Œï¼šåœ–ç‰‡ç„¡æ³•é¡¯ç¤º

**æª¢æŸ¥æ¸…å–®**ï¼š
1. âœ… å­˜å„²æ¡¶ "Public bucket" æ˜¯å¦é–‹å•Ÿ
2. âœ… RLS ç­–ç•¥æ˜¯å¦å…è¨±å…¬é–‹è®€å–
3. âœ… åœ–ç‰‡ URL æ ¼å¼æ˜¯å¦æ­£ç¢º
4. âœ… ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS éŒ¯èª¤

**å¿«é€Ÿä¿®å¾©**ï¼š
1. é–‹å•Ÿå­˜å„²æ¡¶çš„ "Public bucket" é–‹é—œ
2. åŸ·è¡Œ `å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql`

---

### å•é¡Œï¼š`supabaseClient is not defined`

**æª¢æŸ¥æ¸…å–®**ï¼š
1. âœ… æ˜¯å¦ä½¿ç”¨äº† `getSupabaseClient()` å‡½æ•¸
2. âœ… `window.supabaseClient` æ˜¯å¦å·²è¨­ç½®
3. âœ… é é¢åŠ è¼‰é †åºæ˜¯å¦æ­£ç¢º

**å¿«é€Ÿä¿®å¾©**ï¼š
- ç¢ºä¿æ‰€æœ‰ä½¿ç”¨ `supabaseClient` çš„åœ°æ–¹éƒ½æ”¹ç‚º `getSupabaseClient()`
- ç¢ºä¿åˆå§‹åŒ–æ™‚è¨­ç½® `window.supabaseClient`

---

### å•é¡Œï¼š`InvalidKey` éŒ¯èª¤

**æª¢æŸ¥æ¸…å–®**ï¼š
1. âœ… æ–‡ä»¶è·¯å¾‘æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦
2. âœ… `getPublicUrl()` æ˜¯å¦ä½¿ç”¨äº†éŒ¯èª¤åƒæ•¸
3. âœ… è·¯å¾‘æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆç„¡é›™æ–œæ ã€ç„¡å‰å°æ–œæ ï¼‰

**å¿«é€Ÿä¿®å¾©**ï¼š
```javascript
// æ¸…ç†è·¯å¾‘
const sanitize = (str) => str.replace(/[^a-zA-Z0-9._-]/g, '');
const filePath = `${sanitize(projectName)}/${sanitize(moduleName)}/${sanitize(fileName)}`;

// ç§»é™¤ transform åƒæ•¸
const { data: urlData } = client.storage
    .from(bucketName)
    .getPublicUrl(filePath); // ä¸è¦åŠ  { transform: null }
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

### SQL æ–‡ä»¶
- `supabase-invite-images-table.sql` - æ•¸æ“šåº«è¡¨çµæ§‹
- `supabase-storage-policies.sql` - å®Œæ•´å­˜å„²ç­–ç•¥
- `å¿«é€Ÿä¿®å¾©RLSç­–ç•¥.sql` - å¿«é€Ÿä¿®å¾© SQL

### é…ç½®æ–‡æª”
- `Supabaseé…ç½®èªªæ˜.md` - Supabase é…ç½®æŒ‡å—
- `Supabaseæ•¸æ“šåº«è¨­ç½®èªªæ˜.md` - æ•¸æ“šåº«è¨­ç½®æ­¥é©Ÿ
- `Supabaseå­˜å„²ç­–ç•¥é…ç½®.md` - å­˜å„²ç­–ç•¥è©³ç´°èªªæ˜

### æ•…éšœæ’é™¤æ–‡æª”
- `åœ–ç‰‡ç„¡æ³•é¡¯ç¤ºè§£æ±ºæ–¹æ¡ˆ.md` - åœ–ç‰‡é¡¯ç¤ºå•é¡Œè¨ºæ–·
- `ç«‹å³ä¿®å¾©åœ–ç‰‡ç„¡æ³•é¡¯ç¤º.md` - å¿«é€Ÿä¿®å¾©æŒ‡å—
- `é‡è¦ä¿®å¾©supabaseClientæœªå®šç¾©éŒ¯èª¤èªªæ˜.md` - è©³ç´°ä¿®å¾©èªªæ˜

---

## âœ… é©—è­‰æª¢æŸ¥æ¸…å–®

### åˆå§‹è¨­ç½®é©—è­‰

- [ ] Supabase é …ç›®å·²å‰µå»º
- [ ] æ•¸æ“šåº«è¡¨å·²å‰µå»ºï¼ˆ`invite_event_images`ï¼‰
- [ ] å­˜å„²æ¡¶å·²å‰µå»ºï¼ˆ`hua-real-estate`ï¼‰
- [ ] å­˜å„²æ¡¶è¨­ç½®ç‚ºå…¬é–‹ï¼ˆPublic bucketï¼‰
- [ ] RLS ç­–ç•¥å·²é…ç½®
- [ ] API å¯†é‘°å·²æ›´æ–°åˆ°ä»£ç¢¼ä¸­

### åŠŸèƒ½é©—è­‰

- [ ] å¯†ç¢¼é©—è­‰åŠŸèƒ½æ­£å¸¸ï¼ˆå¯†ç¢¼ï¼š888ï¼‰
- [ ] åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½æ­£å¸¸
- [ ] åœ–ç‰‡é¡¯ç¤ºåŠŸèƒ½æ­£å¸¸
- [ ] èˆŠåœ–ç‰‡è‡ªå‹•åˆªé™¤åŠŸèƒ½æ­£å¸¸
- [ ] æ´»å‹•æ¨™é¡Œè‡ªå‹•æ›´æ–°åŠŸèƒ½æ­£å¸¸

### éŒ¯èª¤æª¢æŸ¥

- [ ] æ§åˆ¶å°ç„¡ `supabaseClient is not defined` éŒ¯èª¤
- [ ] æ§åˆ¶å°ç„¡ `InvalidKey` éŒ¯èª¤
- [ ] æ§åˆ¶å°ç„¡ RLS ç­–ç•¥éŒ¯èª¤
- [ ] åœ–ç‰‡å¯ä»¥æ­£å¸¸åŠ è¼‰å’Œé¡¯ç¤º

---

## ğŸ“ æ›´æ–°æ—¥èªŒ

### 2025å¹´1æœˆ
- âœ… å¾ Cloudflare R2 é·ç§»åˆ° Supabase Storage
- âœ… å¾ Google Sheets é·ç§»åˆ° Supabase PostgreSQL
- âœ… ä¿®å¾© `supabaseClient is not defined` éŒ¯èª¤
- âœ… ä¿®å¾© RLS ç­–ç•¥é…ç½®å•é¡Œ
- âœ… ä¿®å¾© `InvalidKey` éŒ¯èª¤
- âœ… å„ªåŒ–åœ–ç‰‡åŠ è¼‰æ€§èƒ½
- âœ… ç¾åŒ–ä¸Šå‚³æˆåŠŸæç¤ºå½ˆçª—
- âœ… æ·»åŠ å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œè¨ºæ–·

---

## ğŸ”— é‡è¦éˆæ¥

- **Supabase Dashboard**: https://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc
- **å­˜å„²æ¡¶è¨­ç½®**: https://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/storage/buckets
- **RLS ç­–ç•¥**: https://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/storage/policies
- **SQL Editor**: https://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/sql/new
- **API è¨­ç½®**: https://supabase.com/dashboard/project/sqgrnowrcvspxhuudrqc/settings/api

---

**æ–‡æª”ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ  
**æœ€å¾Œæ›´æ–°**ï¼š2025å¹´1æœˆ  
**æ–‡æª”ç‹€æ…‹**ï¼šâœ… å®Œæ•´ä¸”æœ€æ–°

---

> ğŸ’¡ **æç¤º**ï¼šå¦‚æœé‡åˆ°æ–°å•é¡Œï¼Œè«‹å…ˆæŸ¥çœ‹æœ¬æ–‡ä»¶çš„ã€Œæ•…éšœæ’é™¤å¿«é€Ÿåƒè€ƒã€éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†å•é¡Œéƒ½æœ‰å°æ‡‰çš„è§£æ±ºæ–¹æ¡ˆã€‚
