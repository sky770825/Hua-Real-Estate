# Vite 多專案共用後端架構規則

> **啟動提示詞：修改 Vite 專案時請嚴格遵守此架構規則**

---

## 【後端架構約定】

- 所有專案共用「單一 Supabase Project（公司級後端中樞）」
- Supabase 使用 schema + app_id + RLS 隔離專案
- 禁止在前端使用 Supabase service_role key
- 私密金鑰 / admin 操作 / onboarding 全部由 Cloudflare Workers 中台處理

---

## 【前端必要設定（不可省略）】

### 環境變數（Vite 格式）

專案必須使用以下環境變數：

- `VITE_SUPABASE_URL` - Supabase 專案 URL
- `VITE_SUPABASE_ANON_KEY` - Supabase 匿名金鑰（公開金鑰）
- `VITE_API_BASE` - Cloudflare Workers API 基礎 URL
- `VITE_APP_ID` - 當前專案的 app_id 識別碼

### Onboard 自動呼叫

前端登入後「必須自動呼叫」以下 API：

```
POST ${VITE_API_BASE}/api/onboard
```

**請求規格：**
- Header: `Authorization: Bearer {access_token}` (使用 Supabase session 的 access_token)
- Header: `x-app-id: ${VITE_APP_ID}`
- Onboard 只能成功呼叫一次，之後需避免重複請求（可用 localStorage 記錄狀態）

---

## 【Supabase 存取規則】

- 前端只能操作屬於自己 `app_id` 的資料
- 所有資料表都有 `app_id` / `owner_id` 欄位
- RLS（Row Level Security）已啟用，不要嘗試繞過或關閉
- 前端僅使用 `anon` key，絕不使用 `service_role` key

---

## 【AI 助手執行檢查清單】

當修改 Vite 專案時，請確認：

- [ ] 專案有 Supabase client 設定（使用 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY`）
- [ ] 有 onboard helper 函數（處理 `/api/onboard` 呼叫）
- [ ] 登入後自動觸發 onboard（使用 localStorage 避免重複）
- [ ] 所有 Supabase 查詢都包含 `app_id` 過濾條件
- [ ] 沒有使用 `service_role` key 的程式碼
- [ ] 環境變數檔案（`.env`）包含所有必要變數

---

## 【需要新增/修改的檔案範例】

### 1. Supabase Client (`src/lib/supabase.ts`)

```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### 2. Onboard Helper (`src/lib/onboard.ts`)

```typescript
const ONBOARD_KEY = 'app_onboarded'

export async function callOnboard(session: any) {
  // 檢查是否已經 onboard
  if (localStorage.getItem(ONBOARD_KEY) === 'true') {
    return { success: true, alreadyOnboarded: true }
  }

  const apiBase = import.meta.env.VITE_API_BASE
  const appId = import.meta.env.VITE_APP_ID

  if (!apiBase || !appId) {
    throw new Error('Missing API environment variables')
  }

  try {
    const response = await fetch(`${apiBase}/api/onboard`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'x-app-id': appId,
        'Content-Type': 'application/json',
      },
    })

    if (response.ok) {
      localStorage.setItem(ONBOARD_KEY, 'true')
      return { success: true }
    }

    throw new Error(`Onboard failed: ${response.statusText}`)
  } catch (error) {
    console.error('Onboard error:', error)
    throw error
  }
}
```

### 3. 登入後自動觸發 (`src/hooks/useAuth.ts` 或類似)

```typescript
import { supabase } from '@/lib/supabase'
import { callOnboard } from '@/lib/onboard'

// 在登入成功後
supabase.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session) {
    try {
      await callOnboard(session)
    } catch (error) {
      console.error('Failed to onboard:', error)
    }
  }
})
```

---

## 【重要提醒】

- 若專案缺少 supabase client、onboard helper、或啟動呼叫，請自動補齊
- 若現有程式不符合上述規則，請調整到符合為止
- 回覆請直接提供「需要新增/修改的檔案 + 完整內容」，不要只給片段建議
