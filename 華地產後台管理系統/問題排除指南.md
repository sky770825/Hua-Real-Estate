# 問題排除指南

## 📋 目錄
1. [伺服器無法啟動](#伺服器無法啟動)
2. [頁面顯示錯誤](#頁面顯示錯誤)
3. [API 請求失敗](#api-請求失敗)
4. [會議刪除失敗](#會議刪除失敗)
5. [日期選擇器問題](#日期選擇器問題)
6. [快取問題](#快取問題)
7. [資料庫連接問題](#資料庫連接問題)
8. [構建錯誤](#構建錯誤)

---

## 🔧 伺服器無法啟動

### 問題症狀
- 無法訪問 `http://localhost:3001`
- 端口被佔用錯誤
- 頁面顯示 "無法連接到伺服器"

### 解決步驟

#### 1. 檢查端口是否被佔用
```bash
# 檢查端口 3001 是否被佔用
lsof -ti:3001

# 如果被佔用，強制關閉
lsof -ti:3001 | xargs kill -9
```

#### 2. 清除構建快取
```bash
cd "華地產後台管理系統"
rm -rf .next
```

#### 3. 重新啟動伺服器
```bash
npm run dev
```

#### 4. 驗證伺服器狀態
```bash
# 檢查 API 是否正常
curl http://localhost:3001/api/members

# 檢查進程
lsof -ti:3001
```

### 快速修復腳本
```bash
# 一鍵修復：清理並重啟
cd "華地產後台管理系統"
lsof -ti:3001 | xargs kill -9 2>/dev/null
rm -rf .next
npm run dev
```

---

## 🐛 頁面顯示錯誤

### 問題症狀
- 頁面顯示 "載入中..." 但無法載入
- F5 刷新後頁面無法顯示
- 出現 "Cannot find module" 錯誤

### 解決步驟

#### 1. 清除 Next.js 構建快取
```bash
cd "華地產後台管理系統"
rm -rf .next
```

#### 2. 清除瀏覽器快取
- Chrome/Edge: `Ctrl+Shift+Delete` (Windows) 或 `Cmd+Shift+Delete` (Mac)
- 選擇「快取的圖片和檔案」
- 清除最近 1 小時的資料

#### 3. 重新啟動開發伺服器
```bash
npm run dev
```

#### 4. 檢查瀏覽器控制台
- 按 `F12` 打開開發者工具
- 查看 Console 標籤的錯誤訊息
- 查看 Network 標籤的失敗請求

### 常見錯誤訊息

#### `Cannot find module './XXX.js'`
**原因**: Next.js 構建快取損壞

**解決方法**:
```bash
rm -rf .next
npm run dev
```

#### `ModuleBuildError`
**原因**: 模組構建失敗

**解決方法**:
```bash
rm -rf .next
rm -rf node_modules/.cache
npm run dev
```

---

## 🔌 API 請求失敗

### 問題症狀
- API 返回 500 錯誤
- 請求超時
- 資料無法載入

### 解決步驟

#### 1. 檢查 API 端點
```bash
# 測試會員 API
curl http://localhost:3001/api/members

# 測試會議 API
curl http://localhost:3001/api/meetings

# 測試簽到 API
curl "http://localhost:3001/api/checkins?date=2026-01-16"
```

#### 2. 檢查伺服器日誌
- 查看終端機的錯誤訊息
- 檢查是否有資料庫連接錯誤
- 確認環境變數是否正確設定

#### 3. 檢查網路請求
- 打開瀏覽器開發者工具 (F12)
- 查看 Network 標籤
- 檢查失敗請求的狀態碼和錯誤訊息

### 常見 API 錯誤

#### HTTP 429 (Too Many Requests)
**原因**: 請求過於頻繁

**解決方法**:
- 等待 1-2 分鐘後再試
- 檢查是否有無限循環的請求
- 增加請求間隔時間

#### HTTP 500 (Internal Server Error)
**原因**: 伺服器內部錯誤

**解決方法**:
1. 查看伺服器終端機的錯誤日誌
2. 檢查資料庫連接
3. 清除快取後重試
4. 重啟伺服器

#### HTTP 404 (Not Found)
**原因**: API 路由不存在

**解決方法**:
- 確認 API 路由路徑正確
- 檢查 `app/api` 目錄下的路由檔案是否存在
- 確認路由檔案導出了正確的函數 (GET, POST, DELETE 等)

---

## 🗑️ 會議刪除失敗

### 問題症狀
- 點擊刪除按鈕沒有反應
- 刪除後會議仍然存在
- 出現錯誤提示

### 解決步驟

#### 1. 檢查瀏覽器控制台
- 按 `F12` 打開開發者工具
- 查看 Console 是否有錯誤訊息
- 查看 Network 標籤的 DELETE 請求狀態

#### 2. 檢查 API 路由
```bash
# 測試刪除 API (替換 {id} 為實際會議 ID)
curl -X DELETE http://localhost:3001/api/meetings/{id}
```

#### 3. 清除快取
```bash
# 清除會議快取
# 在系統設定頁面點擊「清除快取」按鈕
```

#### 4. 檢查資料庫權限
- 確認 Supabase 資料庫有刪除權限
- 檢查 RLS (Row Level Security) 政策

### 已修復的功能
- ✅ 樂觀更新：刪除後立即從 UI 移除
- ✅ 錯誤處理：顯示清晰的錯誤訊息
- ✅ 快取清除：自動清除相關快取
- ✅ 狀態同步：刪除後重新載入數據

---

## 📅 日期選擇器問題

### 問題症狀
- 日期選擇器顯示過去的日期
- 日期選項太多難以選擇
- 無法選擇未來的日期

### 解決步驟

#### 1. 清除瀏覽器快取
- 清除快取的 JavaScript 檔案
- 強制重新載入頁面 (`Ctrl+Shift+R` 或 `Cmd+Shift+R`)

#### 2. 檢查日期範圍設定
- 系統預設顯示未來 3 個月內的週四
- 點擊「更多」按鈕可載入更多日期
- 系統會自動擴展日期範圍（當選擇接近末尾時）

#### 3. 重新載入頁面
```bash
# 如果問題持續，重啟伺服器
npm run dev
```

### 已優化的功能
- ✅ 只顯示未來日期（從今天或最近的週四開始）
- ✅ 初始只顯示 3 個月內的日期
- ✅ 動態載入更多日期（點擊「更多」按鈕）
- ✅ 自動擴展日期範圍（當選擇接近末尾時）

---

## 💾 快取問題

### 問題症狀
- 資料顯示過時
- 更新後看不到最新資料
- 刪除後資料仍然顯示

### 解決步驟

#### 1. 手動清除快取
- 前往「系統設定」頁面
- 點擊「清除快取」按鈕
- 需要開發者密碼：`888`

#### 2. 清除瀏覽器快取
- 清除快取的 API 回應
- 強制重新載入頁面

#### 3. 重啟伺服器（清除伺服器端快取）
```bash
# 停止伺服器 (Ctrl+C)
# 重新啟動
npm run dev
```

### 快取機制說明
- **伺服器端快取**: 5 分鐘 TTL（會員、會議等）
- **簽到記錄快取**: 1 分鐘 TTL（變化較頻繁）
- **自動清除**: 當資料更新/刪除時自動清除相關快取

---

## 🗄️ 資料庫連接問題

### 問題症狀
- API 返回資料庫錯誤
- 無法載入會員或會議資料
- 出現 Supabase 連接錯誤

### 解決步驟

#### 1. 檢查環境變數
確認 `.env.local` 檔案存在且包含：
```
NEXT_PUBLIC_SUPABASE_URL=你的 Supabase URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的 Supabase Anon Key
```

#### 2. 檢查 Supabase 服務狀態
- 訪問 Supabase Dashboard
- 確認專案狀態正常
- 檢查 API 配額是否用盡

#### 3. 檢查資料庫權限
- 確認 RLS (Row Level Security) 政策正確
- 檢查服務角色密鑰是否正確

#### 4. 測試資料庫連接
```bash
# 在瀏覽器控制台測試
fetch('/api/members')
  .then(r => r.json())
  .then(console.log)
  .catch(console.error)
```

### 常見資料庫錯誤

#### `Invalid API key`
**原因**: Supabase API 密鑰錯誤或過期

**解決方法**:
1. 檢查 `.env.local` 檔案
2. 確認 Supabase Dashboard 中的 API 密鑰
3. 重新設定環境變數
4. 重啟伺服器

#### `Row Level Security policy violation`
**原因**: RLS 政策限制

**解決方法**:
1. 檢查 Supabase Dashboard 中的 RLS 政策
2. 確認政策允許當前操作
3. 調整政策或使用服務角色密鑰

---

## 🔨 構建錯誤

### 問題症狀
- `npm run dev` 失敗
- TypeScript 編譯錯誤
- 模組找不到錯誤

### 解決步驟

#### 1. 清除所有快取和構建檔案
```bash
cd "華地產後台管理系統"
rm -rf .next
rm -rf node_modules/.cache
```

#### 2. 重新安裝依賴
```bash
npm install
```

#### 3. 檢查 TypeScript 錯誤
```bash
npm run lint
```

#### 4. 重新構建
```bash
npm run dev
```

### 常見構建錯誤

#### `Cannot find module`
**解決方法**:
```bash
rm -rf node_modules
npm install
```

#### TypeScript 類型錯誤
**解決方法**:
1. 檢查 `tsconfig.json` 設定
2. 確認所有類型定義正確
3. 運行 `npm run lint` 查看詳細錯誤

#### 記憶體不足
**解決方法**:
```bash
# 增加 Node.js 記憶體限制
NODE_OPTIONS="--max-old-space-size=4096" npm run dev
```

---

## 🚀 快速修復流程

當遇到任何問題時，按以下順序嘗試：

### 步驟 1: 基本檢查
```bash
# 1. 檢查伺服器是否運行
lsof -ti:3001

# 2. 檢查 API 是否正常
curl http://localhost:3001/api/members
```

### 步驟 2: 清除快取
```bash
# 清除構建快取
rm -rf .next

# 清除瀏覽器快取（手動操作）
# Chrome: Ctrl+Shift+Delete
```

### 步驟 3: 重啟服務
```bash
# 停止伺服器
lsof -ti:3001 | xargs kill -9

# 重新啟動
npm run dev
```

### 步驟 4: 檢查日誌
- 查看終端機的錯誤訊息
- 查看瀏覽器控制台 (F12)
- 查看 Network 標籤的失敗請求

### 步驟 5: 如果問題持續
1. 檢查環境變數設定
2. 檢查資料庫連接
3. 查看 Supabase Dashboard 的錯誤日誌
4. 檢查系統設定頁面的錯誤訊息

---

## 📞 獲取幫助

### 檢查清單
在報告問題前，請確認：
- [ ] 伺服器是否正在運行
- [ ] 瀏覽器控制台是否有錯誤
- [ ] 網路請求是否成功
- [ ] 是否已嘗試清除快取
- [ ] 是否已重啟伺服器

### 有用的命令
```bash
# 檢查伺服器狀態
lsof -ti:3001 && echo "運行中" || echo "未運行"

# 測試 API
curl http://localhost:3001/api/members | jq '.members | length'

# 一鍵修復
cd "華地產後台管理系統" && lsof -ti:3001 | xargs kill -9 2>/dev/null && rm -rf .next && npm run dev
```

---

## 📝 更新日誌

### 2026-01-16
- ✅ 修復會議刪除功能（添加樂觀更新和錯誤處理）
- ✅ 優化日期選擇器（只顯示未來日期，動態載入）
- ✅ 改進快取清除機制（刪除時自動清除相關快取）
- ✅ 更新年份支援（確保正確處理 2026 年及之後）

---

## 🔍 問題診斷流程圖

```
遇到問題
    ↓
檢查伺服器是否運行？
    ├─ 否 → 啟動伺服器 (npm run dev)
    └─ 是 → 繼續
        ↓
檢查瀏覽器控制台錯誤？
    ├─ 有錯誤 → 根據錯誤訊息處理
    └─ 無錯誤 → 繼續
        ↓
清除快取並重啟？
    ├─ 未嘗試 → 清除快取並重啟
    └─ 已嘗試 → 繼續
        ↓
檢查 API 端點？
    ├─ API 失敗 → 檢查資料庫連接
    └─ API 正常 → 繼續
        ↓
檢查特定功能問題？
    ├─ 會議刪除 → 查看會議刪除章節
    ├─ 日期選擇 → 查看日期選擇器章節
    └─ 其他 → 查看對應章節
```

---

**最後更新**: 2026-01-16
**版本**: 1.0.0
