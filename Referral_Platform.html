<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025年 華地產鑽石分會引薦平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* 手機版允許滾動 */
        @media (max-width: 768px) {
            body {
                overflow: auto;
                overflow-x: hidden;
            }
            
            .app-container {
                min-height: 100vh;
                height: auto;
            }
        }

        .app-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
        }

        /* 頂部控制欄 */
        .top-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 18px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-container {
            flex: 1;
            max-width: 650px;
            position: relative;
            margin: 0 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 16px;
        }

        .search-clear-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-clear-btn:hover {
            background: #f1f3f4;
            color: #667eea;
        }

        .search-input:not(:placeholder-shown) + .search-clear-btn {
            opacity: 1;
        }

        /* 搜索結果增強樣式 */
        .search-result-item {
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #e3e8ff !important;
            transform: translateX(5px);
        }

        .search-result-item.highlight {
            background: #fff3cd !important;
            border-left-color: #ffc107 !important;
        }

        .search-highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            color: #856404;
        }

        /* 搜索歷史樣式 */
        .search-history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .search-history-item:hover {
            background: #f8f9fa;
        }

        .search-history-icon {
            font-size: 14px;
            color: #999;
        }

        .search-history-delete {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            color: #dc3545;
            font-size: 12px;
        }

        .search-history-item:hover .search-history-delete {
            opacity: 1;
        }

        /* 使用說明框 */
        .usage-notice {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #fff3cd, #ffe69c);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 15px 25px;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
            z-index: 999;
            max-width: 90%;
            width: 600px;
            transition: all 0.3s ease;
            animation: slideDown 0.5s ease-out;
        }

        .usage-notice.collapsed {
            height: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            margin: 0;
            border: none;
        }

        .usage-notice-content {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #856404;
            line-height: 1.6;
        }

        .usage-notice-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .usage-notice-text {
            flex: 1;
            font-weight: 500;
        }

        .usage-notice-text strong {
            color: #856404;
            font-weight: 700;
        }

        .usage-notice-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #856404;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .usage-notice-close:hover {
            background: rgba(133, 100, 4, 0.1);
            color: #5c3f00;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* 熱門搜索標籤 */
        .popular-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .popular-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .popular-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* 摺疊/展開控制 */
        .collapse-control {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            font-size: 12px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .collapse-control:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.8);
            color: #666;
            border: 1px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: white;
            transform: translateY(-1px);
        }

        /* 心智圖容器 */
        .mindmap-container {
            width: 100%;
            height: calc(100vh - 80px);
            margin-top: 80px;
            position: relative;
            overflow: auto;
            cursor: grab;
            transition: margin-top 0.3s ease;
        }

        /* 手機版心智圖容器調整 */
        @media (max-width: 768px) {
            .mindmap-container {
                height: auto;
                min-height: calc(100vh - 80px);
                overflow: visible;
                padding-bottom: 40px;
            }
        }

        /* 當使用說明框收合時，調整心智圖容器 */
        .mindmap-container.with-notice {
            margin-top: 150px;
        }

        .mindmap-container:active {
            cursor: grabbing;
        }

        .mindmap-container.dragging {
            cursor: grabbing;
        }

        .mindmap-content {
            position: relative;
            width: 100%;
            min-height: 100%;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        /* 中心節點 */
        .center-node {
            display: none;
        }

        .center-node:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 107, 107, 0.4);
        }

        .center-node.pulse {
            animation: pulse 2s infinite;
        }

        /* 分支節點 */
        .branch {
            position: absolute;
            transform-origin: center;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .branch.active {
            opacity: 1;
        }

        .branch-node {
            background: white;
            color: #333;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            white-space: nowrap;
            max-width: 200px;
            min-width: 160px;
            text-align: center;
            line-height: 1.3;
            position: relative;
            width: fit-content;
            word-wrap: break-word;
            hyphens: auto;
        }

        .branch-node:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .branch-node.has-children::after {
            content: "▶";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .branch-node.expanded::after {
            transform: translateY(-50%) rotate(90deg);
        }

        /* 子分支 */
        .sub-branch {
            position: absolute;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 手機版兩欄佈局 - 針對絕對定位的特殊處理 */
        @media (max-width: 768px) {
            .sub-branch {
                width: auto !important;
                max-width: 90vw !important;
            }
            
            /* 使用 flex-wrap 實現兩欄效果 */
            .sub-branch .sub-node {
                display: inline-block !important;
                width: calc(50% - 6px) !important;
                max-width: calc(50% - 6px) !important;
                min-width: 0 !important;
                margin: 2px !important;
                vertical-align: top !important;
            }
        }

        .sub-branch.active {
            opacity: 1;
        }

        .sub-node {
            background: #f8f9fa;
            color: #666;
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 11px;
            font-weight: 500;
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            white-space: nowrap;
            margin: 2px 0;
            line-height: 1.2;
            position: relative;
            width: fit-content;
            min-width: 100px;
            max-width: 150px;
            text-align: center;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub-node:hover {
            background: #e9ecef;
            transform: scale(1.02);
            border-color: #667eea;
        }

        .sub-node.has-details::after {
            content: "ℹ";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 連接線 */
        .connection-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.5));
            transform-origin: left center;
            opacity: 0;
            transition: all 0.6s ease;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .connection-line.active {
            opacity: 1;
        }

        /* 詳細資訊面板 */
        .details-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 350px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .details-panel.active {
            transform: translateX(0);
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .details-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f1f3f4;
            color: #333;
        }

        .referral-section {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .referral-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .referral-info {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .add-referral-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .add-referral-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* 縮放控制 */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 18px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .zoom-level {
            text-align: center;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        /* 搜尋結果高亮 */
        .highlight {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .top-controls {
                padding: 15px 20px;
                flex-wrap: wrap;
                gap: 15px;
            }

            .search-container {
                order: 3;
                width: 100%;
                max-width: none;
                margin: 0;
            }

            .control-buttons {
                gap: 12px;
            }

            .btn {
                padding: 10px 18px;
                font-size: 13px;
                margin: 0 3px;
            }

            .details-panel {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
                top: 80px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
            
            .details-panel:not(.active) {
                display: none !important;
            }
            
            /* 隱藏縮放控制 */
            .zoom-controls {
                display: none !important;
            }

            .center-node {
                font-size: 18px;
                padding: 20px 30px;
            }

            .branch-node {
                font-size: 13px;
                padding: 12px 20px;
            }

            .sub-node {
                font-size: 12px;
                padding: 8px 15px;
                width: 100% !important;
                max-width: none !important;
                min-width: 80px !important;
                margin: 0 !important;
            }

            /* 使用說明框響應式 */
            .usage-notice {
                top: 120px;
                width: calc(100% - 40px);
                padding: 12px 18px;
            }

            .usage-notice-content {
                font-size: 12px;
                gap: 10px;
            }

            .usage-notice-icon {
                font-size: 20px;
            }

            .usage-notice-text {
                line-height: 1.4;
            }

            /* 手機版心智圖容器調整 */
            .mindmap-container {
                margin-top: 130px;
            }
            
            .mindmap-container.with-notice {
                margin-top: 220px;
            }
        }

        /* 動畫 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* 載入動畫 */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 回到頂部按鈕 */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .scroll-to-top.active {
            display: flex;
        }

        @media (max-width: 768px) {
            .scroll-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div style="text-align: center; color: #666; font-size: 14px;">載入心智圖中...</div>
    </div>

    <div class="app-container">
        <!-- 頂部控制欄 -->
        <div class="top-controls">
            <div class="logo">💎 2025年 華地產鑽石分會引薦平台</div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-input" id="searchInput" placeholder="搜尋分類或服務..." autocomplete="off">
                <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" title="清除搜索">✕</button>
            </div>
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="showReferralForm()">
                    👥 引薦登記
                </button>
                <button class="btn btn-secondary" onclick="showDataView()">
                    📊 資料查看
                </button>
            </div>
        </div>

        <!-- 使用說明框 -->
        <div class="usage-notice" id="usageNotice">
            <div class="usage-notice-content">
                <div class="usage-notice-icon">⚠️</div>
                <div class="usage-notice-text">
                    <strong>使用提示：</strong>此引薦平台僅供引薦<strong>會員沒有的區域及資源</strong>，以確保不會損失會員權益。
                </div>
                <button class="usage-notice-close" onclick="closeUsageNotice()" title="關閉提示">×</button>
            </div>
        </div>

        <!-- 心智圖容器 -->
        <div class="mindmap-container" id="mindmapContainer">
            <div class="mindmap-content" id="mindmapContent">
                <div class="center-node" id="centerNode">2025年 華地產鑽石分會引薦平台</div>
            </div>
        </div>

        <!-- 回到頂部按鈕 -->
        <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()" title="回到頂部">↑</button>

        <!-- 詳細資訊面板 -->
        <div class="details-panel" id="detailsPanel">
            <div class="details-header">
                <div class="details-title" id="detailsTitle">詳細資訊</div>
                <button class="close-btn" onclick="closeDetails()">×</button>
            </div>
            <div id="detailsContent">
                <p>點擊任何項目查看詳細資訊和引薦人資料</p>
            </div>
            <div class="referral-section">
                <div class="referral-title">📞 引薦人資訊</div>
                <div class="referral-info" id="referralInfo">
                    點擊上方項目查看相關引薦人資訊
                </div>
                <button class="add-referral-btn" onclick="addReferral()">添加引薦人</button>
            </div>
        </div>

        <!-- 縮放控制 -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <div class="zoom-level" id="zoomLevel">100%</div>
            <button class="zoom-btn" onclick="zoomOut()">-</button>
        </div>
    </div>

    <script>
        // 心智圖數據結構
        const mindmapData = {
            "2025年 華地產鑽石分會引薦平台": {
                // 簡化版分類 - 更直觀易用
                "🎨 設計與規劃": {
                    "建築與室內設計": ["建築師", "室內設計", "景觀設計", "空間規劃", "住宅設計", "商空設計"],
                    "裝潢與軟裝": ["裝潢設計", "軟裝設計", "傢俱設計", "燈光設計", "室內裝潢", "色彩規劃"],
                    "工程設計": ["機電設計", "結構設計", "消防顧問", "空調設計", "給排水設計"],
                    "環境與特殊設計": ["綠建築設計", "節能設計", "環保設計", "合法隔套設計", "模組化輕裝修"],
                    "BIM與管理": ["BIM服務", "3D可視化", "專案管理", "時程控管", "成本控管"]
                },
                "🔨 工程規劃與修繕": {
                    "統包工程": ["統包工程", "總包", "分包管理", "營造商"],
                    "基礎工程": ["水電工程", "泥作工程", "鐵工工程", "鋁門窗工程", "結構補強"],
                    "裝修工程": ["木作工程", "磁磚工程", "石材工程", "玻璃工程", "塗料工程", "天花板工程", "地板工程"],
                    "機電系統": ["機電工程", "弱電工程", "消防工程", "通訊服務", "電梯", "空調系統"],
                    "智慧化系統": ["智慧工程", "智能家居", "IoT物聯網", "自動化控制", "能源管理系統"],
                    "能源工程": ["太陽能安裝", "儲能系統", "充電樁安裝"],
                    "特殊工程": ["帷幕牆工程", "防水隔熱", "耐震補強", "修繕服務", "房屋修繕", "老屋翻新"],
                    "交付與服務": ["驗收流程", "點交服務", "使用說明", "施工清潔", "廢棄物處理"],
                    "建材與設備": ["建材供應", "施工設備", "吊車", "高空作業", "測量儀器"]
                },
                "💰 房屋買賣與交易": {
                    "仲介服務": ["住宅仲介", "商業不動產", "海外不動產", "不動產經紀"],
                    "交易服務": ["履約保證", "產權調查", "過戶服務", "點交過戶"],
                    "特殊物件": ["土地買賣", "預售屋", "成屋", "中古屋", "新成屋"],
                    "特殊渠道": ["代銷", "法拍", "都更整合", "重劃區開發"],
                    "地政服務": ["土地開發", "危老都更整合", "地政士服務", "不動產登記"]
                },
                "💰 理財規劃與資金": {
                    "貸款服務": ["購屋貸款", "房貸", "房貸轉增貸", "房貸代償", "貸款規劃", "信用貸款", "企業貸款", "個人信貸"],
                    "建築融資": ["開發融資", "工程款融資", "土地融資", "建築融資規劃"],
                    "理財規劃": ["理財顧問", "投資理財", "資產配置", "財務規劃", "退休規劃"],
                    "不動產投資": ["REITs", "不動產基金", "私募股權", "不動產證券化"],
                    "保險服務": ["富邦人壽", "國泰人壽", "新光人壽", "南山人壽", "保險規劃", "壽險", "產險"],
                    "風險保障": ["工程險", "責任險", "工程履約保證", "火險", "地震險", "產物保險"],
                    "稅務規劃": ["不動產稅務規劃", "遺產規劃", "節稅規劃", "財產移轉規劃"]
                },
                "⚖️ 專業服務與培訓": {
                    "法律與稅務": ["律師", "會計師", "不動產估價師", "地政士（代書）", "法規諮詢"],
                    "檢測與驗屋": ["驗屋服務", "房屋檢測", "結構檢測", "漏水檢測", "甲醛檢測"],
                    "環境與市場": ["環境治理", "土壤污染檢測", "市場研究", "可行性評估", "投資評估"],
                    "培訓與顧問": ["人才培訓", "職業訓練", "技能培訓", "證照代辦", "顧問服務", "買房陪跑服務", "買房陪跑教練", "買房課程"]
                },
                "📢 行銷曝光與推廣": {
                    "建案行銷": ["預售屋代銷", "成屋代銷", "建案代銷"],
                    "數位行銷": ["網站建置", "SEO優化", "Google廣告", "Facebook廣告"],
                    "資訊平台": ["實價登錄查詢", "591租屋網", "信義房屋網"],
                    "內容行銷": ["建案文宣", "建案影片拍攝", "建案攝影"],
                    "傳統行銷": ["品牌企劃", "媒體投放", "活動企劃"],
                    "廣告標識": ["LED 廣告牌", "廣告設計", "招牌製作"]
                },
                "🏢 商業營運與維護": {
                    "物業與租賃": ["物業管理", "租賃服務", "包租代管", "短租營運", "Airbnb代營運"],
                    "維護服務": ["機電維護", "清潔服務", "園藝維護", "裝修輔助", "電梯保養", "空調保養"],
                    "安全與停車": ["安全維護", "保全", "門禁管理", "停車管理", "停車場管理"],
                    "生活服務": ["搬家服務", "家政服務", "廢棄物清運", "廢棄物回收"],
                    "數位平台": ["物業管理系統", "社區APP", "數位平台"]
                },
                "🛍️ 傢俱傢電與建材": {
                    "傢俱採購": ["客廳傢俱", "臥室傢俱", "餐廳傢俱", "書房傢俱", "訂製傢俱", "系統傢俱", "戶外傢俱", "辦公傢俱"],
                    "家電採購": ["廚房家電", "客廳家電", "臥室家電", "衛浴家電", "智慧家電", "節能家電", "空氣清淨機", "除濕機", "清潔家電"],
                    "寢具採購": ["床墊", "床組", "寢具套組", "枕頭", "被子", "床單", "床罩", "羊毛被", "羽絨被"],
                    "窗簾與家飾": ["窗簾", "窗飾", "家飾擺設", "地毯", "掛畫", "花瓶", "擺飾"],
                    "燈具照明": ["吊燈", "吸頂燈", "壁燈", "落地燈", "桌燈", "LED燈", "智能燈具"],
                    "衛浴用品": ["馬桶", "洗手台", "浴缸", "淋浴設備", "鏡子", "衛浴五金", "衛浴配件"],
                    "五金配件": ["門鎖", "把手", "鉸鏈", "滑軌", "螺絲", "釘子", "五金配件"],
                    "建材採購": ["鋼筋水泥", "磁磚石材", "木材板材", "油漆塗料", "玻璃材料", "金屬材料", "防水材料", "隔熱材料", "地板材料", "天花板材料", "門窗材料"],
                    "安防設備": ["監控系統", "門禁系統", "警報器", "防盜設備", "智能門鎖"]
                }
            }
        };

        // Google Sheets 設定
        const SHEET_CONFIG = {
            // Apps Script Web App URL
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwS35-ZT2ehCrjwWe1qaduUjKJGHGdQXW_DQBesiS0jcsLFRzbDvIKUUS-6jIkiXY6j/exec',
            // 傳統 Google Sheets API 設定（備用）
            REFERRAL_SHEET_ID: '1rzFA6bqsz_Au1wiMEGj2nxrlG3uOdDMPddBZBT7sqEY', // 引薦登記工作表ID
            ACCESS_LOG_SHEET_ID: '1rzFA6bqsz_Au1wiMEGj2nxrlG3uOdDMPddBZBT7sqEY', // 使用記錄工作表ID（同一個Sheet的不同工作表）
            MEMBER_SHEET_ID: '1rzFA6bqsz_Au1wiMEGj2nxrlG3uOdDMPddBZBT7sqEY', // 會員資料工作表ID（用於快搜會員編號）
            API_KEY: 'YOUR_GOOGLE_SHEETS_API_KEY' // 請替換為您的Google Sheets API金鑰
        };
        
        // 會員資料快取（本地緩存）
        let memberDataCache = null;
        let memberDataCacheTime = null;
        const MEMBER_CACHE_DURATION = 5 * 60 * 1000; // 5分鐘緩存

        // 引薦人資料庫
        const referralData = {
            "室內泥作": {
                name: "張師傅",
                company: "專業泥作工程",
                phone: "0912-345-678",
                email: "zhang@example.com",
                experience: "15年經驗，專精室內外泥作工程"
            },
            "鋼構工程": {
                name: "李師傅",
                company: "精工鐵藝",
                phone: "0934-567-890",
                email: "li@example.com",
                experience: "20年經驗，鋼構工程專家"
            },
            "建築師": {
                name: "王建築師",
                company: "王建築師事務所",
                phone: "0922-123-456",
                email: "wang@example.com",
                experience: "註冊建築師，15年設計經驗"
            }
        };

        // 細分資料庫 - 支援無限層級細分
        const subdivisionData = {
            "室內泥作": {
                "技術工項": ["牆面粉刷", "地面找平", "天花板處理", "牆面修補"],
                "特殊處理": ["防水工程", "防潮處理", "隔音處理", "平整度處理"]
            },
            "室外泥作": {
                "外牆工程": ["外牆粉刷", "外牆修補", "外牆防水", "外牆美化"],
                "屋頂工程": ["屋頂防水", "屋頂修繕", "防水隔熱", "排水系統"]
            },
            "鋼構工程": {
                "大型鋼構": ["鋼樑製作", "鋼柱安裝", "鋼板焊接", "鋼構吊裝"],
                "維護服務": ["鋼構檢查", "防鏽處理", "結構補強", "定期保養"]
            },
            "水電安裝": {
                "給水系統": ["進水管線", "配水管線", "水錶安裝", "水泵設置"],
                "排水系統": ["污水管線", "廢水管線", "雨水管線", "化糞池"],
                "電氣系統": ["配電盤", "插座開關", "照明線路", "接地系統"]
            },
            "機電設備": {
                "動力設備": ["發電機", "馬達", "變頻器", "控制箱"],
                "空調設備": ["分離式冷氣", "中央空調", "通風設備", "除濕機"],
                "其他設備": ["熱水器", "電梯", "電扶梯", "電動門"]
            },
            "消防設備": {
                "滅火系統": ["自動灑水", "泡沫系統", "乾粉系統", "消防栓"],
                "警報系統": ["煙感警報", "熱感警報", "聲光警報", "廣播系統"],
                "逃生設備": ["緊急照明", "出口標示", "防火門", "避難器具"]
            },
            "監控系統": {
                "攝影設備": ["監視器", "錄影主機", "雲端儲存", "行動監控"],
                "整合服務": ["遠端監控", "智能辨識", "警報連動", "系統維護"]
            },
            "智慧家電": {
                "控制系統": ["智能開關", "場景控制", "語音控制", "手機APP"],
                "家電設備": ["智能燈具", "智能冷氣", "智能鎖", "智能插座"],
                "整合服務": ["居家自動化", "能源管理", "遠端控制", "系統維護"]
            }
        };

        let isExpanded = false;
        let branches = [];
        let currentZoom = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let currentDetails = null;
        let isCollapsedAll = false; // 全局摺疊狀態
        let displayMode = localStorage.getItem('displayMode') || 'compact'; // 'compact' 或 'full'
        let mergeRegions = localStorage.getItem('mergeRegions') !== 'false'; // 合併區域項目，默認開啟
        let showResourcesOnly = localStorage.getItem('showResourcesOnly') === 'true'; // 只顯示有引薦人的資源

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 立即隱藏載入動畫並顯示心智圖
            document.getElementById('loading').style.display = 'none';
            createMindmap();
            setupEventListeners();
            
            // 初始化按鈕狀態
            updateButtonsState();
            
            // 檢查使用說明框狀態
            checkUsageNotice();
            
            // 後台異步載入資料（不阻塞UI）
            Promise.all([
                loadReferralData(),
                loadMemberData()
            ]).then(() => {
                console.log('✅ 所有資料載入完成');
            }).catch(err => {
                console.warn('⚠️ 資料載入失敗:', err);
            });
            
            // 後台運行測試（不阻塞UI）
            setTimeout(() => {
                loadUnlockedContacts();
                testAppsScriptConnection();
                testGoogleSheetsConnection();
            }, 100);
        });
        
        // 更新按鈕狀態
        function updateButtonsState() {
            // 更新只看資源按鈕
            const resourcesBtn = document.getElementById('resourcesOnlyBtn');
            if (resourcesBtn) {
                if (showResourcesOnly) {
                    resourcesBtn.textContent = '👥 只看資源';
                    resourcesBtn.classList.add('btn-primary');
                    resourcesBtn.classList.remove('btn-secondary');
                } else {
                    resourcesBtn.textContent = '📋 顯示全部';
                    resourcesBtn.classList.add('btn-secondary');
                    resourcesBtn.classList.remove('btn-primary');
                }
            }
            
            // 更新顯示模式按鈕
            const modeBtn = document.getElementById('displayModeBtn');
            if (modeBtn) {
                modeBtn.textContent = displayMode === 'compact' ? '📄 簡潔模式' : '📋 完整模式';
            }
            
            // 更新合併按鈕
            const mergeBtn = document.getElementById('mergeRegionsBtn');
            if (mergeBtn) {
                mergeBtn.textContent = mergeRegions ? '🔗 已合併' : '📋 分開顯示';
            }
        }
        
        // 測試 Apps Script 連接
        async function testAppsScriptConnection() {
            if (SHEET_CONFIG.APPS_SCRIPT_URL && SHEET_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL') {
                try {
                    const response = await fetch(SHEET_CONFIG.APPS_SCRIPT_URL);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Apps Script 連接成功');
                        
                        // 測試讀取引薦資料
                        const referralsUrl = `${SHEET_CONFIG.APPS_SCRIPT_URL}?action=getReferrals`;
                        try {
                            const referralsResponse = await fetch(referralsUrl);
                            if (referralsResponse.ok) {
                                const referralsResult = await referralsResponse.json();
                                console.log('✅ 讀取引薦資料測試成功');
                                console.log(`   找到 ${referralsResult.data ? referralsResult.data.length : 0} 筆引薦資料`);
                            } else {
                                console.warn('⚠️ 讀取引薦資料測試失敗:', referralsResponse.status);
                            }
                        } catch (referralsError) {
                            console.warn('⚠️ 讀取引薦資料測試錯誤:', referralsError);
                        }
                        
                        return true;
                    } else {
                        console.warn('⚠️ Apps Script 連接失敗:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.warn('⚠️ Apps Script 連接測試失敗:', error);
                    return false;
                }
            }
            return false;
        }
        
        // 測試 Google Sheets API 連接
        async function testGoogleSheetsConnection() {
            if (SHEET_CONFIG.API_KEY && SHEET_CONFIG.API_KEY !== 'YOUR_GOOGLE_SHEETS_API_KEY') {
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.REFERRAL_SHEET_ID}?key=${SHEET_CONFIG.API_KEY}`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Google Sheets API 連接成功:', result.properties.title);
                        return true;
                    } else {
                        console.warn('⚠️ Google Sheets API 連接失敗:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.warn('⚠️ Google Sheets API 連接測試失敗:', error);
                    return false;
                }
            }
            return false;
        }
        
        // 從 Google Sheets 載入會員資料
        async function loadMemberData() {
            // 檢查緩存是否有效
            if (memberDataCache && memberDataCacheTime && 
                (Date.now() - memberDataCacheTime) < MEMBER_CACHE_DURATION) {
                console.log('✅ 使用緩存的會員資料');
                return memberDataCache;
            }
            
            try {
                console.log('開始從 Google Sheets 載入會員資料...');
                
                // 使用 Apps Script Web App 讀取會員資料
                if (SHEET_CONFIG.APPS_SCRIPT_URL && SHEET_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL') {
                    const url = `${SHEET_CONFIG.APPS_SCRIPT_URL}?action=getMembers`;
                    console.log('🔗 請求 URL:', url);
                    
                    try {
                        const response = await fetch(url);
                        console.log('會員資料請求回應狀態:', response.status);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('會員資料回應結果:', result.success ? '成功' : '失敗');
                            
                            // 檢查是否返回了預設測試訊息（表示 Apps Script 可能沒有正確處理 action）
                            if (result.message && result.message.includes('運行正常') && !result.data) {
                                console.warn('⚠️ Apps Script 返回了預設測試訊息，可能沒有正確處理 getMembers action');
                                console.warn('💡 請確認：');
                                console.warn('   1. Google Apps Script 已部署最新版本');
                                console.warn('   2. doGet 函數中已添加 getMembers 的處理邏輯');
                                console.warn('   3. getMembers 函數已正確定義');
                                console.warn('   4. 「會員資料」工作表已建立並有資料');
                                
                                // 返回空數據，但不顯示錯誤
                                memberDataCache = {};
                                memberDataCacheTime = Date.now();
                                return {};
                            }
                            
                            if (result.success) {
                                if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                                    // 建立會員編號到會員資訊的映射
                                    const memberMap = {};
                                    result.data.forEach(member => {
                                        const code = String(member.code || member.memberCode || '').trim();
                                        const name = String(member.name || '').trim();
                                        const professionalCategory = String(member.professionalCategory || '').trim();
                                        const password = String(member.password || '').trim();
                                        
                                        if (code && name) {
                                            // 建立會員資訊對象
                                            const memberInfo = {
                                                name: name,
                                                professionalCategory: professionalCategory,
                                                password: password
                                            };
                                            
                                            // 原始編號
                                            memberMap[code] = memberInfo;
                                            
                                            // 處理數字格式：確保所有可能的格式都能匹配
                                            const numericValue = parseInt(code, 10);
                                            if (!isNaN(numericValue)) {
                                                // 映射多種格式：如 "001" -> ["001", "01", "1"]
                                                // 生成所有可能的格式（1-3位數）
                                                for (let digits = 1; digits <= 3; digits++) {
                                                    const formattedCode = String(numericValue).padStart(digits, '0');
                                                    if (formattedCode !== code) {
                                                        memberMap[formattedCode] = memberInfo;
                                                    }
                                                }
                                                // 也映射純數字版本（去掉前導零）
                                                const pureNumber = String(numericValue);
                                                if (pureNumber !== code) {
                                                    memberMap[pureNumber] = memberInfo;
                                                }
                                            }
                                        }
                                    });
                                    
                                    memberDataCache = memberMap;
                                    memberDataCacheTime = Date.now();
                                    
                                    console.log(`✅ 成功載入 ${Object.keys(memberMap).length} 筆會員資料`);
                                    return memberMap;
                                } else {
                                    console.log('ℹ️ 會員資料為空，這是正常的（如果還沒有建立會員資料工作表或添加會員資料）');
                                    console.log('💡 提示：');
                                    console.log('   1. 在 Google Sheets 中執行 initializeSheets() 函數建立「會員資料」工作表');
                                    console.log('   2. 在「會員資料」工作表中添加會員編號和姓名');
                                    console.log('   3. 刷新頁面即可使用快速搜索功能');
                                    
                                    // 返回空對象但標記為成功，這樣不會顯示錯誤
                                    memberDataCache = {};
                                    memberDataCacheTime = Date.now();
                                    return {};
                                }
                            } else {
                                console.warn('⚠️ 讀取會員資料失敗:', result.message || '未知錯誤');
                                if (result.message && result.message.includes('找不到')) {
                                    console.log('💡 提示：請先在 Google Sheets 中執行 initializeSheets() 函數建立「會員資料」工作表');
                                }
                            }
                        } else {
                            const errorText = await response.text();
                            console.warn('⚠️ HTTP 請求失敗:', response.status, errorText);
                        }
                    } catch (fetchError) {
                        console.warn('⚠️ Fetch 請求失敗:', fetchError.message);
                        console.warn('詳細錯誤:', fetchError);
                    }
                }
                
                // 如果載入失敗，返回空對象
                console.warn('⚠️ 無法載入會員資料，將使用本地資料');
                memberDataCache = {};
                memberDataCacheTime = Date.now();
                return {};
                
            } catch (error) {
                console.warn('⚠️ 載入會員資料時發生錯誤:', error);
                memberDataCache = {};
                memberDataCacheTime = Date.now();
                return {};
            }
        }
        
        // 搜尋會員姓名（根據會員編號）- 現在返回完整的會員資訊對象
        async function searchMemberName(memberCode) {
            if (!memberCode || memberCode.trim() === '') {
                console.log('🔍 搜索會員：輸入為空');
                return null;
            }
            
            // 載入會員資料（如果還沒有載入）
            const memberData = await loadMemberData();
            
            // 調試：顯示會員資料內容
            console.log('🔍 搜索會員編號:', memberCode);
            console.log('📊 當前會員資料庫大小:', Object.keys(memberData).length);
            
            // 清理輸入的編號（移除空格和非數字字符）
            const cleanCode = memberCode.trim().replace(/[^0-9]/g, '');
            
            if (!cleanCode) {
                console.log('🔍 搜索會員：清理後編號為空');
                return null;
            }
            
            console.log('🔍 清理後的編號:', cleanCode);
            
            // 嘗試多種編號格式進行搜索
            const searchPatterns = [
                cleanCode,                    // 原樣：如 "001" 或 "1"
                cleanCode.padStart(3, '0'),  // 補零到3位：如 "1" -> "001"
                String(parseInt(cleanCode, 10)) // 去掉前導零：如 "001" -> "1"
            ];
            
            // 去除重複的搜索模式
            const uniquePatterns = [...new Set(searchPatterns)];
            
            console.log('🔍 嘗試搜索模式:', uniquePatterns);
            
            // 逐一嘗試搜索
            for (const pattern of uniquePatterns) {
                console.log(`🔍 嘗試模式 "${pattern}":`, memberData[pattern] ? '找到' : '未找到');
                if (memberData[pattern]) {
                    // 返回不包含密碼的會員資訊
                    const memberInfo = memberData[pattern];
                    return {
                        name: memberInfo.name,
                        professionalCategory: memberInfo.professionalCategory
                    };
                }
            }
            
            // 如果都找不到，嘗試更靈活的匹配（支援任意長度的補零）
            const numericValue = parseInt(cleanCode, 10);
            if (!isNaN(numericValue)) {
                console.log('🔍 嘗試靈活匹配，數值為:', numericValue);
                // 嘗試 1-3 位數格式：1, 01, 001
                for (let digits = 1; digits <= 3; digits++) {
                    const paddedCode = String(numericValue).padStart(digits, '0');
                    console.log(`🔍 嘗試 "${paddedCode}":`, memberData[paddedCode] ? '找到' : '未找到');
                    if (memberData[paddedCode]) {
                        // 返回不包含密碼的會員資訊
                        const memberInfo = memberData[paddedCode];
                        return {
                            name: memberInfo.name,
                            professionalCategory: memberInfo.professionalCategory
                        };
                    }
                }
            }
            
            console.log('❌ 未找到會員編號:', memberCode);
            console.log('💡 提示：請確認會員資料已正確載入，或檢查編號格式');
            return null;
        }
        
        // 載入引薦資料（只從 Google Sheets 讀取）
        async function loadReferralData() {
            // 清空現有的引薦資料
            Object.keys(referralData).forEach(key => {
                delete referralData[key];
            });
            
            // 從 Google Sheets 載入最新資料（僅使用 Google Sheets 的資料）
            await loadReferralsFromSheets();
        }
        
        // 從 Google Sheets 讀取使用記錄
        async function loadAccessLogsFromSheets() {
            try {
                console.log('開始從 Google Sheets 讀取使用記錄...');
                
                // 使用 Apps Script Web App 讀取資料
                if (SHEET_CONFIG.APPS_SCRIPT_URL && SHEET_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL') {
                    const url = `${SHEET_CONFIG.APPS_SCRIPT_URL}?action=getAccessLogs`;
                    
                    // 方法1：嘗試使用 fetch（帶 JSONP callback 回退）
                    try {
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const result = await response.json();
                            return result;
                        } else {
                            console.warn('⚠️ Fetch 請求失敗，嘗試 JSONP 方式...');
                            return await tryJsonpMethodForLogs(url);
                        }
                    } catch (fetchError) {
                        console.warn('⚠️ Fetch 請求失敗:', fetchError.message);
                        console.log('嘗試使用 JSONP 方式...');
                        return await tryJsonpMethodForLogs(url);
                    }
                } else {
                    console.log('ℹ️ Apps Script URL 未設定，跳過從 Google Sheets 讀取');
                    return { success: false, data: [] };
                }
            } catch (error) {
                console.warn('⚠️ 從 Google Sheets 讀取使用記錄時發生錯誤:', error);
                return { success: false, data: [] };
            }
        }
        
        // 嘗試使用 JSONP 方式讀取使用記錄
        function tryJsonpMethodForLogs(url) {
            return new Promise((resolve) => {
                try {
                    const callbackName = 'loadAccessLogsCallback_' + Date.now();
                    const jsonpUrl = `${url}&callback=${callbackName}`;
                    
                    // 創建回調函數
                    window[callbackName] = function(result) {
                        try {
                            // 清理回調函數
                            delete window[callbackName];
                            
                            // 移除 script 標籤
                            const script = document.getElementById('accessLogsJsonp');
                            if (script) {
                                document.body.removeChild(script);
                            }
                            
                            resolve(result);
                        } catch (error) {
                            console.warn('⚠️ 處理使用記錄時發生錯誤:', error);
                            resolve({ success: false, data: [] });
                        }
                    };
                    
                    // 創建 script 標籤進行 JSONP 請求
                    const script = document.createElement('script');
                    script.id = 'accessLogsJsonp';
                    script.src = jsonpUrl;
                    script.onerror = function() {
                        console.warn('⚠️ JSONP 請求失敗');
                        delete window[callbackName];
                        const script = document.getElementById('accessLogsJsonp');
                        if (script) {
                            document.body.removeChild(script);
                        }
                        resolve({ success: false, data: [] });
                    };
                    
                    // 設置超時
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.warn('⚠️ JSONP 請求超時');
                            delete window[callbackName];
                            const script = document.getElementById('accessLogsJsonp');
                            if (script) {
                                document.body.removeChild(script);
                            }
                            resolve({ success: false, data: [] });
                        }
                    }, 10000);
                    
                    document.body.appendChild(script);
                } catch (error) {
                    console.warn('⚠️ JSONP 請求創建失敗:', error);
                    resolve({ success: false, data: [] });
                }
            });
        }
        
        // 從 Google Sheets 讀取引薦資料（多種方式嘗試）
        async function loadReferralsFromSheets() {
            try {
                console.log('開始從 Google Sheets 讀取引薦資料...');
                
                // 使用 Apps Script Web App 讀取資料
                if (SHEET_CONFIG.APPS_SCRIPT_URL && SHEET_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL') {
                    const url = `${SHEET_CONFIG.APPS_SCRIPT_URL}?action=getReferrals`;
                    
                    // 方法1：嘗試使用 fetch（帶 JSONP callback 回退）
                    try {
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const result = await response.json();
                            return processReferralData(result);
                        } else {
                            console.warn('⚠️ Fetch 請求失敗，嘗試 JSONP 方式...');
                            return await tryJsonpMethod(url);
                        }
                    } catch (fetchError) {
                        console.warn('⚠️ Fetch 請求失敗:', fetchError.message);
                        console.log('嘗試使用 JSONP 方式...');
                        return await tryJsonpMethod(url);
                    }
                } else {
                    console.log('ℹ️ Apps Script URL 未設定，跳過從 Google Sheets 讀取');
                    return false;
                }
            } catch (error) {
                console.warn('⚠️ 從 Google Sheets 讀取引薦資料時發生錯誤:', error);
                return false;
            }
        }
        
        // 處理引薦資料（只使用 Google Sheets 的資料，不與本地資料合併）
        function processReferralData(result) {
            if (result.success && result.data && result.data.length > 0) {
                console.log(`✅ 成功從 Google Sheets 讀取 ${result.data.length} 筆引薦資料`);
                
                // 清空現有資料
                Object.keys(referralData).forEach(key => {
                    delete referralData[key];
                });
                
                // 使用 Google Sheets 的資料完全替換（不與本地資料合併）
                result.data.forEach(referral => {
                    const serviceItem = referral.serviceItem;
                    
                    if (serviceItem) {
                        // 準備引薦資料格式（確保 phone 和 lineId 是字串）
                        const referralInfo = {
                            referrerCode: referral.referrerCode || '',
                            companyName: referral.companyName || '',
                            phone: String(referral.phone || ''),
                            lineId: String(referral.lineId || ''),
                            area: referral.area || '',
                            note: referral.note || '',
                            referralDate: referral.referralDate || ''
                        };
                        
                        // 如果該服務項目還沒有資料，初始化為陣列
                        if (!referralData[serviceItem]) {
                            referralData[serviceItem] = [];
                        }
                        
                        // 檢查是否已存在相同的引薦（避免重複）
                        const exists = referralData[serviceItem].some(
                            r => r.referrerCode === referral.referrerCode && 
                                 r.phone === referral.phone
                        );
                        
                        if (!exists) {
                            referralData[serviceItem].push(referralInfo);
                        }
                    }
                });
                
                // 保存 Google Sheets 的資料到本地存儲（作為緩存）
                localStorage.setItem('referralData', JSON.stringify(referralData));
                console.log('✅ 引薦資料已從 Google Sheets 載入並保存到本地存儲');
                
                return true;
            } else {
                console.log('ℹ️ Google Sheets 中暫無引薦資料');
                return false;
            }
        }
        
        // 嘗試使用 JSONP 方式
        function tryJsonpMethod(url) {
            return new Promise((resolve) => {
                try {
                    const callbackName = 'loadReferralsCallback_' + Date.now();
                    const jsonpUrl = `${url}&callback=${callbackName}`;
                    
                    // 創建回調函數
                    window[callbackName] = function(result) {
                        try {
                            // 清理回調函數
                            delete window[callbackName];
                            
                            // 移除 script 標籤
                            const script = document.getElementById('referralsJsonp');
                            if (script) {
                                document.body.removeChild(script);
                            }
                            
                            resolve(processReferralData(result));
                        } catch (error) {
                            console.warn('⚠️ 處理引薦資料時發生錯誤:', error);
                            resolve(false);
                        }
                    };
                    
                    // 創建 script 標籤進行 JSONP 請求
                    const script = document.createElement('script');
                    script.id = 'referralsJsonp';
                    script.src = jsonpUrl;
                    script.onerror = function() {
                        console.warn('⚠️ JSONP 請求失敗');
                        delete window[callbackName];
                        const script = document.getElementById('referralsJsonp');
                        if (script) {
                            document.body.removeChild(script);
                        }
                        resolve(false);
                    };
                    
                    // 設置超時
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.warn('⚠️ JSONP 請求超時');
                            delete window[callbackName];
                            const script = document.getElementById('referralsJsonp');
                            if (script) {
                                document.body.removeChild(script);
                            }
                            resolve(false);
                        }
                    }, 10000); // 10秒超時
                    
                    document.body.appendChild(script);
                } catch (error) {
                    console.warn('⚠️ JSONP 請求設置失敗:', error);
                    resolve(false);
                }
            });
        }
        
        // 手動重新載入引薦資料
        async function refreshReferralData() {
            // 顯示載入提示
            const loadingToast = document.createElement('div');
            loadingToast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(102, 126, 234, 0.95);
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 3000;
                font-weight: 600;
            `;
            loadingToast.textContent = '🔄 正在重新載入 Google Sheets 資料...';
            document.body.appendChild(loadingToast);
            
            try {
                // 先清除現有的引薦資料（但保留已解鎖的聯絡資訊）
                Object.keys(referralData).forEach(key => {
                    delete referralData[key];
                });
                
                // 從 Google Sheets 重新載入
                const success = await loadReferralsFromSheets();
                
                // 更新提示訊息
                if (success) {
                    loadingToast.textContent = '✅ 資料載入成功！';
                    loadingToast.style.background = 'rgba(40, 167, 69, 0.95)';
                    
                    // 如果當前有顯示詳細資訊面板，重新顯示以更新資料
                    if (currentDetails) {
                        showDetails(currentDetails.item, currentDetails.category, currentDetails.subCategory);
                    }
                } else {
                    loadingToast.textContent = '⚠️ 載入失敗，將使用本地資料';
                    loadingToast.style.background = 'rgba(255, 193, 7, 0.95)';
                }
                
                // 3秒後自動關閉提示
                setTimeout(() => {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('重新載入資料失敗:', error);
                loadingToast.textContent = '❌ 載入失敗，請稍後再試';
                loadingToast.style.background = 'rgba(220, 53, 69, 0.95)';
                
                setTimeout(() => {
                    if (document.body.contains(loadingToast)) {
                        document.body.removeChild(loadingToast);
                    }
                }, 3000);
            }
        }
        
        // 載入已解鎖的聯絡資訊
        function loadUnlockedContacts() {
            const accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
            if (accessLogs.length > 0) {
                // 延遲執行，確保DOM已經載入
                setTimeout(() => {
                    accessLogs.forEach(log => {
                        updateContactDisplay(log.accessType, log.contactValue, log.serviceItem, log.referrerCode);
                    });
                }, 1000);
            }
        }

        function createMindmap() {
            const container = document.getElementById('mindmapContent');
            
            // 創建簡潔的卡片佈局
            createCardLayout(container);
        }

        function createCardLayout(container) {
            // 創建簡潔的卡片佈局
            const cardsContainer = document.createElement('div');
            cardsContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 12px;
                padding: 15px;
                max-width: 1200px;
                margin: 0 auto;
                width: 100%;
            `;
            
            const categories = Object.keys(mindmapData["2025年 華地產鑽石分會引薦平台"]);
            
            // 優化：使用文檔片段批量添加DOM以提高性能
            const fragment = document.createDocumentFragment();
            
            categories.forEach(category => {
                const card = createCategoryCard(category);
                fragment.appendChild(card);
            });
            
            cardsContainer.appendChild(fragment);
            container.appendChild(cardsContainer);
        }
        
        function createCategoryCard(category) {
            // 檢測是否為手機版
            const isMobile = window.innerWidth <= 768;
            
            const card = document.createElement('div');
            card.style.cssText = `
                background: white;
                border-radius: 10px;
                padding: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                border: 1px solid #e9ecef;
                transition: all 0.3s ease;
                cursor: pointer;
            `;
            
            // 卡片標題
            const title = document.createElement('h3');
            title.style.cssText = `
                margin: 0 0 10px 0;
                font-size: 15px;
                color: #333;
                text-align: center;
                padding: 8px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-radius: 6px;
                font-weight: 600;
                position: relative;
                cursor: ${(displayMode === 'compact' || isMobile) ? 'pointer' : 'default'};
            `;
            
            // 標題文字容器
            const titleText = document.createElement('span');
            titleText.textContent = category;
            title.appendChild(titleText);
            
            // 添加展開/收合箭頭（簡潔模式或手機版）
            if (displayMode === 'compact' || isMobile) {
                const expandIcon = document.createElement('span');
                expandIcon.className = 'category-expand-icon';
                expandIcon.style.cssText = `
                    position: absolute;
                    right: 15px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 14px;
                    transition: transform 0.3s ease;
                `;
                expandIcon.textContent = '▼';
                title.appendChild(expandIcon);
            }
            
            // 子分類列表
            const subCategories = mindmapData["2025年 華地產鑽石分會引薦平台"][category];
            const subList = document.createElement('div');
            subList.className = 'category-sub-list';
            
            // 根據顯示模式決定是否顯示子分類
            const shouldShowSubList = displayMode === 'full' && !isMobile;
            
            subList.style.cssText = `
                display: ${shouldShowSubList ? 'flex' : 'none'};
                flex-direction: column;
                gap: 6px;
                transition: all 0.3s ease;
                overflow: hidden;
            `;
            
            // 簡潔模式或手機版：標題點擊時收合/展開
            if (displayMode === 'compact' || isMobile) {
                title.onclick = (e) => {
                    e.stopPropagation();
                    const isCollapsed = subList.style.display === 'none';
                    const icon = title.querySelector('.category-expand-icon');
                    
                    if (isCollapsed) {
                        subList.style.display = 'flex';
                        if (icon) icon.style.transform = 'translateY(-50%) rotate(180deg)';
                        card.style.paddingBottom = '12px';
                    } else {
                        subList.style.display = 'none';
                        if (icon) icon.style.transform = 'translateY(-50%) rotate(0deg)';
                    }
                };
            }
            
            Object.keys(subCategories).forEach(subCategory => {
                // 檢查子分類下是否有引薦人
                const items = subCategories[subCategory];
                
                // 如果 items 不是數組（可能是嵌套對象），則跳過這個子分類
                if (!Array.isArray(items)) {
                    return;
                }
                
                const hasAnyReferral = items.some(item => referralData[item]);
                
                // 如果只顯示有引薦人的資源，且這個子分類沒有任何引薦人，則跳過
                if (showResourcesOnly && !hasAnyReferral) {
                    return;
                }
                
                const subItem = document.createElement('div');
                subItem.style.cssText = `
                    background: #f8f9fa;
                    padding: 6px 10px;
                    border-radius: 5px;
                    font-size: 13px;
                    color: #666;
                    border-left: 3px solid #667eea;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                
                // 添加展開箭頭
                const expandArrow = document.createElement('span');
                expandArrow.style.cssText = `
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 12px;
                    color: #667eea;
                    transition: transform 0.3s ease;
                `;
                expandArrow.textContent = '▶';
                subItem.appendChild(expandArrow);
                
                subItem.textContent = subCategory;
                
                subItem.addEventListener('mouseenter', () => {
                    subItem.style.background = '#e9ecef';
                    subItem.style.color = '#333';
                });
                
                subItem.addEventListener('mouseleave', () => {
                    subItem.style.background = '#f8f9fa';
                    subItem.style.color = '#666';
                });
                
                subItem.onclick = (e) => {
                    e.stopPropagation();
                    toggleSubItems(subItem, category, subCategory, subCategories[subCategory]);
                };
                
                subList.appendChild(subItem);
            });
            
            // 懸停效果
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-3px)';
                card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.12)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = '0 4px 15px rgba(0,0,0,0.08)';
            });
            
            card.appendChild(title);
            card.appendChild(subList);
            
            return card;
        }
        
        function toggleSubItems(subItem, category, subCategory, items) {
            // 檢查參數是否有效
            if (!subItem || !subItem.parentNode) {
                console.error('toggleSubItems: subItem 或 parentNode 為 null');
                return;
            }
            
            // 檢查是否已經展開
            const existingSubItems = subItem.parentNode.querySelector('.sub-items-container');
            const expandArrow = subItem.querySelector('span');
            
            if (existingSubItems) {
                existingSubItems.remove();
                if (subItem) {
                    subItem.style.borderLeftColor = '#667eea';
                    subItem.style.background = '#f8f9fa';
                }
                if (expandArrow) {
                    expandArrow.style.transform = 'translateY(-50%) rotate(0deg)';
                }
                return;
            }
            
            // 創建細項容器
            const subItemsContainer = document.createElement('div');
            subItemsContainer.className = 'sub-items-container';
            subItemsContainer.style.cssText = `
                margin-top: 6px;
                display: flex;
                flex-direction: column;
                gap: 3px;
                position: relative;
                padding-left: 12px;
                border-left: 2px solid #667eea;
            `;
            
            // 應用合併邏輯
            const processedItems = mergeRegionalItems(items);
            
            // 創建每個細項
            processedItems.forEach(item => {
                // 檢查項目是否有引薦人
                const itemName = typeof item === 'object' ? item.name : item;
                const hasReferral = checkItemHasReferral(item, itemName);
                
                // 如果只顯示有引薦人的資源，且這個項目沒有引薦人，則跳過
                if (showResourcesOnly && !hasReferral) {
                    return;
                }
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `
                    background: white;
                    padding: 5px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    color: #555;
                    border: 1px solid #e9ecef;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    margin-left: 8px;
                    position: relative;
                `;
                
                // 處理合併的項目
                if (typeof item === 'object' && item.merged) {
                    itemDiv.textContent = `${item.name} (${item.regions.length}個區域)`;
                    itemDiv.dataset.merged = 'true';
                    itemDiv.dataset.regions = JSON.stringify(item.regions);
                    itemDiv.dataset.originalItems = JSON.stringify(item.originalItems);
                } else {
                    itemDiv.textContent = item;
                }
                
                // 添加引薦人指示器
                const referralIndicator = document.createElement('span');
                referralIndicator.style.cssText = `
                    position: absolute;
                    right: 8px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: ${referralData[item] ? '#28a745' : '#dc3545'};
                `;
                itemDiv.appendChild(referralIndicator);
                
                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.background = '#e9ecef';
                    itemDiv.style.borderColor = '#667eea';
                });
                
                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.background = 'white';
                    itemDiv.style.borderColor = '#e9ecef';
                });
                
                itemDiv.onclick = (e) => {
                    e.stopPropagation();
                    
                    // 如果是合併項目，顯示區域選擇對話框
                    if (itemDiv.dataset.merged === 'true') {
                        const regions = JSON.parse(itemDiv.dataset.regions);
                        const originalItems = JSON.parse(itemDiv.dataset.originalItems);
                        showMergedItemSelector(itemDiv.textContent, regions, originalItems, category, subCategory);
                    } else {
                        // 檢查是否有進一步的細分
                        const itemName = typeof item === 'object' ? item : item;
                        if (subdivisionData[itemName]) {
                            // 檢查是否按住 Shift 鍵（自動展開全部）
                            if (e.shiftKey) {
                                expandAllRelated(itemDiv, category, subCategory, itemName);
                            } else {
                                toggleSubdivision(itemDiv, category, subCategory, itemName);
                            }
                        } else {
                            showDetails(itemName, category, subCategory);
                        }
                    }
                };
                
                subItemsContainer.appendChild(itemDiv);
            });
            
            // 插入到子分類項目後面
            subItem.parentNode.insertBefore(subItemsContainer, subItem.nextSibling);
            
            // 更新子分類項目的樣式
            if (subItem) {
                subItem.style.borderLeftColor = '#28a745';
                subItem.style.background = '#e8f5e8';
            }
            if (expandArrow) {
                expandArrow.style.transform = 'translateY(-50%) rotate(90deg)';
            }
        }
        
        // 摺疊/展開全部
        function toggleCollapseAll() {
            isCollapsedAll = !isCollapsedAll;
            const collapseBtn = document.getElementById('collapseAllBtn');
            
            // 更新按鈕文字
            if (collapseBtn) {
                collapseBtn.textContent = isCollapsedAll ? '📂 展開全部' : '📋 摺疊全部';
            }
            
            // 獲取所有子分類列表
            const subLists = document.querySelectorAll('.category-sub-list');
            subLists.forEach(subList => {
                subList.style.display = isCollapsedAll ? 'none' : 'flex';
            });
            
            // 獲取所有展開的細項容器
            const subItemsContainers = document.querySelectorAll('.sub-items-container');
            subItemsContainers.forEach(container => {
                container.remove();
            });
            
            // 重置所有子分類項目的樣式
            const subItems = document.querySelectorAll('.category-sub-list > div');
            subItems.forEach(subItem => {
                subItem.style.borderLeftColor = '#667eea';
                subItem.style.background = '#f8f9fa';
                const arrow = subItem.querySelector('span');
                if (arrow) {
                    arrow.style.transform = 'translateY(-50%) rotate(0deg)';
                }
            });
            
            // 如果是手機版，也要更新卡片標題
            const categoryExpandIcons = document.querySelectorAll('.category-expand-icon');
            categoryExpandIcons.forEach(icon => {
                icon.style.transform = isCollapsedAll ? 'translateY(-50%) rotate(0deg)' : 'translateY(-50%) rotate(180deg)';
            });
        }
        
        // 切換顯示模式（簡潔/完整）
        function toggleDisplayMode() {
            displayMode = displayMode === 'compact' ? 'full' : 'compact';
            const modeBtn = document.getElementById('displayModeBtn');
            
            // 更新按鈕文字
            if (modeBtn) {
                modeBtn.textContent = displayMode === 'compact' ? '📄 簡潔模式' : '📋 完整模式';
            }
            
            // 重新渲染心智圖
            const container = document.getElementById('mindmapContent');
            container.innerHTML = '';
            createCardLayout(container);
            
            // 保存用戶偏好
            localStorage.setItem('displayMode', displayMode);
        }
        
        // 切換合併區域項目
        function toggleMergeRegions() {
            mergeRegions = !mergeRegions;
            const mergeBtn = document.getElementById('mergeRegionsBtn');
            
            // 更新按鈕文字
            if (mergeBtn) {
                mergeBtn.textContent = mergeRegions ? '🔗 已合併' : '📋 分開顯示';
            }
            
            // 重新渲染心智圖
            const container = document.getElementById('mindmapContent');
            container.innerHTML = '';
            createCardLayout(container);
            
            // 保存用戶偏好
            localStorage.setItem('mergeRegions', mergeRegions);
        }
        
        // 切換只顯示有引薦人的資源
        function toggleShowResourcesOnly() {
            showResourcesOnly = !showResourcesOnly;
            
            // 更新按鈕狀態
            updateButtonsState();
            
            // 重新渲染心智圖
            const container = document.getElementById('mindmapContent');
            container.innerHTML = '';
            createCardLayout(container);
            
            // 保存用戶偏好
            localStorage.setItem('showResourcesOnly', showResourcesOnly);
        }
        
        // 顯示合併項目的區域選擇器
        function showMergedItemSelector(itemName, regions, originalItems, category, subCategory) {
            // 創建對話框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 3000;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333; font-size: 18px;">${itemName}</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                </div>
                <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    請選擇您需要的服務區域：
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${regions.map((region, index) => `
                        <div class="region-option" 
                             onclick="selectRegion('${region}', '${originalItems[index]}', '${category}', '${subCategory}')"
                             style="padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;"
                             onmouseenter="this.style.background='#e3e8ff'; this.style.borderColor='#667eea';"
                             onmouseleave="this.style.background='#f8f9fa'; this.style.borderColor='transparent';">
                            <div style="font-weight: 600; color: #333;">${region}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(dialog);
        }
        
        // 選擇區域
        function selectRegion(region, originalItem, category, subCategory) {
            // 移除對話框
            const dialog = document.querySelector('div[style*="z-index: 3000"]');
            if (dialog) dialog.remove();
            
            // 顯示該區域的詳細資訊
            showDetails(originalItem, category, subCategory);
        }
        
        // 檢查項目是否有引薦人
        function checkItemHasReferral(item, itemName) {
            // 如果是合併項目，檢查所有原始項目
            if (typeof item === 'object' && item.merged) {
                return item.originalItems.some(originalItem => referralData[originalItem]);
            }
            
            // 單個項目直接檢查
            return !!referralData[itemName];
        }
        
        // 合併區域項目
        function mergeRegionalItems(items) {
            if (!mergeRegions) return items;
            
            const mergedItems = [];
            const regionGroups = {};
            
            items.forEach(item => {
                // 檢查是否為區域項目（包含 -台北市、-北部、-高雄 等後綴）
                const regionMatch = item.match(/^(.+?)-(.+)$/);
                
                if (regionMatch) {
                    const baseName = regionMatch[1].trim();
                    const region = regionMatch[2].trim();
                    
                    if (!regionGroups[baseName]) {
                        regionGroups[baseName] = [];
                    }
                    regionGroups[baseName].push({ item, region });
                } else {
                    // 非區域項目直接添加
                    mergedItems.push(item);
                }
            });
            
            // 合併區域項目
            Object.keys(regionGroups).forEach(baseName => {
                const regions = regionGroups[baseName];
                if (regions.length > 1) {
                    // 有多個區域，合併成一個項目
                    mergedItems.push({
                        name: baseName,
                        merged: true,
                        regions: regions.map(r => r.region),
                        originalItems: regions.map(r => r.item)
                    });
                } else {
                    // 只有一個區域，保持原樣
                    mergedItems.push(regions[0].item);
                }
            });
            
            return mergedItems;
        }
        
        function showItemDetails(category, subCategory, item) {
            // 顯示項目詳細資訊
            const detailsPanel = document.getElementById('detailsPanel');
            const detailsTitle = document.getElementById('detailsTitle');
            const detailsContent = document.getElementById('detailsContent');
            
            detailsTitle.textContent = `${item}`;
            detailsContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>主分類：</strong>${category}<br>
                    <strong>子分類：</strong>${subCategory}<br>
                    <strong>服務項目：</strong>${item}
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <strong>服務說明：</strong><br>
                    這裡可以添加 ${item} 的詳細服務說明、價格、時程等相關資訊。
                </div>
            `;
            
            // 顯示引薦人資訊
            const referral = referralData[item];
            if (referral) {
                // 格式化電話號碼（不足10碼前面補0）
                const formattedPhone = formatPhoneNumber(referral.phone);
                document.getElementById('referralInfo').innerHTML = `
                    <strong>姓名：</strong>${referral.name}<br>
                    <strong>公司：</strong>${referral.company}<br>
                    <strong>電話：</strong>${formattedPhone}<br>
                    <strong>Email：</strong>${referral.email}<br>
                    <strong>經驗：</strong>${referral.experience}
                `;
            } else {
                document.getElementById('referralInfo').innerHTML = '暫無引薦人資訊，點擊下方按鈕添加。';
            }
            
            detailsPanel.classList.add('active');
        }
        
        function toggleSubdivision(itemDiv, category, subCategory, item) {
            // 檢查這個特定 item 是否已經展開細分
            // 只查找緊跟在這個 itemDiv 後面的 subdivision-container
            let nextSibling = itemDiv.nextSibling;
            while (nextSibling) {
                if (nextSibling.classList && nextSibling.classList.contains('subdivision-container')) {
                    nextSibling.remove();
                    return;
                }
                nextSibling = nextSibling.nextSibling;
            }
            
            // 創建細分容器
            const subdivisionContainer = document.createElement('div');
            subdivisionContainer.className = 'subdivision-container';
            subdivisionContainer.style.cssText = `
                margin-top: 6px;
                display: flex;
                flex-direction: column;
                gap: 3px;
                margin-left: 15px;
                position: relative;
                padding-left: 12px;
                border-left: 2px solid #007bff;
            `;
            
            const subdivisions = subdivisionData[item];
            
            Object.keys(subdivisions).forEach(subdivisionName => {
                const subdivisionDiv = document.createElement('div');
                subdivisionDiv.style.cssText = `
                    background: #f0f8ff;
                    padding: 5px 8px;
                    border-radius: 3px;
                    font-size: 11px;
                    color: #444;
                    border: 1px solid #d0e7ff;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                
                subdivisionDiv.textContent = subdivisionName;
                
                // 添加細分指示器
                const subdivisionIndicator = document.createElement('span');
                subdivisionIndicator.style.cssText = `
                    position: absolute;
                    right: 6px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 10px;
                    color: #007bff;
                `;
                subdivisionIndicator.textContent = '▶';
                subdivisionDiv.appendChild(subdivisionIndicator);
                
                subdivisionDiv.addEventListener('mouseenter', () => {
                    subdivisionDiv.style.background = '#e6f3ff';
                    subdivisionDiv.style.borderColor = '#007bff';
                });
                
                subdivisionDiv.addEventListener('mouseleave', () => {
                    subdivisionDiv.style.background = '#f0f8ff';
                    subdivisionDiv.style.borderColor = '#d0e7ff';
                });
                
                subdivisionDiv.onclick = (e) => {
                    e.stopPropagation();
                    // 檢查是否按住 Shift 鍵（自動展開全部）
                    if (e.shiftKey) {
                        expandAllFinalItems(subdivisionDiv, category, subCategory, item, subdivisionName, subdivisions[subdivisionName]);
                    } else {
                        toggleFinalItems(subdivisionDiv, category, subCategory, item, subdivisionName, subdivisions[subdivisionName]);
                    }
                };
                
                subdivisionContainer.appendChild(subdivisionDiv);
            });
            
            // 插入到項目後面
            itemDiv.parentNode.insertBefore(subdivisionContainer, itemDiv.nextSibling);
        }
        
        // 自動展開所有相關項目（心智圖模式）
        function expandAllRelated(itemDiv, category, subCategory, item) {
            // 先展開細分
            let existingSubdivision = null;
            let nextSibling = itemDiv.nextSibling;
            while (nextSibling) {
                if (nextSibling.classList && nextSibling.classList.contains('subdivision-container')) {
                    existingSubdivision = nextSibling;
                    break;
                }
                nextSibling = nextSibling.nextSibling;
            }
            
            if (!existingSubdivision) {
                toggleSubdivision(itemDiv, category, subCategory, item);
            }
            
            // 等待DOM更新後，自動展開所有細分項目
            setTimeout(() => {
                const subdivisionContainer = itemDiv.nextSibling;
                if (subdivisionContainer && subdivisionContainer.classList.contains('subdivision-container')) {
                    const subdivisionDivs = subdivisionContainer.querySelectorAll('div');
                    subdivisionDivs.forEach(subdivisionDiv => {
                        subdivisionDiv.click();
                    });
                }
            }, 100);
        }
        
        // 自動展開所有最終項目
        function expandAllFinalItems(subdivisionDiv, category, subCategory, item, subdivisionName, finalItems) {
            // 先展開最終項目
            let existingFinalItems = null;
            let nextSibling = subdivisionDiv.nextSibling;
            while (nextSibling) {
                if (nextSibling.classList && nextSibling.classList.contains('final-items-container')) {
                    existingFinalItems = nextSibling;
                    break;
                }
                nextSibling = nextSibling.nextSibling;
            }
            
            if (!existingFinalItems) {
                toggleFinalItems(subdivisionDiv, category, subCategory, item, subdivisionName, finalItems);
            }
        }
        
        function toggleFinalItems(subdivisionDiv, category, subCategory, item, subdivisionName, finalItems) {
            // 檢查這個特定 subdivision 是否已經展開最終項目
            // 只查找緊跟在這個 subdivisionDiv 後面的 final-items-container
            let nextSibling = subdivisionDiv.nextSibling;
            while (nextSibling) {
                if (nextSibling.classList && nextSibling.classList.contains('final-items-container')) {
                    nextSibling.remove();
                    return;
                }
                nextSibling = nextSibling.nextSibling;
            }
            
            // 創建最終項目容器
            const finalItemsContainer = document.createElement('div');
            finalItemsContainer.className = 'final-items-container';
            finalItemsContainer.style.cssText = `
                margin-top: 4px;
                display: flex;
                flex-direction: column;
                gap: 2px;
                margin-left: 10px;
                position: relative;
                padding-left: 10px;
                border-left: 2px solid #28a745;
            `;
            
            finalItems.forEach(finalItem => {
                const finalItemDiv = document.createElement('div');
                finalItemDiv.style.cssText = `
                    background: white;
                    padding: 4px 6px;
                    border-radius: 2px;
                    font-size: 10px;
                    color: #666;
                    border: 1px solid #e9ecef;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                
                finalItemDiv.textContent = finalItem;
                
                // 添加最終項目指示器
                const finalIndicator = document.createElement('span');
                finalIndicator.style.cssText = `
                    position: absolute;
                    right: 5px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 6px;
                    height: 6px;
                    border-radius: 50%;
                    background: ${referralData[finalItem] ? '#28a745' : '#dc3545'};
                `;
                finalItemDiv.appendChild(finalIndicator);
                
                finalItemDiv.addEventListener('mouseenter', () => {
                    finalItemDiv.style.background = '#f8f9fa';
                    finalItemDiv.style.borderColor = '#007bff';
                });
                
                finalItemDiv.addEventListener('mouseleave', () => {
                    finalItemDiv.style.background = 'white';
                    finalItemDiv.style.borderColor = '#e9ecef';
                });
                
                finalItemDiv.onclick = (e) => {
                    e.stopPropagation();
                    showDetails(finalItem, category, subCategory);
                };
                
                finalItemsContainer.appendChild(finalItemDiv);
            });
            
            // 插入到細分項目後面
            subdivisionDiv.parentNode.insertBefore(finalItemsContainer, subdivisionDiv.nextSibling);
        }
        
        function showFinalItemDetails(category, subCategory, item, subdivisionName, finalItem) {
            // 直接調用 showDetails 函數，確保一致性
            showDetails(finalItem, category, subCategory);
        }
        
        function createBranchNode(category, x, y, angle) {
            const branchContainer = document.createElement('div');
            branchContainer.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(${x}px, ${y}px);
                z-index: 50;
            `;
            
            // 主分類節點
            const mainNode = document.createElement('div');
            mainNode.style.cssText = `
                background: white;
                border: 3px solid #667eea;
                border-radius: 20px;
                padding: 15px 20px;
                font-size: 14px;
                font-weight: bold;
                color: #333;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 6px 20px rgba(0,0,0,0.1);
                text-align: center;
                min-width: 150px;
                position: relative;
            `;
            mainNode.textContent = category;
            
            // 添加人員頭像群組
            const avatarGroup = document.createElement('div');
            avatarGroup.style.cssText = `
                display: flex;
                justify-content: center;
                gap: 3px;
                margin-top: 8px;
            `;
            
            // 根據分類創建不同數量的頭像
            const avatarCount = getAvatarCount(category);
            for (let i = 0; i < avatarCount; i++) {
                const avatar = document.createElement('div');
                avatar.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border: 2px solid white;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                `;
                avatarGroup.appendChild(avatar);
            }
            
            mainNode.appendChild(avatarGroup);
            
            // 懸停效果
            mainNode.addEventListener('mouseenter', () => {
                mainNode.style.transform = 'scale(1.1)';
                mainNode.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            mainNode.addEventListener('mouseleave', () => {
                mainNode.style.transform = 'scale(1)';
                mainNode.style.boxShadow = '0 6px 20px rgba(0,0,0,0.1)';
            });
            
            // 點擊展開子分類
            mainNode.onclick = () => {
                showSubCategories(branchContainer, category);
            };
            
            branchContainer.appendChild(mainNode);
            
            // 連接線
            const connectionLine = document.createElement('div');
            connectionLine.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                width: ${Math.sqrt(x*x + y*y)}px;
                height: 2px;
                background: linear-gradient(90deg, #667eea, rgba(102, 126, 234, 0.3));
                transform-origin: left center;
                transform: translate(-100%, -50%) rotate(${angle * 180 / Math.PI}deg);
                z-index: 10;
            `;
            
            branchContainer.appendChild(connectionLine);
            
            return branchContainer;
        }
        
        function getAvatarCount(category) {
            // 根據分類返回不同的頭像數量
            const counts = {
                "🔺 上游｜供應端與原材料": 8,
                "🏗️ 中游前段｜研發設計與工程": 6,
                "💾 資料與科技（PropTech）": 4,
                "👥 人才與教育訓練": 5,
                "🏦 中游核心｜資金與風險": 7,
                "🏭 中游後段｜製造／施工／交付": 6,
                "📣 下游成交｜行銷／渠道／交易": 9,
                "🧰 下游長尾｜營運／維運／售後": 8,
                "🌐 外部生態與治理": 5,
                "🧭 需求端（誰用與在哪裡用）": 7,
                "⚙️ 其他產業鏈夥伴與外部資源": 4
            };
            return counts[category] || 5;
        }
        
        function showSubCategories(branchContainer, category) {
            // 移除現有的子分類
            const existingSub = branchContainer.querySelector('.sub-categories');
            if (existingSub) {
                existingSub.remove();
                return;
            }
            
            // 創建子分類容器
            const subContainer = document.createElement('div');
            subContainer.className = 'sub-categories';
            subContainer.style.cssText = `
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
                z-index: 60;
            `;
            
            // 手機版兩欄佈局
            if (window.innerWidth <= 768) {
                subContainer.style.cssText += `
                    flex-direction: row !important;
                    flex-wrap: wrap !important;
                    width: 90vw !important;
                    max-width: 500px !important;
                    gap: 6px !important;
                `;
            }
            
            const subCategories = mindmapData["2025年 華地產鑽石分會引薦平台"][category];
            Object.keys(subCategories).forEach(subCategory => {
                const subNode = document.createElement('div');
                let nodeStyle = `
                    background: white;
                    border: 2px solid #667eea;
                    border-radius: 15px;
                    padding: 10px 15px;
                    font-size: 12px;
                    color: #333;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    text-align: center;
                    min-width: 120px;
                `;
                
                // 手機版調整為可並排的寬度
                if (window.innerWidth <= 768) {
                    nodeStyle += `
                        flex: 0 0 calc(50% - 3px) !important;
                        min-width: 0 !important;
                        max-width: calc(50% - 3px) !important;
                    `;
                }
                
                subNode.style.cssText = nodeStyle;
                subNode.textContent = subCategory;
                
                // 添加項目數量指示
                const itemCount = subCategories[subCategory].length;
                const countBadge = document.createElement('div');
                countBadge.style.cssText = `
                    background: #667eea;
                    color: white;
                    border-radius: 10px;
                    padding: 2px 6px;
                    font-size: 10px;
                    margin-top: 5px;
                `;
                countBadge.textContent = `${itemCount} 項目`;
                subNode.appendChild(countBadge);
                
                subNode.onclick = (e) => {
                    e.stopPropagation();
                    showDetails(subCategory, category, subCategories[subCategory]);
                };
                
                subContainer.appendChild(subNode);
            });
            
            branchContainer.appendChild(subContainer);
        }
        
        function createCategoryNode(category) {
            const categoryDiv = document.createElement('div');
            categoryDiv.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.1);
                border: 2px solid #e9ecef;
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
            `;
            
            // 分類標題
            const categoryTitle = document.createElement('div');
            categoryTitle.style.cssText = `
                font-size: 16px;
                font-weight: bold;
                color: #333;
                margin-bottom: 15px;
                text-align: center;
                padding: 10px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-radius: 10px;
                position: relative;
            `;
            categoryTitle.textContent = category;
            
            // 添加展開箭頭
            const arrow = document.createElement('span');
            arrow.style.cssText = `
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 14px;
                transition: transform 0.3s ease;
            `;
            arrow.textContent = '▼';
            categoryTitle.appendChild(arrow);
            
            // 子分類容器
            const subCategoriesContainer = document.createElement('div');
            subCategoriesContainer.className = 'sub-categories';
            subCategoriesContainer.style.cssText = `
                display: none;
                flex-direction: column;
                gap: 12px;
                margin-top: 15px;
            `;
            
            const subCategories = mindmapData["2025年 華地產鑽石分會引薦平台"][category];
            
            Object.keys(subCategories).forEach(subCategory => {
                const subCategoryDiv = document.createElement('div');
                subCategoryDiv.style.cssText = `
                    background: #f8f9fa;
                    border-radius: 6px;
                    padding: 8px;
                    border-left: 3px solid #667eea;
                `;
                
                const subCategoryTitle = document.createElement('div');
                subCategoryTitle.style.cssText = `
                    font-weight: 600;
                    color: #667eea;
                    margin-bottom: 6px;
                    font-size: 13px;
                `;
                subCategoryTitle.textContent = subCategory;
                
                const itemsContainer = document.createElement('div');
                itemsContainer.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    gap: 4px;
                `;
                
                subCategories[subCategory].forEach(item => {
                    const itemSpan = document.createElement('span');
                    itemSpan.style.cssText = `
                        background: white;
                        color: #666;
                        padding: 2px 6px;
                        border-radius: 8px;
                        font-size: 11px;
                        border: 1px solid #e9ecef;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: inline-block;
                    `;
                    itemSpan.textContent = item;
                    itemSpan.title = item;
                    
                    itemSpan.addEventListener('mouseenter', () => {
                        itemSpan.style.background = '#667eea';
                        itemSpan.style.color = 'white';
                        itemSpan.style.transform = 'scale(1.05)';
                    });
                    
                    itemSpan.addEventListener('mouseleave', () => {
                        itemSpan.style.background = 'white';
                        itemSpan.style.color = '#666';
                        itemSpan.style.transform = 'scale(1)';
                    });
                    
                    itemSpan.onclick = (e) => {
                        e.stopPropagation();
                        showDetails(item, category, subCategory);
                    };
                    
                    itemsContainer.appendChild(itemSpan);
                });
                
                subCategoryDiv.appendChild(subCategoryTitle);
                subCategoryDiv.appendChild(itemsContainer);
                subCategoriesContainer.appendChild(subCategoryDiv);
            });
            
            // 點擊展開/收起
            categoryDiv.onclick = () => {
                const isVisible = subCategoriesContainer.style.display !== 'none';
                subCategoriesContainer.style.display = isVisible ? 'none' : 'flex';
                
                // 旋轉箭頭
                arrow.style.transform = isVisible ? 'translateY(-50%) rotate(0deg)' : 'translateY(-50%) rotate(180deg)';
                
                // 更新卡片樣式
                if (!isVisible) {
                    categoryDiv.style.background = 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
                    categoryDiv.style.transform = 'scale(1.02)';
                } else {
                    categoryDiv.style.background = 'white';
                    categoryDiv.style.transform = 'scale(1)';
                }
            };
            
            // 懸停效果
            categoryDiv.addEventListener('mouseenter', () => {
                categoryDiv.style.transform = 'translateY(-3px)';
                categoryDiv.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)';
            });
            
            categoryDiv.addEventListener('mouseleave', () => {
                if (subCategoriesContainer.style.display === 'none') {
                    categoryDiv.style.transform = 'translateY(0)';
                }
                categoryDiv.style.boxShadow = '0 6px 20px rgba(0,0,0,0.1)';
            });
            
            categoryDiv.appendChild(categoryTitle);
            categoryDiv.appendChild(subCategoriesContainer);
            
            return categoryDiv;
        }

        function setupEventListeners() {
            // 初始化增強搜索功能
            initEnhancedSearch();
            
            // 搜尋功能
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // 點擊其他地方關閉搜尋結果
            document.addEventListener('click', function(e) {
                const searchInput = document.getElementById('searchInput');
                const searchResults = document.getElementById('searchResults');
                if (searchResults && e.target !== searchInput && !searchResults.contains(e.target)) {
                    closeSearchResults();
                }
            });
            
            // 拖拽功能
            const container = document.getElementById('mindmapContainer');
            const content = document.getElementById('mindmapContent');
            
            container.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            
            // 縮放功能
            container.addEventListener('wheel', handleZoom);
            
            // 鍵盤快捷鍵
            document.addEventListener('keydown', handleKeydown);
            
            // 中心節點點擊
            document.getElementById('centerNode').onclick = expandMindmap;
            
            // 滾動事件監聽器 - 顯示/隱藏回到頂部按鈕
            const mindmapContainer = document.getElementById('mindmapContainer');
            const scrollToTopBtn = document.getElementById('scrollToTop');
            
            mindmapContainer.addEventListener('scroll', function() {
                if (mindmapContainer.scrollTop > 200) {
                    scrollToTopBtn.classList.add('active');
                } else {
                    scrollToTopBtn.classList.remove('active');
                }
            });
        }

        function expandMindmap() {
            // 示意函數，卡片佈局不需要展開/收起
            console.log('卡片佈局已顯示');
        }

        function collapseMindmap() {
            // 示意函數，卡片佈局不需要展開/收起
            console.log('卡片佈局已顯示');
        }

        // 回到頂部功能
        function scrollToTop() {
            const mindmapContainer = document.getElementById('mindmapContainer');
            mindmapContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleSubBranches(parentBranch, category) {
            const existingSubBranches = parentBranch.querySelectorAll('.sub-branch');
            const branchNode = parentBranch.querySelector('.branch-node');
            
            if (existingSubBranches.length > 0) {
                existingSubBranches.forEach(subBranch => {
                    subBranch.classList.toggle('active');
                });
                branchNode.classList.toggle('expanded');
            } else {
                const subCategories = mindmapData["2025年 華地產鑽石分會引薦平台"][category];
                const subRadius = 160;
                
                const subCategoryKeys = Object.keys(subCategories);
                subCategoryKeys.forEach((subCategory, index) => {
                    // 優化子分支角度分佈，讓它們更均勻地圍繞主節點
                    const subAngle = (index * 360 / subCategoryKeys.length - 90) * Math.PI / 180;
                    const subX = Math.cos(subAngle) * subRadius;
                    const subY = Math.sin(subAngle) * subRadius;
                    
                    const subBranch = document.createElement('div');
                    subBranch.className = 'sub-branch active fade-in-up';
                    subBranch.style.left = `${subX}px`;
                    subBranch.style.top = `${subY}px`;
                    
                    // 創建子分類標題
                    const subCategoryTitle = document.createElement('div');
                    subCategoryTitle.className = 'sub-node';
                    subCategoryTitle.style.background = '#667eea';
                    subCategoryTitle.style.color = 'white';
                    subCategoryTitle.style.fontWeight = 'bold';
                    subCategoryTitle.style.fontSize = '12px';
                    subCategoryTitle.style.marginBottom = '8px';
                    subCategoryTitle.style.minWidth = '120px';
                    subCategoryTitle.textContent = subCategory;
                    subBranch.appendChild(subCategoryTitle);
                    
                    // 創建具體項目 - 限制顯示數量避免重疊
                    const items = subCategories[subCategory];
                    const maxItems = 6; // 最多顯示6個項目
                    const itemsToShow = items.slice(0, maxItems);
                    
                    itemsToShow.forEach(item => {
                        const subNode = document.createElement('div');
                        subNode.className = 'sub-node has-details';
                        subNode.textContent = item.length > 12 ? item.substring(0, 12) + '...' : item;
                        subNode.title = item; // 完整文字顯示在tooltip中
                        subNode.onclick = (e) => {
                            e.stopPropagation();
                            showDetails(item, category, subCategory);
                        };
                        
                        subBranch.appendChild(subNode);
                    });
                    
                    // 如果項目太多，顯示省略號
                    if (items.length > maxItems) {
                        const moreNode = document.createElement('div');
                        moreNode.className = 'sub-node';
                        moreNode.style.background = '#ffc107';
                        moreNode.style.color = '#333';
                        moreNode.style.fontSize = '10px';
                        moreNode.textContent = `+${items.length - maxItems} 更多`;
                        subBranch.appendChild(moreNode);
                    }
                    
                    parentBranch.appendChild(subBranch);
                });
                
                branchNode.classList.add('expanded');
            }
        }

        async function showDetails(item, category, subCategory) {
            currentDetails = { item, category, subCategory };
            
            document.getElementById('detailsTitle').textContent = item;
            document.getElementById('detailsContent').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>分類：</strong>${category}<br>
                    <strong>子分類：</strong>${subCategory}<br>
                    <strong>項目：</strong>${item}
                </div>
            `;
            
            // 顯示引薦人資訊
            const referral = referralData[item];
            if (referral) {
            // 檢查是否為陣列（多個引薦人）
            let referrals = [];
            if (Array.isArray(referral)) {
                referrals = referral;
            } else {
                referrals = [referral];
            }
                
                // 加載會員資料以進行排序
                const memberData = await loadMemberData();
                
                // 排序引薦人列表
                referrals.sort((a, b) => {
                    const codeA = (a.referrerCode || '').trim();
                    const codeB = (b.referrerCode || '').trim();
                    
                    // 提取數字部分用於排序
                    const numA = parseInt(codeA.replace(/[^0-9]/g, '')) || 9999;
                    const numB = parseInt(codeB.replace(/[^0-9]/g, '')) || 9999;
                    
                    // 提取純數字編號用於檢查會員資格
                    const cleanCodeA = codeA.replace(/[^0-9]/g, '');
                    const cleanCodeB = codeB.replace(/[^0-9]/g, '');
                    
                    // 檢查是否為會員成員（使用純數字編號檢查）
                    const isMemberA = memberData && memberData[cleanCodeA];
                    const isMemberB = memberData && memberData[cleanCodeB];
                    
                    // 排序規則：
                    // 1. 會員成員優先（isMemberA > isMemberB）
                    // 2. 會員成員內部按編號排序（numA < numB）
                    // 3. 非會員成員排在最後
                    
                    if (isMemberA && !isMemberB) return -1;
                    if (!isMemberA && isMemberB) return 1;
                    if (isMemberA && isMemberB) return numA - numB;
                    return 0; // 兩個都不是會員成員，保持原有順序
                });
                
                // 分頁設定
                const itemsPerPage = 5; // 每頁顯示5個
                const totalPages = Math.ceil(referrals.length / itemsPerPage);
                const uniqueItemId = `referral_${item.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                let referralsHTML = '';
                referralsHTML += `<div style="margin-bottom: 12px;">
                    <h4 style="color: #4a5568; margin-bottom: 8px; font-size: 14px;">📋 引薦人列表 (${referrals.length} 位)</h4>
                </div>`;
                
                // 引薦列表容器（固定高度，可滾動）
                referralsHTML += `<div id="${uniqueItemId}_container" style="max-height: 500px; overflow-y: auto; margin-bottom: 12px; position: relative;">
                    <style>
                        #${uniqueItemId}_container::-webkit-scrollbar {
                            width: 8px;
                        }
                        #${uniqueItemId}_container::-webkit-scrollbar-track {
                            background: #f1f1f1;
                            border-radius: 10px;
                        }
                        #${uniqueItemId}_container::-webkit-scrollbar-thumb {
                            background: #667eea;
                            border-radius: 10px;
                        }
                        #${uniqueItemId}_container::-webkit-scrollbar-thumb:hover {
                            background: #5568d3;
                        }
                    </style>`;
                
                referrals.forEach((ref, index) => {
                    // 檢查是否為會員成員
                    const referrerCode = (ref.referrerCode || '').trim();
                    // 提取純數字編號用於檢查會員資格
                    const cleanCode = referrerCode.replace(/[^0-9]/g, '');
                    const isMember = memberData && memberData[cleanCode];
                    const memberInfo = isMember ? memberData[cleanCode] : null;
                    
                    // 如果是會員成員，添加標籤
                    const memberTag = isMember ? 
                        `<span style="font-size: 10px; color: #fff; background: linear-gradient(135deg, #667eea, #764ba2); padding: 2px 6px; border-radius: 10px; font-weight: 600;">👤 會員</span>` : 
                        '';
                    
                    // 調整引薦人顯示順序，會員成員在前
                    const displayIndex = index + 1;
                    const uniqueId = `${item.replace(/[^a-zA-Z0-9]/g, '_')}_${index}`;
                    referralsHTML += `
                        <div class="referral-item" style="margin-bottom: 12px;">
                            <div class="referral-summary" onclick="toggleReferralDetails('${uniqueId}')" style="cursor: pointer; padding: 10px; border: 2px solid #e3e8ff; border-radius: 10px; margin-bottom: 8px; transition: all 0.3s ease; background: linear-gradient(135deg, #f8f9ff, #ffffff);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: #667eea; color: white; padding: 3px 6px; border-radius: 50%; font-size: 11px; font-weight: bold;">${displayIndex}</span>
                                        <div>
                                            <strong style="color: #4a5568; font-size: 13px;">引薦人：</strong>
                                            <span style="color: #2d3748; font-weight: 600; font-size: 13px;">${ref.referrerCode || ref.name || '未知'}</span>
                                        </div>
                                        ${memberTag}
                                        <span style="font-size: 11px; color: #667eea; background: #e3e8ff; padding: 2px 6px; border-radius: 10px;">${ref.companyName || ref.company || '未知'}</span>
                                    </div>
                                    <span class="expand-icon" style="font-size: 14px; color: #667eea; transition: transform 0.3s ease;">▶</span>
                                </div>
                            </div>
                            
                            <div class="referral-details" id="referralDetails_${uniqueId}" style="display: none; padding: 15px; background: #f8f9ff; border-radius: 10px; margin-bottom: 10px;">
                                <div style="margin-bottom: 12px; font-size: 14px;">
                                    ${isMember && memberInfo ? `<div style="margin-bottom: 8px;">
                                        <strong style="color: #4a5568;">👤 會員姓名：</strong>
                                        <span style="color: #2d3748;">${memberInfo.name}</span>
                                    </div>` : ''}
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #4a5568;">廠商名稱：</strong>
                                        <span style="color: #2d3748;">${ref.companyName || ref.company || '未知'}</span>
                                    </div>
                                    ${ref.area ? `<div style="margin-bottom: 8px;">
                                        <strong style="color: #4a5568;">服務區域：</strong>
                                        <span style="color: #2d3748;">${ref.area}</span>
                                    </div>` : ''}
                                    ${ref.note || ref.experience ? `<div style="margin-bottom: 8px;">
                                        <strong style="color: #4a5568;">備註：</strong>
                                        <span style="color: #2d3748;">${ref.note || ref.experience}</span>
                                    </div>` : ''}
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #4a5568; font-size: 14px;">聯絡資訊：</strong>
                                    <div style="margin-top: 6px; display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 14px;">📞</span>
                                            <span class="masked-info" data-type="phone" data-value="${ref.phone}" style="font-size: 13px; color: #667eea;">${maskPhone(ref.phone)}</span>
                                        </div>
                                        ${ref.lineId ? `<div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 14px;">💬</span>
                                            <span class="masked-info" data-type="lineid" data-value="${ref.lineId}" style="font-size: 13px; color: #667eea;">${maskLineId(ref.lineId)}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                                
                                <button onclick="showAllContactDetails('${ref.phone}', '${ref.lineId || ''}', '${item}', '${ref.referrerCode || ref.name || '未知'}', ${isMember ? 'true' : 'false'}, '${cleanCode}')" 
                                        style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); transition: all 0.3s ease; width: 100%;">
                                    🔓 查看聯絡資訊
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                // 關閉容器
                referralsHTML += `</div>`;
                
                // 添加分頁按鈕（如果超過一頁）
                if (totalPages > 1) {
                    referralsHTML += `<div style="display: flex; justify-content: center; gap: 8px; margin-top: 12px;">`;
                    for (let i = 1; i <= totalPages; i++) {
                        referralsHTML += `<button id="${uniqueItemId}_page_${i}" onclick="showReferralPage('${uniqueItemId}', ${i}, ${itemsPerPage})" 
                            style="background: ${i === 1 ? '#667eea' : '#e3e8ff'}; color: ${i === 1 ? 'white' : '#667eea'}; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            ${i}
                        </button>`;
                    }
                    referralsHTML += `</div>`;
                }
                
                document.getElementById('referralInfo').innerHTML = referralsHTML;
                
                // 初始化第一頁顯示
                if (totalPages > 1) {
                    showReferralPage(uniqueItemId, 1, itemsPerPage);
                }
            } else {
                document.getElementById('referralInfo').innerHTML = '暫無引薦人資訊，點擊下方按鈕添加。';
            }
            
            // 確保添加引薦人按鈕有正確的點擊事件
            const addReferralBtn = document.querySelector('.add-referral-btn');
            if (addReferralBtn) {
                addReferralBtn.onclick = addReferral;
            }
            
            document.getElementById('detailsPanel').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('detailsPanel').classList.remove('active');
            currentDetails = null;
        }

        // 關閉使用說明框
        function closeUsageNotice() {
            const notice = document.getElementById('usageNotice');
            const mindmapContainer = document.getElementById('mindmapContainer');
            if (notice) {
                notice.classList.add('collapsed');
                // 保存關閉狀態到 localStorage
                localStorage.setItem('usageNoticeClosed', 'true');
                // 調整心智圖容器位置
                if (mindmapContainer) {
                    mindmapContainer.classList.remove('with-notice');
                }
            }
        }

        // 檢查使用說明框是否應該顯示
        function checkUsageNotice() {
            const isClosed = localStorage.getItem('usageNoticeClosed');
            const notice = document.getElementById('usageNotice');
            const mindmapContainer = document.getElementById('mindmapContainer');
            
            if (isClosed === 'true') {
                if (notice) {
                    notice.classList.add('collapsed');
                }
                if (mindmapContainer) {
                    mindmapContainer.classList.remove('with-notice');
                }
            } else {
                // 如果沒有關閉過，顯示使用說明框並調整心智圖容器
                if (mindmapContainer) {
                    mindmapContainer.classList.add('with-notice');
                }
            }
        }
        
        // 引薦人列表分頁功能
        function showReferralPage(uniqueItemId, page, itemsPerPage) {
            const container = document.getElementById(`${uniqueItemId}_container`);
            if (!container) return;
            
            const items = container.querySelectorAll('.referral-item');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            
            // 隱藏所有項目
            items.forEach((item, index) => {
                if (index >= startIndex && index < endIndex) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // 更新分頁按鈕樣式
            const totalPages = Math.ceil(items.length / itemsPerPage);
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.getElementById(`${uniqueItemId}_page_${i}`);
                if (btn) {
                    if (i === page) {
                        btn.style.background = '#667eea';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = '#e3e8ff';
                        btn.style.color = '#667eea';
                    }
                }
            }
        }

        function addReferral() {
            // 創建引薦登記表單
            showReferralForm();
        }
        
        function showReferralForm() {
            // 檢測是否為手機版
            const isMobile = window.innerWidth <= 768;
            
            // 創建表單容器
            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: ${isMobile ? 'flex-start' : 'center'};
                justify-content: center;
                z-index: 2000;
                overflow-y: auto;
                padding: ${isMobile ? '0' : '20px'};
            `;
            
            // 創建表單
            const form = document.createElement('div');
            form.style.cssText = `
                background: white;
                padding: ${isMobile ? '20px' : '30px'};
                border-radius: ${isMobile ? '0' : '15px'};
                width: ${isMobile ? '100%' : '90%'};
                max-width: 500px;
                max-height: ${isMobile ? '100vh' : '80vh'};
                overflow-y: auto;
                box-shadow: ${isMobile ? 'none' : '0 10px 30px rgba(0,0,0,0.3)'};
                margin-top: ${isMobile ? '0' : 'auto'};
            `;
            
            form.innerHTML = `
                <style>
                    @media (max-width: 768px) {
                        .referral-form-header {
                            padding-bottom: 15px;
                            border-bottom: 2px solid #e9ecef;
                            margin-bottom: 15px !important;
                        }
                        .referral-form-title {
                            font-size: 18px !important;
                        }
                        .referral-form-field {
                            margin-bottom: 12px !important;
                        }
                        .referral-form-label {
                            font-size: 14px !important;
                            margin-bottom: 6px !important;
                        }
                        .referral-form-input {
                            padding: 10px !important;
                            font-size: 14px !important;
                        }
                        .referral-form-textarea {
                            padding: 10px !important;
                            font-size: 14px !important;
                        }
                        .referral-form-buttons {
                            flex-direction: column !important;
                            gap: 10px !important;
                            margin-top: 20px !important;
                        }
                        .referral-form-button {
                            width: 100% !important;
                            padding: 12px !important;
                            font-size: 14px !important;
                        }
                    }
                </style>
                <div class="referral-form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 class="referral-form-title" style="margin: 0; color: #333; font-size: 20px;">👥 引薦登記表單</h3>
                    <button onclick="closeReferralForm()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;" onmouseenter="this.style.background='#f1f3f4'; this.style.color='#333';" onmouseleave="this.style.background='none'; this.style.color='#666';">×</button>
                </div>
                
                <form id="referralForm">
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">被引薦服務項目 *</label>
                        ${currentDetails ? 
                            `<input type="text" id="referredService" class="referral-form-input" value="${currentDetails.item}" readonly 
                                   style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; background: #f8f9fa;">` :
                            `<select id="referredService" class="referral-form-input" required 
                                    style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                                <option value="">請選擇服務項目</option>
                                <optgroup label="🔺 上游｜供應端與原材料">
                                    <option value="室內泥作">室內泥作</option>
                                    <option value="室外泥作">室外泥作</option>
                                    <option value="鋼構工程">鋼構工程</option>
                                    <option value="木作工程">木作工程</option>
                                    <option value="石材工程">石材工程</option>
                                    <option value="玻璃工程">玻璃工程</option>
                                    <option value="磁磚工程">磁磚工程</option>
                                    <option value="鋁門窗工程">鋁門窗工程</option>
                                    <option value="塗料工程">塗料工程</option>
                                </optgroup>
                                <optgroup label="🏗️ 中游前段｜研發設計與工程">
                                    <option value="建築師">建築師</option>
                                    <option value="結構技師">結構技師</option>
                                    <option value="室內設計師">室內設計師</option>
                                    <option value="景觀設計">景觀設計</option>
                                    <option value="BIM 顧問">BIM 顧問</option>
                                </optgroup>
                                <optgroup label="🏭 中游後段｜製造／施工／交付">
                                    <option value="水電安裝">水電安裝</option>
                                    <option value="機電設備">機電設備</option>
                                    <option value="消防設備">消防設備</option>
                                    <option value="監控系統">監控系統</option>
                                    <option value="電梯">電梯</option>
                                </optgroup>
                                <optgroup label="📣 下游成交｜行銷／渠道／交易">
                                    <option value="住宅仲介">住宅仲介</option>
                                    <option value="商辦仲介">商辦仲介</option>
                                    <option value="工業廠房">工業廠房</option>
                                    <option value="地政代書">地政代書</option>
                                </optgroup>
                                <optgroup label="🧰 下游長尾｜營運／維運／售後">
                                    <option value="物業管理">物業管理</option>
                                    <option value="保全">保全</option>
                                    <option value="清潔服務">清潔服務</option>
                                    <option value="水電維修">水電維修</option>
                                    <option value="搬家服務">搬家服務</option>
                                </optgroup>
                                <optgroup label="💾 科技與數位服務">
                                    <option value="智慧家電">智慧家電</option>
                                    <option value="BIM 建模">BIM 建模</option>
                                    <option value="物業管理系統">物業管理系統</option>
                                </optgroup>
                                <option value="其他">其他</option>
                            </select>`
                        }
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">引薦人（會員編號） *</label>
                        <div style="display: flex; gap: 8px;">
                            <div style="position: relative; flex: 1;">
                                <input type="text" id="referrerCode" class="referral-form-input" placeholder="例如：016 或 016濬瑒" required 
                                       style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; padding-right: 120px;">
                                <div id="memberNameHint" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 13px; font-weight: 600; pointer-events: none; display: none;">
                                    🔍 搜索中...
                                </div>
                            </div>
                            <button type="button" id="selectMemberBtn" onclick="showMemberList()" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s ease;" onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                👥 選擇會員
                            </button>
                        </div>
                        <div id="memberNameDisplay" style="margin-top: 5px; font-size: 13px; color: #28a745; font-weight: 600; display: none;">
                            <span id="memberNameText"></span>
                        </div>
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label class="referral-form-label" style="font-weight: 600; color: #333; font-size: 14px;">被引薦廠商名稱 *</label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="recommendMyself" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleRecommendMyself()">
                                <span style="font-size: 13px; color: #667eea; font-weight: 600;">👤 推薦我自己</span>
                            </label>
                        </div>
                        <input type="text" id="referredCompany" class="referral-form-input" placeholder="請輸入廠商名稱" required 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">廠商聯絡電話 *</label>
                        <input type="tel" id="companyPhone" class="referral-form-input" placeholder="請輸入廠商電話" required 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">廠商LINE ID</label>
                        <input type="text" id="companyLineId" class="referral-form-input" placeholder="請輸入廠商LINE ID" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 15px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">廠商服務區域</label>
                        <input type="text" id="companyArea" class="referral-form-input" placeholder="例如：台北市、新北市" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    
                    <div class="referral-form-field" style="margin-bottom: 20px;">
                        <label class="referral-form-label" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">引薦備註</label>
                        <textarea id="referralNote" class="referral-form-textarea" rows="3" placeholder="請簡述引薦原因或廠商特色"
                                  style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="referral-form-buttons" style="display: flex; gap: 10px;">
                        <button type="submit" class="referral-form-button" style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            提交引薦
                        </button>
                        <button type="button" class="referral-form-button" onclick="closeReferralForm()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            取消
                        </button>
                    </div>
                </form>
            `;
            
            formContainer.appendChild(form);
            document.body.appendChild(formContainer);
            
            // 處理表單提交
            document.getElementById('referralForm').addEventListener('submit', handleReferralSubmit);
            
            // 添加會員編號自動搜索功能
            setupMemberCodeSearch();
            
            // 添加電話號碼自動格式化功能
            setupPhoneFormatting();
        }
        
        // 顯示會員列表選擇器
        async function showMemberList() {
            const memberData = await loadMemberData();
            
            if (!memberData || Object.keys(memberData).length === 0) {
                alert('目前沒有會員資料，請先建立會員資料工作表。');
                return;
            }
            
            // 創建會員列表彈窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 500px;
                max-height: 70vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333; font-size: 18px;">👥 選擇會員成員</h3>
                    <button onclick="closeMemberList()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;" onmouseenter="this.style.background='#f1f3f4'; this.style.color='#333';" onmouseleave="this.style.background='none'; this.style.color='#666';">×</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="memberSearchInput" placeholder="🔍 搜尋會員姓名或編號..." 
                           style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                </div>
                <div id="memberListContainer" style="max-height: 50vh; overflow-y: auto;">
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 安全地添加會員項目
            const container = document.getElementById('memberListContainer');
            
            Object.entries(memberData).forEach(([code, info]) => {
                const item = document.createElement('div');
                item.className = 'member-item';
                item.dataset.code = code;
                item.dataset.name = info.name;
                item.style.cssText = 'padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s ease;';
                
                item.onmouseenter = function() {
                    this.style.borderColor = '#667eea';
                    this.style.background = '#f8f9fa';
                };
                item.onmouseleave = function() {
                    this.style.borderColor = '#e9ecef';
                    this.style.background = 'white';
                };
                item.onclick = function() {
                    selectMember(code, info.name);
                };
                
                const nameDiv = document.createElement('div');
                nameDiv.style.cssText = 'font-weight: 600; color: #333; font-size: 14px;';
                nameDiv.textContent = `${code} - ${info.name}`;
                item.appendChild(nameDiv);
                
                if (info.professionalCategory) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 4px;';
                    categoryDiv.textContent = info.professionalCategory;
                    item.appendChild(categoryDiv);
                }
                
                container.appendChild(item);
            });
            
            // 添加搜索功能
            const searchInput = document.getElementById('memberSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = modal.querySelectorAll('.member-item');
                    
                    items.forEach(item => {
                        const code = item.dataset.code.toLowerCase();
                        const name = item.dataset.name.toLowerCase();
                        const matches = code.includes(searchTerm) || name.includes(searchTerm);
                        item.style.display = matches ? 'block' : 'none';
                    });
                });
            }
        }
        
        // 關閉會員列表彈窗
        function closeMemberList() {
            const modal = document.querySelector('[style*="z-index: 3000"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // 選擇會員
        function selectMember(code, name) {
            const referrerCodeInput = document.getElementById('referrerCode');
            if (referrerCodeInput) {
                referrerCodeInput.value = `${code}${name}`;
                
                // 觸發搜索以顯示確認訊息
                referrerCodeInput.dispatchEvent(new Event('input'));
            }
            
            closeMemberList();
        }
        
        // 切換「推薦我自己」功能
        async function toggleRecommendMyself() {
            const checkbox = document.getElementById('recommendMyself');
            const referrerCodeInput = document.getElementById('referrerCode');
            const referredCompanyInput = document.getElementById('referredCompany');
            const companyPhoneInput = document.getElementById('companyPhone');
            const companyLineIdInput = document.getElementById('companyLineId');
            const companyAreaInput = document.getElementById('companyArea');
            
            if (!checkbox || !referrerCodeInput) return;
            
            if (checkbox.checked) {
                // 獲取引薦人編號
                const referrerCode = referrerCodeInput.value.trim();
                
                if (!referrerCode) {
                    alert('請先選擇或輸入引薦人（會員編號）');
                    checkbox.checked = false;
                    return;
                }
                
                // 提取會員編號
                const codeMatch = referrerCode.match(/(\d+)/);
                if (!codeMatch) {
                    alert('請輸入有效的會員編號');
                    checkbox.checked = false;
                    return;
                }
                
                const memberCode = codeMatch[1];
                
                // 從會員資料中查找
                const memberData = await loadMemberData();
                const memberInfo = memberData[memberCode];
                
                if (memberInfo) {
                    // 自動填充廠商名稱（使用會員姓名）
                    referredCompanyInput.value = `${memberCode} - ${memberInfo.name}`;
                    
                    // 如果當前沒有輸入電話，添加提示
                    if (!companyPhoneInput.value.trim()) {
                        companyPhoneInput.placeholder = '請輸入您的聯絡電話';
                    }
                    
                    if (!companyLineIdInput.value.trim()) {
                        companyLineIdInput.placeholder = '請輸入您的 LINE ID（選填）';
                    }
                    
                    if (!companyAreaInput.value.trim()) {
                        companyAreaInput.placeholder = '請輸入您的服務區域（選填）';
                    }
                    
                    // 標記這些欄位需要填寫
                    companyPhoneInput.style.borderColor = '#ffc107';
                    companyPhoneInput.title = '⚠️ 請填寫您的聯絡電話';
                } else {
                    alert('找不到會員資料，請確認會員編號是否正確');
                    checkbox.checked = false;
                }
            } else {
                // 取消勾選時清空廠商名稱並恢復樣式
                referredCompanyInput.value = '';
                companyPhoneInput.style.borderColor = '#e9ecef';
                companyPhoneInput.title = '';
                companyPhoneInput.placeholder = '請輸入廠商電話';
                companyLineIdInput.placeholder = '請輸入廠商LINE ID';
                companyAreaInput.placeholder = '例如：台北市、新北市';
            }
        }
        
        // 設置會員編號自動搜索功能
        function setupMemberCodeSearch() {
            const referrerCodeInput = document.getElementById('referrerCode');
            const memberNameHint = document.getElementById('memberNameHint');
            const memberNameDisplay = document.getElementById('memberNameDisplay');
            const memberNameText = document.getElementById('memberNameText');
            
            if (!referrerCodeInput) return;
            
            let searchTimeout = null;
            
            referrerCodeInput.addEventListener('input', async function(e) {
                const inputValue = e.target.value.trim();
                
                // 清除之前的搜索
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // 隱藏顯示區域
                if (memberNameDisplay) {
                    memberNameDisplay.style.display = 'none';
                }
                
                // 如果輸入為空，隱藏提示
                if (!inputValue) {
                    if (memberNameHint) {
                        memberNameHint.style.display = 'none';
                    }
                    return;
                }
                
                // 檢查是否包含數字（會員編號）
                const codeMatch = inputValue.match(/(\d+)/);
                if (!codeMatch) {
                    if (memberNameHint) {
                        memberNameHint.style.display = 'none';
                    }
                    return;
                }
                
                const memberCode = codeMatch[1];
                
                // 顯示搜索提示
                if (memberNameHint) {
                    memberNameHint.style.display = 'block';
                    memberNameHint.textContent = '🔍 搜索中...';
                }
                
                // 延遲搜索（避免頻繁請求）
                searchTimeout = setTimeout(async () => {
                    try {
                        // 先檢查會員資料是否已載入
                        const memberData = await loadMemberData();
                        const hasMemberData = memberData && Object.keys(memberData).length > 0;
                        
                        if (!hasMemberData) {
                            // 會員資料為空，不顯示搜索結果
                            if (memberNameHint) {
                                memberNameHint.style.display = 'none';
                            }
                            if (memberNameDisplay) {
                                memberNameDisplay.style.display = 'none';
                            }
                            return;
                        }
                        
                        const memberInfo = await searchMemberName(memberCode);
                        
                        if (memberNameHint) {
                            memberNameHint.style.display = 'none';
                        }
                        
                        if (memberInfo && memberInfo.name) {
                            // 顯示找到的會員資訊（作為可點選的選項）
                            if (memberNameDisplay && memberNameText) {
                                // 組建顯示文字：姓名 + 專業類別（如果有）
                                let displayText = `✅ 點擊選擇：${memberInfo.name}`;
                                if (memberInfo.professionalCategory) {
                                    displayText += `（${memberInfo.professionalCategory}）`;
                                }
                                memberNameText.textContent = displayText;
                                memberNameDisplay.style.display = 'block';
                                memberNameDisplay.style.color = '#667eea';
                                memberNameDisplay.style.cursor = 'pointer';
                                memberNameDisplay.style.backgroundColor = '#f0f4ff';
                                memberNameDisplay.style.padding = '8px';
                                memberNameDisplay.style.borderRadius = '6px';
                                memberNameDisplay.style.transition = 'all 0.2s ease';
                                
                                // 添加點擊事件
                                memberNameDisplay.onclick = function() {
                                    referrerCodeInput.value = `${memberCode}${memberInfo.name}`;
                                    memberNameDisplay.style.display = 'none';
                                };
                                
                                // 添加hover效果
                                memberNameDisplay.onmouseenter = function() {
                                    this.style.backgroundColor = '#e3e8ff';
                                    this.style.transform = 'translateX(3px)';
                                };
                                memberNameDisplay.onmouseleave = function() {
                                    this.style.backgroundColor = '#f0f4ff';
                                    this.style.transform = 'translateX(0)';
                                };
                            }
                        } else {
                            // 未找到會員（只有在會員資料庫不為空時才顯示）
                            if (memberNameDisplay && memberNameText) {
                                memberNameText.textContent = '⚠️ 未找到該會員編號';
                                memberNameDisplay.style.display = 'block';
                                memberNameDisplay.style.color = '#ff9800';
                                memberNameDisplay.style.cursor = 'default';
                                memberNameDisplay.style.backgroundColor = '#fff3cd';
                                memberNameDisplay.onclick = null;
                                memberNameDisplay.onmouseenter = null;
                                memberNameDisplay.onmouseleave = null;
                            }
                        }
                    } catch (error) {
                        console.error('搜索會員姓名失敗:', error);
                        if (memberNameHint) {
                            memberNameHint.style.display = 'none';
                        }
                    }
                }, 500); // 500ms 延遲
            });
            
            // 當失去焦點時，如果找到了姓名，確保輸入框格式正確
            referrerCodeInput.addEventListener('blur', function() {
                const inputValue = this.value.trim();
                const codeMatch = inputValue.match(/(\d+)/);
                if (codeMatch) {
                    const memberCode = codeMatch[1];
                    // 可以選擇自動補齊格式，但這裡保持用戶輸入的自由度
                }
            });
        }
        
        async function handleReferralSubmit(e) {
            e.preventDefault();
            
            const formData = {
                referredService: document.getElementById('referredService').value,
                referrerCode: document.getElementById('referrerCode').value,
                referredCompany: document.getElementById('referredCompany').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyLineId: document.getElementById('companyLineId').value,
                companyArea: document.getElementById('companyArea').value,
                referralNote: document.getElementById('referralNote').value,
                referralDate: new Date().toISOString()
            };
            
            // 提交到 Google Sheets（不直接添加到本地資料）
            const serviceItem = currentDetails ? currentDetails.item : formData.referredService;
            
            if (serviceItem) {
                // 直接提交到 Google Sheets
                const success = await handleReferralRegistration(formData);
                
                if (success) {
                    closeReferralForm();
                    
                    // 立即添加到本地資料並顯示
                    const referralInfo = {
                        serviceItem: formData.referredService,
                        referrerCode: formData.referrerCode,
                        companyName: formData.referredCompany,
                        phone: formatPhoneNumber(formData.companyPhone),
                        lineId: formData.companyLineId,
                        area: formData.companyArea,
                        note: formData.referralNote,
                        referralDate: formData.referralDate
                    };
                    
                    // 添加到本地引薦資料
                    if (!mindmapData.referrals) {
                        mindmapData.referrals = [];
                    }
                    mindmapData.referrals.push(referralInfo);
                    
                    // 重新顯示詳細資訊（立即顯示新資料）
                    if (currentDetails) {
                        showDetails(currentDetails.item, currentDetails.category, currentDetails.subCategory);
                        // 確保詳細資訊面板是打開的
                        document.getElementById('detailsPanel').classList.add('active');
                    }
                    
                    // 顯示成功訊息
                    alert('✅ 引薦登記成功！\n\n已立即顯示在頁面上，並同步提交到 Google Sheets。');
                } else {
                    alert('引薦登記失敗，請稍後再試。');
                }
            } else {
                console.error('無法確定服務項目，引薦資料未保存');
                alert('錯誤：無法確定服務項目，請重新選擇服務項目後再試。');
            }
        }
        
        // 設置電話號碼自動格式化功能
        function setupPhoneFormatting() {
            const phoneInput = document.getElementById('companyPhone');
            
            if (!phoneInput) return;
            
            // 失去焦點時自動格式化
            phoneInput.addEventListener('blur', function() {
                const inputValue = this.value.trim();
                
                if (inputValue) {
                    const formatted = formatPhoneNumber(inputValue);
                    this.value = formatted;
                    
                    // 顯示格式化提示
                    if (formatted !== inputValue) {
                        console.log(`電話號碼已格式化：${inputValue} → ${formatted}`);
                    }
                }
            });
        }
        
        // 設置成員編號自動搜索功能（用於隱私保護確認）
        function setupMemberCodeSearchForPrivacy() {
            const memberCodeInput = document.getElementById('memberCodeInput');
            const memberNameHint = document.getElementById('memberNameHintPrivacy');
            const memberNameDisplay = document.getElementById('memberNameDisplayPrivacy');
            const memberNameText = document.getElementById('memberNameTextPrivacy');
            
            if (!memberCodeInput) return;
            
            let searchTimeout = null;
            
            memberCodeInput.addEventListener('input', async function(e) {
                const inputValue = e.target.value.trim();
                
                // 清除之前的搜索
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // 隱藏顯示區域
                if (memberNameDisplay) {
                    memberNameDisplay.style.display = 'none';
                }
                
                // 如果輸入為空，隱藏提示
                if (!inputValue) {
                    if (memberNameHint) {
                        memberNameHint.style.display = 'none';
                    }
                    return;
                }
                
                // 檢查是否包含數字（會員編號）
                const codeMatch = inputValue.match(/(\d+)/);
                if (!codeMatch) {
                    if (memberNameHint) {
                        memberNameHint.style.display = 'none';
                    }
                    return;
                }
                
                const memberCode = codeMatch[1];
                
                // 顯示搜索提示
                if (memberNameHint) {
                    memberNameHint.style.display = 'block';
                    memberNameHint.textContent = '🔍 搜索中...';
                }
                
                // 延遲搜索（避免頻繁請求）
                searchTimeout = setTimeout(async () => {
                    try {
                        // 先檢查會員資料是否已載入
                        const memberData = await loadMemberData();
                        const hasMemberData = memberData && Object.keys(memberData).length > 0;
                        
                        if (!hasMemberData) {
                            // 會員資料為空，不顯示搜索結果
                            if (memberNameHint) {
                                memberNameHint.style.display = 'none';
                            }
                            if (memberNameDisplay) {
                                memberNameDisplay.style.display = 'none';
                            }
                            return;
                        }
                        
                        const memberInfo = await searchMemberName(memberCode);
                        
                        if (memberNameHint) {
                            memberNameHint.style.display = 'none';
                        }
                        
                        if (memberInfo && memberInfo.name) {
                            // 顯示找到的會員資訊（作為可點選的選項）
                            if (memberNameDisplay && memberNameText) {
                                // 組建顯示文字：姓名 + 專業類別（如果有）
                                let displayText = `✅ 點擊選擇：${memberInfo.name}`;
                                if (memberInfo.professionalCategory) {
                                    displayText += `（${memberInfo.professionalCategory}）`;
                                }
                                memberNameText.textContent = displayText;
                                memberNameDisplay.style.display = 'block';
                                memberNameDisplay.style.color = '#667eea';
                                memberNameDisplay.style.cursor = 'pointer';
                                memberNameDisplay.style.backgroundColor = '#f0f4ff';
                                memberNameDisplay.style.padding = '8px';
                                memberNameDisplay.style.borderRadius = '6px';
                                memberNameDisplay.style.transition = 'all 0.2s ease';
                                
                                // 添加點擊事件
                                memberNameDisplay.onclick = function() {
                                    memberCodeInput.value = `${memberCode}${memberInfo.name}`;
                                    memberNameDisplay.style.display = 'none';
                                };
                                
                                // 添加hover效果
                                memberNameDisplay.onmouseenter = function() {
                                    this.style.backgroundColor = '#e3e8ff';
                                    this.style.transform = 'translateX(3px)';
                                };
                                memberNameDisplay.onmouseleave = function() {
                                    this.style.backgroundColor = '#f0f4ff';
                                    this.style.transform = 'translateX(0)';
                                };
                            }
                        } else {
                            // 未找到會員（只有在會員資料庫不為空時才顯示）
                            if (memberNameDisplay && memberNameText) {
                                memberNameText.textContent = '⚠️ 未找到該會員編號';
                                memberNameDisplay.style.display = 'block';
                                memberNameDisplay.style.color = '#ff9800';
                                memberNameDisplay.style.cursor = 'default';
                                memberNameDisplay.style.backgroundColor = '#fff3cd';
                                memberNameDisplay.onclick = null;
                                memberNameDisplay.onmouseenter = null;
                                memberNameDisplay.onmouseleave = null;
                            }
                        }
                    } catch (error) {
                        console.error('搜索會員姓名失敗:', error);
                        if (memberNameHint) {
                            memberNameHint.style.display = 'none';
                        }
                    }
                }, 500); // 500ms 延遲
            });
            
            // 當失去焦點時，如果找到了姓名，確保輸入框格式正確
            memberCodeInput.addEventListener('blur', function() {
                const inputValue = this.value.trim();
                const codeMatch = inputValue.match(/(\d+)/);
                if (codeMatch) {
                    const memberCode = codeMatch[1];
                    // 可以選擇自動補齊格式，但這裡保持用戶輸入的自由度
                }
            });
        }
        
        function closeReferralForm() {
            const formContainer = document.querySelector('div[style*="position: fixed"]');
            if (formContainer) {
                formContainer.remove();
            }
        }
        
        // 馬賽克功能
        function maskPhone(phone) {
            if (!phone) return '****-****';
            // 確保 phone 是字串類型
            const phoneStr = String(phone);
            if (phoneStr.length <= 4) return '****';
            const start = phoneStr.substring(0, 2);
            const end = phoneStr.substring(phoneStr.length - 2);
            const middle = '*'.repeat(phoneStr.length - 4);
            return start + middle + end;
        }
        
        function maskLineId(lineId) {
            if (!lineId) return '****';
            // 確保 lineId 是字串類型
            const lineIdStr = String(lineId);
            if (lineIdStr.length <= 2) return '**';
            const start = lineIdStr.substring(0, 1);
            const end = lineIdStr.substring(lineIdStr.length - 1);
            const middle = '*'.repeat(Math.max(1, lineIdStr.length - 2));
            return start + middle + end;
        }
        
        // 驗證密碼並顯示聯絡資訊
        function verifyPasswordAndShow(phone, lineId, serviceItem, referrerCode, memberCode, correctPassword) {
            const input = document.getElementById('memberPasswordInput');
            const password = input ? input.value.trim() : '';
            
            if (password === correctPassword) {
                // 密碼正確，關閉密碼彈窗
                const passwordContainer = document.querySelector('[style*="z-index: 4000"]');
                if (passwordContainer) {
                    passwordContainer.remove();
                }
                
                // 顯示聯絡資訊（跳過隱私保護確認）
                showContactDetailsDirectly(phone, lineId, serviceItem, referrerCode);
            } else {
                // 密碼錯誤
                alert('❌ 密碼錯誤，請重新輸入');
                if (input) {
                    input.value = '';
                    input.focus();
                }
            }
        }
        
        // 直接顯示聯絡資訊（無需隱私保護確認）
        function showContactDetailsDirectly(phone, lineId, serviceItem, referrerCode) {
            // 顯示聯絡資訊
            let contactHTML = '<div style="text-align: center; padding: 20px;">';
            contactHTML += '<h3 style="color: #667eea; margin-bottom: 15px;">📞 聯絡資訊</h3>';
            
            if (phone) {
                contactHTML += `<div style="margin-bottom: 12px;">
                    <strong style="color: #4a5568;">電話：</strong>
                    <span style="color: #667eea; font-size: 16px; font-weight: 600;">${phone}</span>
                </div>`;
            }
            
            if (lineId) {
                contactHTML += `<div style="margin-bottom: 12px;">
                    <strong style="color: #4a5568;">LINE ID：</strong>
                    <span style="color: #667eea; font-size: 16px; font-weight: 600;">${lineId}</span>
                </div>`;
            }
            
            contactHTML += '</div>';
            
            // 創建彈窗顯示聯絡資訊
            const infoContainer = document.createElement('div');
            infoContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 4000;
            `;
            
            const infoDialog = document.createElement('div');
            infoDialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            infoDialog.innerHTML = contactHTML + `
                <button onclick="this.closest('[style*=\"z-index: 4000\"]').remove()" 
                        style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    關閉
                </button>
            `;
            
            infoContainer.appendChild(infoDialog);
            document.body.appendChild(infoContainer);
        }
        
        // 顯示所有聯絡資訊詳情
        async function showAllContactDetails(phone, lineId, serviceItem, referrerCode, isMember = false, memberCode = '') {
            // 創建隱私保護確認彈窗（統一使用）
            const confirmContainer = document.createElement('div');
            confirmContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8f9fa);
                padding: 0;
                border-radius: 20px;
                width: 95%;
                max-width: 520px;
                max-height: 90vh;
                box-shadow: 0 25px 50px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1);
                text-align: center;
                overflow-y: auto;
                overflow-x: hidden;
                animation: slideUp 0.4s ease-out;
                display: flex;
                flex-direction: column;
            `;
            
            const maskedPhone = maskPhone(phone);
            const maskedLineId = lineId ? maskLineId(lineId) : '';
            
            confirmDialog.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .modal-header {
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        padding: 15px 20px;
                        margin: 0;
                    }
                    .modal-title {
                        font-size: 18px;
                        font-weight: 700;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    }
                    .modal-body {
                        padding: 20px;
                        flex: 1;
                        overflow-y: auto;
                        overflow-x: hidden;
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                    }
                    @media (max-width: 480px) {
                        .modal-body {
                            padding: 20px 15px;
                            max-height: calc(90vh - 100px) !important;
                            overflow-y: auto !important;
                            overflow-x: hidden !important;
                        }
                        .modal-header {
                            padding: 20px 15px;
                        }
                        .modal-title {
                            font-size: 18px;
                        }
                        .info-card {
                            padding: 12px;
                            margin: 15px 0;
                            grid-template-columns: 1fr 1fr;
                            gap: 8px;
                        }
                        .info-item {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 4px;
                            padding: 8px;
                        }
                        .info-label {
                            font-size: 12px;
                        }
                        .info-value {
                            font-size: 12px;
                            word-break: break-all;
                        }
                        .warning-card {
                            padding: 15px;
                            margin: 15px 0;
                        }
                        .warning-text {
                            font-size: 14px;
                        }
                        .warning-text strong {
                            font-size: 15px;
                        }
                        .button-group {
                            flex-direction: column;
                            gap: 10px;
                            margin-top: 20px;
                        }
                        .btn-primary, .btn-secondary {
                            width: 100%;
                            padding: 12px 20px;
                            font-size: 14px;
                        }
                        input[type="text"] {
                            font-size: 16px;
                            padding: 10px;
                        }
                        label {
                            font-size: 13px;
                        }
                        p {
                            font-size: 13px;
                            margin: 15px 0;
                        }
                    }
                    .info-card {
                        background: linear-gradient(135deg, #f8f9ff, #ffffff);
                        border: 2px solid #e3e8ff;
                        border-radius: 12px;
                        padding: 12px 15px;
                        margin: 10px 0;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                    }
                    .info-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                        padding: 8px;
                        background: rgba(255, 255, 255, 0.5);
                        border-radius: 8px;
                        border: 1px solid #e3e8ff;
                    }
                    .info-item:last-child {
                        border-bottom: none;
                    }
                    .info-label {
                        font-weight: 600;
                        color: #4a5568;
                        font-size: 12px;
                    }
                    .info-value {
                        color: #2d3748;
                        font-weight: 500;
                        font-size: 13px;
                        word-break: break-word;
                    }
                    .warning-card {
                        background: linear-gradient(135deg, #fff3cd, #ffe69c);
                        border: 3px solid #ff9800;
                        border-radius: 12px;
                        padding: 12px 15px;
                        margin: 10px 0;
                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                        animation: pulse-warning 2s infinite;
                    }
                    @keyframes pulse-warning {
                        0%, 100% { box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
                        50% { box-shadow: 0 4px 20px rgba(255, 152, 0, 0.5); }
                    }
                    .warning-icon {
                        font-size: 20px;
                        margin-bottom: 5px;
                    }
                    .warning-text {
                        color: #d84315;
                        font-weight: 600;
                        line-height: 1.4;
                        font-size: 13px;
                    }
                    .warning-text strong {
                        color: #e65100;
                        font-size: 14px;
                        font-weight: 700;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                    }
                    .button-group {
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 15px;
                    }
                    .btn-primary {
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3);
                    }
                    .btn-primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 18px rgba(40, 167, 69, 0.4);
                    }
                    .btn-secondary {
                        background: linear-gradient(135deg, #6c757d, #495057);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 3px 12px rgba(108, 117, 125, 0.3);
                    }
                    .btn-secondary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 18px rgba(108, 117, 125, 0.4);
                    }
                    /* 滾輪樣式 */
                    .modal-content::-webkit-scrollbar {
                        width: 8px;
                    }
                    .modal-content::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 4px;
                    }
                    .modal-content::-webkit-scrollbar-thumb {
                        background: #667eea;
                        border-radius: 4px;
                    }
                    .modal-content::-webkit-scrollbar-thumb:hover {
                        background: #5a6fd8;
                    }
                </style>
                
                <div class="modal-header">
                    <h3 class="modal-title">
                        🔒 隱私保護確認
                    </h3>
                </div>
                
                <div class="modal-body modal-content" style="overflow-x: hidden; overflow-y: auto;">
                    <div class="info-card">
                        <div class="info-item">
                            <span class="info-label">服務項目</span>
                            <span class="info-value">${serviceItem}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">引薦人</span>
                            <span class="info-value">${referrerCode}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">聯絡電話</span>
                            <span class="info-value">${maskedPhone}</span>
                        </div>
                        ${lineId ? `<div class="info-item">
                            <span class="info-label">LINE ID</span>
                            <span class="info-value">${maskedLineId}</span>
                        </div>` : ''}
                    </div>
                    
                    <p style="color: #6c757d; margin: 8px 0; font-size: 13px; line-height: 1.4;">
                        這是外部引薦資訊，使用引薦系統請記得至 BNI 系統 KEY 引薦對象
                    </p>
                    
                    <div style="margin: 8px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                            👤 請輸入您的華地產成員編號 *
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="memberCodeInput" placeholder="例如：016 或 016濬瑒" required
                                   style="width: 100%; padding: 10px; border: 2px solid #e3e8ff; border-radius: 8px; font-size: 13px; transition: all 0.3s ease; padding-right: 120px;"
                                   onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';"
                                   onblur="this.style.borderColor='#e3e8ff'; this.style.boxShadow='none';">
                            <div id="memberNameHintPrivacy" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 13px; font-weight: 600; pointer-events: none; display: none;">
                                🔍 搜索中...
                            </div>
                        </div>
                        <div id="memberNameDisplayPrivacy" style="margin-top: 5px; font-size: 13px; color: #28a745; font-weight: 600; display: none;">
                            <span id="memberNameTextPrivacy"></span>
                        </div>
                        <p style="color: #6c757d; font-size: 11px; margin-top: 3px; text-align: left;">
                            此編號將記錄在使用記錄中以追蹤是哪位成員調用了聯絡資訊
                        </p>
                    </div>
                    
                    <div style="margin: 8px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; font-size: 13px;">
                            🔐 請輸入您的會員密碼 *
                        </label>
                        <input type="password" id="memberPasswordInputPrivacy" maxlength="4" placeholder="請輸入4碼密碼" required
                               style="width: 100%; padding: 10px; border: 2px solid #e3e8ff; border-radius: 8px; font-size: 13px; transition: all 0.3s ease; text-align: center; letter-spacing: 8px;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';"
                               onblur="this.style.borderColor='#e3e8ff'; this.style.boxShadow='none';"
                               onkeypress="if(event.key==='Enter') confirmAllContactAccessWithMemberCode('${phone}', '${lineId}', '${serviceItem}', '${referrerCode}')">
                        <p style="color: #6c757d; font-size: 11px; margin-top: 3px; text-align: left;">
                            請輸入您的會員密碼以驗證身份
                        </p>
                    </div>
                    
                    <div class="warning-card">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-text">
                            <strong>重要提醒：</strong><br>
                            點擊同意後，您的操作記錄將被記錄用於核實是否有 KEY 引薦
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="confirmAllContactAccessWithMemberCode('${phone}', '${lineId}', '${serviceItem}', '${referrerCode}')">
                            ✅ 同意查看
                        </button>
                        <button class="btn-secondary" onclick="closeContactConfirm()">
                            ❌ 取消
                        </button>
                    </div>
                </div>
            `;
            
            confirmContainer.appendChild(confirmDialog);
            document.body.appendChild(confirmContainer);
            
            // 添加成員編號快搜功能
            setupMemberCodeSearchForPrivacy();
            
            // 自動聚焦到密碼輸入框
            setTimeout(() => {
                const passwordInput = document.getElementById('memberPasswordInputPrivacy');
                if (passwordInput) {
                    passwordInput.focus();
                }
            }, 100);
        }
        
        // 確認查看所有聯絡資訊（帶成員編號）
        async function confirmAllContactAccessWithMemberCode(phone, lineId, serviceItem, referrerCode) {
            // 獲取成員編號
            const memberCodeInput = document.getElementById('memberCodeInput');
            const memberCode = memberCodeInput ? memberCodeInput.value.trim() : '';
            
            // 獲取密碼
            const passwordInput = document.getElementById('memberPasswordInputPrivacy');
            const password = passwordInput ? passwordInput.value.trim() : '';
            
            // 驗證成員編號
            if (!memberCode) {
                alert('⚠️ 請輸入您的華地產成員編號！');
                if (memberCodeInput) {
                    memberCodeInput.focus();
                }
                return;
            }
            
            // 驗證密碼
            if (!password) {
                alert('⚠️ 請輸入您的會員密碼！');
                if (passwordInput) {
                    passwordInput.focus();
                }
                return;
            }
            
            // 提取純數字編號
            const cleanCode = memberCode.replace(/[^0-9]/g, '');
            
            // 從會員資料中查找並驗證密碼
            const memberData = await loadMemberData();
            const memberInfo = memberData[cleanCode];
            
            if (!memberInfo) {
                alert('❌ 找不到該會員編號，請確認編號是否正確');
                return;
            }
            
            // 檢查會員是否有設置密碼
            if (!memberInfo.password || memberInfo.password.trim() === '') {
                alert('❌ 該會員尚未設置密碼，請聯繫管理員設置密碼');
                return;
            }
            
            // 驗證密碼
            if (memberInfo.password !== password) {
                alert('❌ 密碼錯誤，請重新輸入');
                if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                return;
            }
            
            console.log('✅ 密碼驗證成功');
            console.log('成員編號:', memberCode);
            
            // 合併聯絡資訊格式：電話和 LINE ID 整合在一筆記錄中
            // 格式化電話號碼（不足10碼前面補0）
            const formattedPhone = phone ? formatPhoneNumber(phone) : '';
            
            const contactParts = [];
            if (formattedPhone) contactParts.push(`電話：${formattedPhone}`);
            if (lineId) contactParts.push(`LINE ID：${lineId}`);
            const combinedContact = contactParts.join(' | ');
            
            // 單筆記錄包含所有聯絡資訊
            const accessInfo = {
                accessTime: new Date().toISOString(),
                accessType: 'contact',  // 統一為聯絡資訊類型
                contactValue: combinedContact,  // 合併後的聯絡資訊
                phone: formattedPhone,  // 保存格式化後的電話號碼
                lineId: lineId || '',  // 保存原始 LINE ID
                serviceItem: serviceItem,
                referrerCode: referrerCode,
                memberCode: memberCode,
                userAgent: navigator.userAgent,
                timestamp: Date.now()
            };
            
            // 保存到本地存儲
            let accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
            accessLogs.push(accessInfo);
            localStorage.setItem('contactAccessLogs', JSON.stringify(accessLogs));
            
            // 提交使用記錄到 Google Sheets（只提交一次）
            handleAccessLogSubmission({
                accessTime: new Date().toISOString(),
                accessType: 'contact',
                contactValue: combinedContact,
                serviceItem: serviceItem,
                referrerCode: referrerCode,
                memberCode: memberCode
            });
            
            // 更新當前彈窗中的聯絡資訊顯示
            updateModalContactInfo(phone, lineId, serviceItem, referrerCode);
        }
        
        // 顯示聯絡資訊詳情（保留原函數以備用）
        function showContactDetails(type, value, serviceItem, referrerCode) {
            // 創建隱私保護確認彈窗
            const confirmContainer = document.createElement('div');
            confirmContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
            `;
            
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 95%;
                max-width: 500px;
                max-height: 90vh;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                overflow-y: auto;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
            `;
            
            const typeText = type === 'phone' ? '電話' : 'LINE ID';
            const maskedValue = type === 'phone' ? maskPhone(value) : maskLineId(value);
            
            confirmDialog.innerHTML = `
                <style>
                    @media (max-width: 480px) {
                        .contact-confirm-content {
                            padding: 20px 15px !important;
                        }
                        .contact-confirm-title {
                            font-size: 18px !important;
                        }
                        .contact-confirm-info {
                            padding: 15px !important;
                            font-size: 13px !important;
                        }
                        .contact-confirm-warning {
                            padding: 15px !important;
                            font-size: 14px !important;
                        }
                        .contact-confirm-buttons {
                            flex-direction: column !important;
                            gap: 10px !important;
                        }
                        .contact-confirm-button {
                            width: 100% !important;
                            padding: 12px 20px !important;
                        }
                    }
                </style>
                <div class="contact-confirm-content" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                    <h3 class="contact-confirm-title" style="margin: 0 0 15px 0; color: #333; font-size: 20px;">🔒 隱私保護確認</h3>
                    <div class="contact-confirm-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
                        <strong>服務項目：</strong>${serviceItem}<br>
                        <strong>引薦人：</strong>${referrerCode}<br>
                        <strong>${typeText}：</strong>${maskedValue}
                    </div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        這是外部引薦資訊，使用引薦系統請記得至 BNI 系統 KEY 引薦對象
                    </p>
                    <div class="contact-confirm-warning" style="background: linear-gradient(135deg, #fff3cd, #ffe69c); padding: 15px; border-radius: 8px; border: 3px solid #ff9800; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                        <strong style="color: #e65100; font-size: 16px;">⚠️ 重要提醒：</strong><br>
                        <span style="color: #d84315; font-weight: 600;">點擊同意後，您的操作記錄將被記錄用於核實是否有 KEY 引薦</span>
                    </div>
                </div>
                
                <div class="contact-confirm-buttons" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="confirmContactAccess('${type}', '${value}', '${serviceItem}', '${referrerCode}')" 
                            class="contact-confirm-button"
                            style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        同意查看
                    </button>
                    <button onclick="closeContactConfirm()" 
                            class="contact-confirm-button"
                            style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        取消
                    </button>
                </div>
            `;
            
            confirmContainer.appendChild(confirmDialog);
            document.body.appendChild(confirmContainer);
        }
        
        // 確認查看聯絡資訊
        async function confirmContactAccess(type, value, serviceItem, referrerCode) {
            try {
                console.log('開始處理隱私保護確認:', { type, value, serviceItem, referrerCode });
                
                // 記錄使用者資訊
                const userInfo = {
                    accessTime: new Date().toISOString(),
                    accessType: type,
                    contactValue: value,
                    serviceItem: serviceItem,
                    referrerCode: referrerCode,
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                };
                
                console.log('使用者資訊:', userInfo);
                
                // 保存到本地存儲
                let accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
                accessLogs.push(userInfo);
                localStorage.setItem('contactAccessLogs', JSON.stringify(accessLogs));
                console.log('✅ 使用記錄已保存到本地存儲');
                
                // 提交到 Google Sheets
                const success = await handleAccessLogSubmission(userInfo);
                
                if (success) {
                    console.log('✅ 使用記錄已成功提交到 Google Sheets');
                } else {
                    console.warn('⚠️ 使用記錄提交到 Google Sheets 失敗，但已保存到本地');
                }
                
                // 更新頁面上的聯絡資訊顯示
                updateContactDisplay(type, value, serviceItem, referrerCode);
                
                // 關閉確認彈窗
                closeContactConfirm();
                
                // 顯示提醒訊息
                const typeText = type === 'phone' ? '電話' : 'LINE ID';
                const statusMessage = success ? '✅ 使用記錄已記錄' : '⚠️ 使用記錄已保存到本地';
                alert(`${typeText}：${value}\n\n${statusMessage}\n\n⚠️ 請記得至 BNI 系統 KEY 引薦對象！`);
                
            } catch (error) {
                console.error('隱私保護確認處理失敗:', error);
                
                // 即使出錯也要顯示聯絡資訊
                updateContactDisplay(type, value, serviceItem, referrerCode);
                closeContactConfirm();
                
                const typeText = type === 'phone' ? '電話' : 'LINE ID';
                alert(`${typeText}：${value}\n\n⚠️ 請記得至 BNI 系統 KEY 引薦對象！`);
            }
        }
        
        // 複製到剪貼板
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // 備用方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                } catch (err) {
                    document.body.removeChild(textArea);
                    return false;
                }
            }
        }
        
        // 顯示複製成功提示
        function showCopySuccess(element) {
            const originalText = element.textContent;
            element.textContent = '✅ 已複製！';
            element.style.color = '#28a745';
            setTimeout(() => {
                element.textContent = originalText;
                element.style.color = '';
            }, 1500);
        }
        
        // 撥打電話
        function makePhoneCall(phone) {
            window.location.href = `tel:${phone}`;
        }
        
        // 複製 LINE ID
        async function copyLineId(lineId) {
            const success = await copyToClipboard(lineId);
            if (success) {
                // 顯示提示
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #28a745;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 25px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 5000;
                    font-weight: 600;
                `;
                toast.textContent = '✅ LINE ID 已複製到剪貼板！';
                document.body.appendChild(toast);
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 2000);
            } else {
                alert('複製失敗，請手動複製：' + lineId);
            }
        }
        
        // 更新聯絡資訊顯示
        function updateContactDisplay(type, value, serviceItem, referrerCode) {
            // 找到對應的馬賽克資訊元素
            const maskedElements = document.querySelectorAll('.masked-info');
            maskedElements.forEach(element => {
                if (element.getAttribute('data-type') === type && element.getAttribute('data-value') === value) {
                    // 移除查看詳情按鈕
                    const button = element.parentNode.querySelector('button');
                    if (button) {
                        button.remove();
                    }
                    
                    // 創建新的顯示容器
                    const container = document.createElement('div');
                    container.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                    
                    // 顯示完整資訊（如果是電話，格式化為10碼）
                    const displayValue = type === 'phone' ? formatPhoneNumber(value) : value;
                    const infoSpan = document.createElement('span');
                    infoSpan.textContent = displayValue;
                    infoSpan.style.cssText = 'color: #28a745; font-weight: bold; font-size: 13px;';
                    container.appendChild(infoSpan);
                    
                    // 添加操作按鈕
                    if (type === 'phone') {
                        // 電話：添加撥號按鈕
                        const callBtn = document.createElement('button');
                        callBtn.innerHTML = '📞';
                        callBtn.title = '撥打電話';
                        callBtn.style.cssText = `
                            background: #28a745;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 28px;
                            height: 28px;
                            font-size: 14px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                        `;
                        callBtn.onclick = (e) => {
                            e.stopPropagation();
                            makePhoneCall(displayValue);
                        };
                        callBtn.onmouseenter = () => {
                            callBtn.style.transform = 'scale(1.1)';
                            callBtn.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.4)';
                        };
                        callBtn.onmouseleave = () => {
                            callBtn.style.transform = 'scale(1)';
                            callBtn.style.boxShadow = '0 2px 8px rgba(40, 167, 69, 0.3)';
                        };
                        container.appendChild(callBtn);
                    } else if (type === 'lineid') {
                        // LINE ID：添加複製按鈕
                        const copyBtn = document.createElement('button');
                        copyBtn.innerHTML = '📋';
                        copyBtn.title = '複製 LINE ID';
                        copyBtn.style.cssText = `
                            background: #00c300;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 28px;
                            height: 28px;
                            font-size: 14px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(0, 195, 0, 0.3);
                        `;
                        copyBtn.onclick = async (e) => {
                            e.stopPropagation();
                            const success = await copyToClipboard(value);
                            if (success) {
                                showCopySuccess(copyBtn);
                            } else {
                                alert('複製失敗，請手動複製：' + value);
                            }
                        };
                        copyBtn.onmouseenter = () => {
                            copyBtn.style.transform = 'scale(1.1)';
                            copyBtn.style.boxShadow = '0 4px 12px rgba(0, 195, 0, 0.4)';
                        };
                        copyBtn.onmouseleave = () => {
                            copyBtn.style.transform = 'scale(1)';
                            copyBtn.style.boxShadow = '0 2px 8px rgba(0, 195, 0, 0.3)';
                        };
                        container.appendChild(copyBtn);
                    }
                    
                    // 替換原元素
                    element.parentNode.replaceChild(container, element);
                }
            });
        }
        
        // 關閉聯絡資訊確認彈窗
        function closeContactConfirm() {
            const confirmContainer = document.querySelector('div[style*="position: fixed"][style*="z-index: 3000"]');
            if (confirmContainer) {
                confirmContainer.remove();
            }
        }
        
        // 切換引薦人詳細資訊
        function toggleReferralDetails(item) {
            // item 參數已經包含了完整的 uniqueId，直接使用
            const detailsDiv = document.getElementById(`referralDetails_${item}`);
            
            if (!detailsDiv) return;
            
            // 找到同一個 referral-item 內的 expand-icon
            const parentItem = detailsDiv.closest('.referral-item');
            if (!parentItem) return;
            
            const expandIcon = parentItem.querySelector('.expand-icon');
            if (!expandIcon) return;
            
            // 獨立展開/收合每個卡片
            const isHidden = detailsDiv.style.display === 'none' || detailsDiv.style.display === '';
            
            if (isHidden) {
                detailsDiv.style.display = 'block';
                expandIcon.style.transform = 'rotate(90deg)';
                expandIcon.textContent = '▼';
            } else {
                detailsDiv.style.display = 'none';
                expandIcon.style.transform = 'rotate(0deg)';
                expandIcon.textContent = '▶';
            }
        }
        
        // 顯示解鎖後的聯絡資訊彈窗
        function showUnlockedContactModal(phone, lineId, serviceItem, referrerCode) {
            // 創建解鎖資訊彈窗
            const modalContainer = document.createElement('div');
            modalContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(40, 167, 69, 0.9), rgba(32, 201, 151, 0.9));
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 4000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const modalDialog = document.createElement('div');
            modalDialog.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8fff9);
                padding: 0;
                border-radius: 20px;
                width: 95%;
                max-width: 450px;
                max-height: 90vh;
                box-shadow: 0 25px 50px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1);
                text-align: center;
                overflow: hidden;
                animation: slideUp 0.4s ease-out;
                display: flex;
                flex-direction: column;
            `;
            
            modalDialog.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .unlocked-header {
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        padding: 25px 30px;
                        margin: 0;
                    }
                    .unlocked-title {
                        font-size: 22px;
                        font-weight: 700;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    }
                    .unlocked-body {
                        padding: 30px;
                        flex: 1;
                        overflow-y: auto;
                        overflow-x: hidden;
                    }
                    @media (max-width: 480px) {
                        .unlocked-header {
                            padding: 20px 15px !important;
                        }
                        .unlocked-title {
                            font-size: 18px !important;
                        }
                        .unlocked-body {
                            padding: 20px 15px !important;
                            max-height: calc(90vh - 100px) !important;
                        }
                        .contact-info-card {
                            padding: 15px !important;
                            margin: 15px 0 !important;
                        }
                        .contact-item {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            padding: 10px 15px !important;
                        }
                        .contact-left {
                            margin-bottom: 8px;
                        }
                        .contact-label {
                            font-size: 12px !important;
                        }
                        .contact-value {
                            font-size: 16px !important;
                            width: 100%;
                            word-break: break-all;
                        }
                        .warning-card {
                            padding: 15px !important;
                            margin: 15px 0 !important;
                        }
                        .warning-text {
                            font-size: 13px !important;
                        }
                        .close-btn {
                            width: 100% !important;
                            padding: 12px 20px !important;
                        }
                    }
                    .contact-info-card {
                        background: linear-gradient(135deg, #e8f5e8, #ffffff);
                        border: 2px solid #28a745;
                        border-radius: 15px;
                        padding: 25px;
                        margin: 20px 0;
                        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.1);
                    }
                    .contact-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 15px 20px;
                        margin: 10px 0;
                        background: rgba(255, 255, 255, 0.8);
                        border-radius: 12px;
                        border: 1px solid #d4edda;
                        transition: all 0.3s ease;
                    }
                    .contact-item:hover {
                        background: rgba(255, 255, 255, 1);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
                    }
                    .contact-left {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .contact-icon {
                        font-size: 24px;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: linear-gradient(135deg, #28a745, #20c997);
                        border-radius: 50%;
                        color: white;
                    }
                    .contact-label {
                        color: #4a5568;
                        font-weight: 600;
                        font-size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .contact-value {
                        color: #155724;
                        font-weight: 700;
                        font-size: 18px;
                        font-family: 'Courier New', monospace;
                        background: #f8f9fa;
                        padding: 8px 12px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                    }
                    .warning-card {
                        background: linear-gradient(135deg, #fff3cd, #ffffff);
                        border: 2px solid #ffc107;
                        border-radius: 15px;
                        padding: 20px;
                        margin: 20px 0;
                        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.1);
                    }
                    .warning-icon {
                        font-size: 24px;
                        margin-bottom: 10px;
                    }
                    .warning-text {
                        color: #856404;
                        font-weight: 500;
                        line-height: 1.5;
                    }
                    .close-btn {
                        background: linear-gradient(135deg, #6c757d, #495057);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                        margin-top: 20px;
                    }
                    .close-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
                    }
                </style>
                
                <div class="unlocked-header">
                    <h3 class="unlocked-title">
                        🔓 聯絡資訊已解鎖
                    </h3>
                </div>
                
                <div class="unlocked-body">
                    <div class="contact-info-card">
                        <div class="contact-item">
                            <div class="contact-left">
                                <div class="contact-icon">📞</div>
                                <span class="contact-label">聯絡電話</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="contact-value">${phone}</span>
                                <button onclick="makePhoneCall('${phone}')" title="撥打電話" style="background: #28a745; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">📞</button>
                            </div>
                        </div>
                        ${lineId ? `<div class="contact-item">
                            <div class="contact-left">
                                <div class="contact-icon">💬</div>
                                <span class="contact-label">LINE ID</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="contact-value">${lineId}</span>
                                <button onclick="copyLineId('${lineId}')" title="複製 LINE ID" style="background: #00c300; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(0, 195, 0, 0.3);">📋</button>
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <div class="warning-card">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-text">
                            <strong>重要提醒：</strong><br>
                            請記得至 BNI 系統 KEY 引薦對象！
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="closeUnlockedContactModal()">
                        ✅ 我知道了
                    </button>
                </div>
            `;
            
            modalContainer.appendChild(modalDialog);
            document.body.appendChild(modalContainer);
        }
        
        // 關閉解鎖聯絡資訊彈窗
        function closeUnlockedContactModal() {
            const modalContainer = document.querySelector('div[style*="z-index: 4000"]');
            if (modalContainer) {
                modalContainer.remove();
            }
        }
        
        // 更新彈窗中的聯絡資訊顯示
        function updateModalContactInfo(phone, lineId, serviceItem, referrerCode) {
            const confirmContainer = document.querySelector('div[style*="z-index: 3000"]');
            if (confirmContainer) {
                const confirmDialog = confirmContainer.querySelector('div[style*="border-radius: 20px"]');
                if (confirmDialog) {
                    // 更新標題
                    const titleElement = confirmDialog.querySelector('.modal-title');
                    if (titleElement) {
                        titleElement.innerHTML = '🔓 聯絡資訊已解鎖';
                    }
                    
                    // 更新標題背景色
                    const headerElement = confirmDialog.querySelector('.modal-header');
                    if (headerElement) {
                        headerElement.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    }
                    
                    // 使用更可靠的方式查找聯絡資訊項目
                    const infoItems = confirmDialog.querySelectorAll('.info-item');
                    let phoneItem = null;
                    let lineItem = null;
                    
                    // 通過標籤文字找到對應的元素
                    infoItems.forEach(item => {
                        const label = item.querySelector('.info-label');
                        if (label) {
                            const labelText = label.textContent.trim();
                            if (labelText.includes('聯絡電話') || labelText.includes('電話')) {
                                phoneItem = item;
                            } else if (labelText.includes('LINE ID') || labelText.includes('LINE')) {
                                lineItem = item;
                            }
                        }
                    });
                    
                    // 更新電話資訊（格式化為10碼）
                    if (phoneItem && phone) {
                        const formattedPhone = formatPhoneNumber(phone);
                        phoneItem.innerHTML = `
                            <span class="info-label">聯絡電話</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="info-value" style="color: #155724; font-weight: 700; background: #e8f5e8; padding: 4px 8px; border-radius: 4px;">${formattedPhone}</span>
                                <button onclick="makePhoneCall('${formattedPhone.replace(/'/g, "\\'")}')" title="撥打電話" style="background: #28a745; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);">📞</button>
                            </div>
                        `;
                    }
                    
                    // 更新 LINE ID 資訊
                    if (lineItem && lineId) {
                        lineItem.innerHTML = `
                            <span class="info-label">LINE ID</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="info-value" style="color: #155724; font-weight: 700; background: #e8f5e8; padding: 4px 8px; border-radius: 4px;">${lineId}</span>
                                <button onclick="copyLineId('${lineId.replace(/'/g, "\\'")}')" title="複製 LINE ID" style="background: #00c300; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 195, 0, 0.3);">📋</button>
                            </div>
                        `;
                    }
                    
                    // 移除成員編號輸入框（因為已經解鎖）
                    const memberCodeInput = confirmDialog.querySelector('#memberCodeInput');
                    if (memberCodeInput) {
                        const inputContainer = memberCodeInput.closest('div[style*="margin: 8px 0"]');
                        if (inputContainer) {
                            inputContainer.style.display = 'none';
                        }
                    }
                    
                    // 更新按鈕
                    const buttonGroup = confirmDialog.querySelector('.button-group');
                    if (buttonGroup) {
                        buttonGroup.innerHTML = `
                            <button class="btn-primary" onclick="closeContactConfirm()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3); width: 100%;">
                                ✅ 我知道了
                            </button>
                        `;
                    }
                    
                    // 更新警告文字
                    const warningText = confirmDialog.querySelector('.warning-text');
                    if (warningText) {
                        warningText.innerHTML = `
                            <strong>重要提醒：</strong><br>
                            請記得至 BNI 系統 KEY 引薦對象！
                        `;
                    }
                }
                
                // 同時更新頁面上的聯絡資訊顯示（格式化電話）
                if (phone) {
                    updateContactDisplay('phone', phone, serviceItem, referrerCode);
                }
                if (lineId) {
                    updateContactDisplay('lineid', lineId, serviceItem, referrerCode);
                }
            }
        }
        
        // 更新當前彈窗顯示完整聯絡資訊（保留原函數以備用）
        function updateCurrentModalWithContactInfo(phone, lineId, serviceItem, referrerCode) {
            const confirmContainer = document.querySelector('div[style*="z-index: 3000"]');
            if (confirmContainer) {
                const confirmDialog = confirmContainer.querySelector('div[style*="border-radius: 20px"]');
                if (confirmDialog) {
                    // 更新彈窗內容
                    confirmDialog.innerHTML = `
                        <style>
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            @keyframes slideUp {
                                from { transform: translateY(50px); opacity: 0; }
                                to { transform: translateY(0); opacity: 1; }
                            }
                            /* 滾輪樣式 */
                            .modal-content::-webkit-scrollbar {
                                width: 8px;
                            }
                            .modal-content::-webkit-scrollbar-track {
                                background: #f1f1f1;
                                border-radius: 4px;
                            }
                            .modal-content::-webkit-scrollbar-thumb {
                                background: #667eea;
                                border-radius: 4px;
                            }
                            .modal-content::-webkit-scrollbar-thumb:hover {
                                background: #5a6fd8;
                            }
                            .unlocked-header {
                                background: linear-gradient(135deg, #28a745, #20c997);
                                color: white;
                                padding: 25px 30px;
                                margin: 0;
                            }
                            .unlocked-title {
                                font-size: 22px;
                                font-weight: 700;
                                margin: 0;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 10px;
                            }
                            .unlocked-body {
                                padding: 30px;
                            }
                            .contact-info-card {
                                background: linear-gradient(135deg, #e8f5e8, #ffffff);
                                border: 2px solid #28a745;
                                border-radius: 15px;
                                padding: 25px;
                                margin: 20px 0;
                                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.1);
                            }
                            .contact-item {
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                padding: 15px 20px;
                                margin: 10px 0;
                                background: rgba(255, 255, 255, 0.8);
                                border-radius: 12px;
                                border: 1px solid #d4edda;
                                transition: all 0.3s ease;
                            }
                            .contact-item:hover {
                                background: rgba(255, 255, 255, 1);
                                transform: translateY(-2px);
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
                            }
                            .contact-left {
                                display: flex;
                                align-items: center;
                                gap: 12px;
                            }
                            .contact-icon {
                                font-size: 24px;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: linear-gradient(135deg, #28a745, #20c997);
                                border-radius: 50%;
                                color: white;
                            }
                            .contact-label {
                                color: #4a5568;
                                font-weight: 600;
                                font-size: 14px;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            }
                            .contact-value {
                                color: #155724;
                                font-weight: 700;
                                font-size: 18px;
                                font-family: 'Courier New', monospace;
                                background: #f8f9fa;
                                padding: 8px 12px;
                                border-radius: 8px;
                                border: 1px solid #e9ecef;
                            }
                            .warning-card {
                                background: linear-gradient(135deg, #fff3cd, #ffffff);
                                border: 2px solid #ffc107;
                                border-radius: 15px;
                                padding: 20px;
                                margin: 20px 0;
                                box-shadow: 0 8px 25px rgba(255, 193, 7, 0.1);
                            }
                            .warning-icon {
                                font-size: 24px;
                                margin-bottom: 10px;
                            }
                            .warning-text {
                                color: #856404;
                                font-weight: 500;
                                line-height: 1.5;
                            }
                            .close-btn {
                                background: linear-gradient(135deg, #6c757d, #495057);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 12px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                                margin-top: 20px;
                            }
                            .close-btn:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
                            }
                        </style>
                        
                        <div class="unlocked-header">
                            <h3 class="unlocked-title">
                                🔓 聯絡資訊已解鎖
                            </h3>
                        </div>
                        
                        <div class="unlocked-body modal-content" style="max-height: calc(80vh - 120px); overflow-y: auto;">
                            <div class="contact-info-card">
                                <div class="contact-item">
                                    <div class="contact-left">
                                        <div class="contact-icon">📞</div>
                                        <span class="contact-label">聯絡電話</span>
                                    </div>
                                    <span class="contact-value">${phone}</span>
                                </div>
                                ${lineId ? `<div class="contact-item">
                                    <div class="contact-left">
                                        <div class="contact-icon">💬</div>
                                        <span class="contact-label">LINE ID</span>
                                    </div>
                                    <span class="contact-value">${lineId}</span>
                                </div>` : ''}
                            </div>
                            
                            <div class="warning-card">
                                <div class="warning-icon">⚠️</div>
                                <div class="warning-text">
                                    <strong>重要提醒：</strong><br>
                                    請記得至 BNI 系統 KEY 引薦對象！
                                </div>
                            </div>
                            
                            <button class="close-btn" onclick="closeContactConfirm()">
                                ✅ 我知道了
                            </button>
                        </div>
                    `;
                    
                    // 同時更新頁面上的聯絡資訊顯示
                    if (phone) {
                        updateContactDisplay('phone', phone, serviceItem, referrerCode);
                    }
                    if (lineId) {
                        updateContactDisplay('lineid', lineId, serviceItem, referrerCode);
                    }
                }
            }
        }
        
        // 顯示使用記錄（從 Google Sheets 讀取）
        async function showAccessLogs() {
            // 創建記錄查看容器
            const logsContainer = document.createElement('div');
            logsContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            const logsDialog = document.createElement('div');
            logsDialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            // 顯示載入中
            logsDialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">📋 聯絡資訊使用記錄</h3>
                    <button onclick="closeAccessLogs()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    🔄 正在載入使用記錄...
                </div>
            `;
            
            logsContainer.appendChild(logsDialog);
            document.body.appendChild(logsContainer);
            
            // 從 Google Sheets 讀取使用記錄（只讀取 Google Sheets 的資料）
            let accessLogs = [];
            try {
                const logsResult = await loadAccessLogsFromSheets();
                if (logsResult.success && logsResult.data) {
                    accessLogs = logsResult.data;
                    console.log(`✅ 成功從 Google Sheets 讀取 ${accessLogs.length} 筆使用記錄`);
                } else {
                    console.warn('⚠️ 從 Google Sheets 讀取使用記錄失敗');
                    accessLogs = [];
                }
            } catch (error) {
                console.error('載入使用記錄失敗:', error);
                accessLogs = [];
            }
            
            // 更新顯示內容
            let logsHTML = `
                <style>
                    .logs-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #e9ecef;
                    }
                    .logs-title {
                        margin: 0;
                        color: #333;
                        font-size: 20px;
                        font-weight: 700;
                    }
                    .logs-actions {
                        display: flex;
                        gap: 10px;
                        align-items: center;
                    }
                    .refresh-btn {
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                    }
                    .refresh-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    }
                    .refresh-btn:active {
                        transform: translateY(0);
                    }
                    .close-log-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: all 0.3s ease;
                    }
                    .close-log-btn:hover {
                        background: #f1f3f4;
                        color: #333;
                    }
                    .logs-stats {
                        margin-bottom: 15px;
                        padding: 12px;
                        background: linear-gradient(135deg, #f8f9ff, #ffffff);
                        border-radius: 8px;
                        border-left: 4px solid #667eea;
                        color: #666;
                        font-weight: 600;
                    }
                </style>
                <div class="logs-header">
                    <h3 class="logs-title">📋 聯絡資訊使用記錄</h3>
                    <div class="logs-actions">
                        <button class="refresh-btn" onclick="refreshAccessLogs()" title="重新載入記錄">
                            🔄 重新載入
                        </button>
                        <button class="close-log-btn" onclick="closeAccessLogs()" title="關閉">×</button>
                    </div>
                </div>
                <div class="logs-stats">
                    總共 ${accessLogs.length} 筆使用記錄
                </div>
            `;
            
            if (accessLogs.length > 0) {
                logsHTML += '<div style="max-height: 400px; overflow-y: auto;">';
                accessLogs.reverse().forEach((log, index) => {
                    // 處理時間格式（可能是字串或 ISO 格式）
                    let accessTime;
                    try {
                        if (log.accessTime) {
                            accessTime = new Date(log.accessTime).toLocaleString('zh-TW');
                        } else {
                            accessTime = '未知時間';
                        }
                    } catch (e) {
                        accessTime = log.accessTime || '未知時間';
                    }
                    // 從記錄中獲取 phone 和 lineId（如果有的話）
                    const phone = log.phone || '';
                    const lineId = log.lineId || '';
                    const hasContactInfo = phone || lineId || log.contactValue;
                    const logIndex = accessLogs.length - index - 1; // 用於解鎖時傳遞正確的索引
                    
                    logsHTML += `
                        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <strong style="color: #333;">記錄 #${accessLogs.length - index}</strong>
                                <span style="font-size: 12px; color: #666;">${accessTime}</span>
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                <strong>服務項目：</strong>${log.serviceItem}<br>
                                <strong>引薦人：</strong>${log.referrerCode}<br>
                                <strong>查看類型：</strong>${
                                    log.accessType === 'phone' ? '電話' : 
                                    log.accessType === 'lineid' ? 'LINE ID' : 
                                    log.accessType === 'contact' ? '聯絡資訊' : 
                                    '聯絡資訊'
                                }<br>
                                ${log.memberCode ? `<strong>成員編號：</strong>${log.memberCode}<br>` : ''}
                                <strong>瀏覽器：</strong>${log.userAgent ? log.userAgent.substring(0, 50) + '...' : '未知'}
                            </div>
                            ${hasContactInfo ? `
                                <div style="margin-top: 10px; text-align: center;">
                                    <button onclick="unlockContactFromLog(${logIndex})" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
                                        🔓 解鎖查看聯絡資訊
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                logsHTML += '</div>';
            } else {
                logsHTML += '<div style="text-align: center; color: #666; padding: 40px;">暫無使用記錄</div>';
            }
            
            logsDialog.innerHTML = logsHTML;
            logsContainer.appendChild(logsDialog);
            document.body.appendChild(logsContainer);
        }
        
        // 關閉使用記錄
        function closeAccessLogs() {
            const logsContainer = document.querySelector('div[style*="z-index: 2000"]');
            if (logsContainer) {
                logsContainer.remove();
            }
        }
        
        // 重新載入使用記錄
        async function refreshAccessLogs() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const logsDialog = document.querySelector('div[style*="max-width: 800px"]');
            
            if (!refreshBtn || !logsDialog) return;
            
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '🔄 載入中...';
            refreshBtn.disabled = true;
            
            // 顯示載入狀態
            const statsDiv = logsDialog.querySelector('.logs-stats');
            const logsContainer = logsDialog.querySelector('div[style*="max-height: 400px"]') || 
                                  logsDialog.querySelector('div[style*="text-align: center"]');
            
            if (statsDiv) {
                statsDiv.innerHTML = '🔄 正在重新載入使用記錄...';
            }
            
            try {
                // 從 Google Sheets 重新讀取使用記錄
                const logsResult = await loadAccessLogsFromSheets();
                const accessLogs = (logsResult.success && logsResult.data) ? logsResult.data : [];
                
                console.log(`✅ 成功重新載入 ${accessLogs.length} 筆使用記錄`);
                
                // 更新統計資訊
                if (statsDiv) {
                    statsDiv.innerHTML = `總共 ${accessLogs.length} 筆使用記錄`;
                }
                
                // 更新記錄列表
                if (logsContainer) {
                    if (accessLogs.length > 0) {
                        let logsHTML = '<div style="max-height: 400px; overflow-y: auto;">';
                        accessLogs.reverse().forEach((log, index) => {
                            let accessTime;
                            try {
                                accessTime = log.accessTime ? new Date(log.accessTime).toLocaleString('zh-TW') : '未知時間';
                            } catch (e) {
                                accessTime = log.accessTime || '未知時間';
                            }
                            
                            const phone = log.phone || '';
                            const lineId = log.lineId || '';
                            const hasContactInfo = phone || lineId || log.contactValue;
                            const logIndex = accessLogs.length - index - 1;
                            
                            logsHTML += `
                                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <strong style="color: #333;">記錄 #${accessLogs.length - index}</strong>
                                        <span style="font-size: 12px; color: #666;">${accessTime}</span>
                                    </div>
                                    <div style="font-size: 14px; color: #666;">
                                        <strong>服務項目：</strong>${log.serviceItem || '未知'}<br>
                                        <strong>引薦人：</strong>${log.referrerCode || '未知'}<br>
                                        <strong>查看類型：</strong>${
                                            log.accessType === 'phone' ? '電話' : 
                                            log.accessType === 'lineid' ? 'LINE ID' : 
                                            log.accessType === 'contact' ? '聯絡資訊' : 
                                            '聯絡資訊'
                                        }<br>
                                        ${log.memberCode ? `<strong>成員編號：</strong>${log.memberCode}<br>` : ''}
                                        <strong>瀏覽器：</strong>${log.userAgent ? log.userAgent.substring(0, 50) + '...' : '未知'}
                                    </div>
                                    ${hasContactInfo ? `
                                        <div style="margin-top: 10px; text-align: center;">
                                            <button onclick="unlockContactFromLog(${logIndex})" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
                                                🔓 解鎖查看聯絡資訊
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        logsHTML += '</div>';
                        logsContainer.outerHTML = logsHTML;
                    } else {
                        logsContainer.outerHTML = '<div style="text-align: center; color: #666; padding: 40px;">暫無使用記錄</div>';
                    }
                }
                
            } catch (error) {
                console.error('重新載入使用記錄失敗:', error);
                if (statsDiv) {
                    statsDiv.innerHTML = '❌ 載入失敗，請稍後再試';
                }
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }
        
        // 從記錄解鎖聯絡資訊
        async function unlockContactFromLog(logIndex) {
            try {
                const accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
                const reversedLogs = [...accessLogs].reverse();
                const log = reversedLogs[logIndex];
                
                if (!log) {
                    alert('找不到該筆記錄');
                    return;
                }
                
                // 獲取記錄中的聯絡資訊
                let phone = log.phone || '';
                let lineId = log.lineId || '';
                const serviceItem = log.serviceItem || '';
                const referrerCode = log.referrerCode || '';
                
                // 如果沒有直接保存 phone/lineId，嘗試從 contactValue 解析
                if (!phone && !lineId && log.contactValue) {
                    const contactValue = log.contactValue;
                    // 解析格式：電話：xxx | LINE ID：yyy 或 電話：xxx LINE ID：yyy
                    const phoneMatch = contactValue.match(/電話[：:]\s*([^|]+?)(?:\s*\||$)/);
                    const lineIdMatch = contactValue.match(/LINE\s*ID[：:]\s*([^|]+?)(?:\s*\||$)/);
                    if (phoneMatch) phone = phoneMatch[1].trim();
                    if (lineIdMatch) lineId = lineIdMatch[1].trim();
                    
                    // 如果還是沒有解析到，嘗試簡單的字串匹配（適用於只有電話或只有 LINE ID 的情況）
                    if (!phone && !lineId) {
                        // 如果 contactValue 看起來像是電話號碼
                        if (/^[\d\-()+\s]+$/.test(contactValue.trim())) {
                            phone = contactValue.trim();
                        } else {
                            // 否則當作 LINE ID
                            lineId = contactValue.trim();
                        }
                    }
                }
                
                if (!phone && !lineId) {
                    alert('該記錄中沒有聯絡資訊');
                    return;
                }
                
                // 關閉使用記錄彈窗
                closeAccessLogs();
                
                // 重新觸發完整的查看聯絡資訊流程（包含隱私保護確認）
                // 成員編號輸入框保持清空，方便不同的人填寫自己的編號
                if (phone && lineId) {
                    // 如果有電話和 LINE ID，使用完整的查看功能
                    showAllContactDetails(phone, lineId, serviceItem, referrerCode);
                } else if (phone) {
                    // 只有電話 - 顯示隱私保護確認彈窗
                    showContactDetails('phone', phone, serviceItem, referrerCode);
                } else if (lineId) {
                    // 只有 LINE ID - 顯示隱私保護確認彈窗
                    showContactDetails('lineid', lineId, serviceItem, referrerCode);
                }
                
            } catch (error) {
                console.error('解鎖聯絡資訊失敗:', error);
                alert('解鎖失敗：' + error.message);
            }
        }
        
        // 快速解鎖聯絡資訊（用於只有電話或只有 LINE ID 的情況）
        async function quickUnlockContact(type, value, serviceItem, referrerCode, memberCode) {
            try {
                // 如果是電話號碼，先格式化
                const formattedValue = type === 'phone' ? formatPhoneNumber(value) : value;
                
                // 記錄使用資訊
                const userInfo = {
                    accessTime: new Date().toISOString(),
                    accessType: type,
                    contactValue: formattedValue,
                    phone: type === 'phone' ? formattedValue : '',
                    lineId: type === 'lineid' ? formattedValue : '',
                    serviceItem: serviceItem,
                    referrerCode: referrerCode,
                    memberCode: memberCode,
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                };
                
                // 保存到本地存儲
                let accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
                accessLogs.push(userInfo);
                localStorage.setItem('contactAccessLogs', JSON.stringify(accessLogs));
                
                // 提交到 Google Sheets
                await handleAccessLogSubmission(userInfo);
                
                // 顯示聯絡資訊
                const typeText = type === 'phone' ? '電話' : 'LINE ID';
                alert(`${typeText}：${value}\n\n✅ 使用記錄已記錄\n\n⚠️ 請記得至 BNI 系統 KEY 引薦對象！`);
                
            } catch (error) {
                console.error('快速解鎖失敗:', error);
                alert('解鎖失敗：' + error.message);
            }
        }
        
        // 匯出使用記錄
        function exportAccessLogs() {
            const accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
            
            // 確定查看類型顯示文字
            const getAccessTypeText = (accessType) => {
                if (accessType === 'phone') return '電話';
                if (accessType === 'lineid') return 'LINE ID';
                if (accessType === 'contact') return '聯絡資訊';
                return '聯絡資訊';
            };
            
            const csvContent = [
                '時間,服務項目,引薦人,成員編號,查看類型,聯絡資訊,瀏覽器資訊',
                ...accessLogs.map(log => 
                    `${new Date(log.accessTime).toLocaleString('zh-TW')},"${log.serviceItem}","${log.referrerCode}","${log.memberCode || ''}","${getAccessTypeText(log.accessType)}","${log.contactValue}","${log.userAgent || ''}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `聯絡資訊使用記錄_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // 清除使用記錄
        function clearAccessLogs() {
            if (confirm('確定要清除所有使用記錄嗎？此操作無法復原。')) {
                localStorage.removeItem('contactAccessLogs');
                alert('使用記錄已清除');
                closeAccessLogs();
            }
        }
        
        // Google Sheets API 整合功能
        async function submitToGoogleSheets(data, sheetType) {
            try {
                // 優先使用 Apps Script Web App
                if (SHEET_CONFIG.APPS_SCRIPT_URL && SHEET_CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL') {
                    return await submitToAppsScript(data, sheetType);
                }
                
                // 備用：使用傳統 Google Sheets API
                const sheetId = getSheetId(sheetType);
                if (!sheetId || sheetId === 'YOUR_VENDOR_SHEET_ID') {
                    console.warn('Google Sheets 未設定，資料僅儲存在本地');
                    return false;
                }
                
                // 根據資料類型選擇工作表名稱
                const sheetName = sheetType === 'referral' ? '引薦登記' : '使用記錄';
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}:append?valueInputOption=RAW&key=${SHEET_CONFIG.API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: [data]
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`${sheetType} 資料已成功提交到 Google Sheets`);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error(`Google Sheets API 錯誤詳情:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
            } catch (error) {
                console.error(`提交到 Google Sheets 失敗:`, error);
                return false;
            }
        }
        
        // 使用 Apps Script Web App 提交資料
        async function submitToAppsScript(data, sheetType) {
            try {
                console.log(`🚀 開始提交 ${sheetType} 資料到 Apps Script...`);
                console.log('📋 原始資料:', data);
                
                const actionMap = {
                    'referral': 'addReferral', 
                    'access_log': 'addAccessLog'
                };
                
                const action = actionMap[sheetType];
                if (!action) {
                    throw new Error(`未知的資料類型: ${sheetType}`);
                }
                
                // 準備提交資料
                let requestData;
                switch (sheetType) {
                    case 'referral':
                        requestData = {
                            action: 'addReferral',
                            referralData: {
                                serviceItem: data[1],      // 被引薦服務項目
                                referrerCode: data[2],     // 引薦人（會員編號）
                                companyName: data[3],      // 被引薦廠商名稱
                                phone: data[4],            // 廠商聯絡電話
                                lineId: data[5],           // 廠商LINE ID
                                area: data[6],             // 廠商服務區域
                                note: data[7]              // 引薦備註
                            }
                        };
                        break;
                    case 'access_log':
                        requestData = {
                            action: 'addAccessLog',
                            accessData: {
                                accessTime: data[0],
                                serviceItem: data[1],
                                referrerCode: data[2],
                                memberCode: data[3],  // 成員編號
                                accessType: data[4] === '電話' ? 'phone' : 'lineid',
                                contactValue: data[5],
                                userAgent: data[6]
                            }
                        };
                        break;
                }
                
                console.log('📦 準備提交的請求資料:', requestData);
                console.log('🔗 Apps Script URL:', SHEET_CONFIG.APPS_SCRIPT_URL);
                
                // 檢查 URL 是否有效
                if (!SHEET_CONFIG.APPS_SCRIPT_URL || SHEET_CONFIG.APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL') {
                    console.warn('⚠️ Apps Script URL 未配置，將使用本地儲存');
                    return false;
                }
                
                // 嘗試使用 fetch API
                try {
                    console.log('📡 發送 POST 請求到 Apps Script...');
                    const response = await fetch(SHEET_CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    console.log('📨 回應狀態:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`✅ ${sheetType} 資料已成功提交到 Apps Script`);
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.error(`❌ Apps Script 回應錯誤:`, errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                    }
                } catch (fetchError) {
                    console.warn('⚠️ Fetch API 失敗，嘗試使用表單提交:', fetchError.message);
                    console.error('Fetch 錯誤詳情:', fetchError);
                    return submitWithForm(requestData, sheetType);
                }
            } catch (error) {
                console.error(`❌ 提交到 Apps Script 失敗:`, error);
                console.error('錯誤堆疊:', error.stack);
                return false;
            }
        }
        
        // 使用表單提交方式（避免CORS問題）
        function submitWithForm(requestData, sheetType) {
            try {
                console.log(`📝 使用表單提交 ${sheetType} 資料...`);
                console.log('📦 表單提交的資料:', requestData);
                
                // 方法1：嘗試使用隱藏iframe
                try {
                    console.log('🔲 創建隱藏 iframe...');
                    const iframe = document.createElement('iframe');
                    iframe.name = 'hiddenSubmitFrame_' + Date.now();
                    iframe.style.display = 'none';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                    
                    console.log('📝 創建表單...');
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = SHEET_CONFIG.APPS_SCRIPT_URL;
                    form.target = iframe.name;
                    form.style.display = 'none';
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'data';
                    input.value = JSON.stringify(requestData);
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    
                    console.log('🚀 提交表單到:', SHEET_CONFIG.APPS_SCRIPT_URL);
                    
                    // 監聽 iframe 載入完成（但可能因為CORS不會觸發）
                    iframe.onload = function() {
                        console.log('✅ iframe 已載入，表單提交可能成功');
                        console.log('iframe src:', iframe.src);
                    };
                    
                    // 監聽 iframe 錯誤
                    iframe.onerror = function(error) {
                        console.warn('⚠️ iframe 載入錯誤:', error);
                    };
                    
                    // 提交表單
                    form.submit();
                    
                    // 清理DOM元素（延遲清理以確保提交完成）
                    setTimeout(() => {
                        try {
                            if (document.body.contains(form)) {
                                document.body.removeChild(form);
                            }
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                        } catch (cleanupError) {
                            console.warn('清理DOM元素時發生錯誤:', cleanupError);
                        }
                    }, 2000);
                    
                    console.log(`✅ ${sheetType} 資料已通過iframe表單提交`);
                    console.log('📊 請在 Google Sheets 中檢查資料是否已成功寫入');
                    return true;
                } catch (iframeError) {
                    console.warn('⚠️ iframe提交失敗，嘗試直接表單提交:', iframeError);
                    
                    // 方法2：在隱藏 iframe 中提交（不會跳出）
                    const iframe = document.createElement('iframe');
                    iframe.name = 'hidden_' + Date.now();
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = SHEET_CONFIG.APPS_SCRIPT_URL;
                    form.target = iframe.name;
                    form.style.display = 'none';
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'data';
                    input.value = JSON.stringify(requestData);
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                    
                    // 清理表單和 iframe
                    setTimeout(() => {
                        try {
                            if (document.body.contains(form)) {
                                document.body.removeChild(form);
                            }
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                        } catch (cleanupError) {
                            console.warn('清理表單時發生錯誤:', cleanupError);
                        }
                    }, 1000);
                    
                    console.log(`✅ ${sheetType} 資料已通過隱藏 iframe 提交（不會跳出）`);
                    return true;
                }
            } catch (error) {
                console.error(`❌ 表單提交失敗:`, error);
                return false;
            }
        }
        
        // 獲取工作表ID
        function getSheetId(sheetType) {
            switch (sheetType) {
                case 'referral':
                    return SHEET_CONFIG.REFERRAL_SHEET_ID;
                case 'access_log':
                    return SHEET_CONFIG.ACCESS_LOG_SHEET_ID;
                default:
                    return null;
            }
        }
        
        
        // 處理引薦登記提交
        async function handleReferralRegistration(formData) {
            try {
                console.log('📝 開始處理引薦登記，表單資料:', formData);
                
                // 資料驗證
                if (!validateReferralData(formData)) {
                    console.error('❌ 資料驗證失敗');
                    return false;
                }
                console.log('✅ 資料驗證通過');
                
                // 準備提交資料 - 修正欄位對應
                // 格式化電話號碼（不足10碼前面補0）
                const formattedPhone = formatPhoneNumber(formData.companyPhone);
                
                const referralData = [
                    new Date().toISOString(),                    // 引薦日期
                    formData.referredService || '',              // 被引薦服務項目
                    formData.referrerCode || '',                 // 引薦人（會員編號）
                    formData.referredCompany || '',              // 被引薦廠商名稱
                    formattedPhone,                              // 廠商聯絡電話（已格式化）
                    formData.companyLineId || '',                // 廠商LINE ID
                    formData.companyArea || '',                  // 廠商服務區域
                    formData.referralNote || ''                  // 引薦備註
                ];
                
                console.log('📤 準備提交的引薦資料:', referralData);
                console.log('🔗 Apps Script URL:', SHEET_CONFIG.APPS_SCRIPT_URL);
                
                // 提交到 Google Sheets
                const success = await submitToGoogleSheets(referralData, 'referral');
                
                if (success) {
                    console.log('✅ 引薦資料已成功提交到 Google Sheets');
                    return true;
                } else {
                    console.error('❌ 引薦資料提交失敗');
                    return false;
                }
            } catch (error) {
                console.error('❌ 引薦登記處理失敗:', error);
                console.error('錯誤詳情:', error.stack);
                alert('引薦登記失敗：' + error.message);
                return false;
            }
        }
        
        // 處理使用記錄提交
        async function handleAccessLogSubmission(accessData) {
            try {
                console.log('開始提交使用記錄:', accessData);
                
                // 確定查看類型顯示文字
                let accessTypeText = '聯絡資訊';
                if (accessData.accessType === 'phone') {
                    accessTypeText = '電話';
                } else if (accessData.accessType === 'lineid') {
                    accessTypeText = 'LINE ID';
                } else if (accessData.accessType === 'contact') {
                    accessTypeText = '聯絡資訊';
                }
                
                // 準備提交資料（添加成員編號欄位）
                const logData = [
                    new Date(accessData.accessTime).toLocaleString('zh-TW'),
                    accessData.serviceItem || '',
                    accessData.referrerCode || '',
                    accessData.memberCode || '',  // 添加成員編號
                    accessTypeText,
                    accessData.contactValue || '',
                    accessData.userAgent || ''
                ];
                
                console.log('準備提交的使用記錄資料:', logData);
                
                // 提交到 Google Sheets
                const success = await submitToGoogleSheets(logData, 'access_log');
                
                if (success) {
                    console.log('✅ 使用記錄已成功提交到 Google Sheets');
                } else {
                    console.error('❌ 使用記錄提交失敗');
                }
                
                return success;
            } catch (error) {
                console.error('使用記錄提交失敗:', error);
                return false;
            }
        }
        
        
        // 引薦資料驗證
        function validateReferralData(data) {
            const requiredFields = ['referrerCode', 'referredCompany', 'companyPhone'];
            
            for (const field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    alert(`請填寫 ${getFieldDisplayName(field)}`);
                    return false;
                }
            }
            
            // 電話號碼格式驗證
            if (!isValidPhone(data.companyPhone)) {
                alert('請輸入有效的電話號碼');
                return false;
            }
            
            return true;
        }
        
        // 欄位顯示名稱
        function getFieldDisplayName(field) {
            const fieldNames = {
                'companyName': '公司名稱',
                'contactName': '聯絡人姓名',
                'phone': '聯絡電話',
                'email': '電子郵件',
                'referrerCode': '引薦人編號',
                'serviceItem': '服務項目',
                'referredCompany': '被引薦廠商名稱',
                'companyPhone': '廠商聯絡電話',
                'referredService': '被引薦服務項目'
            };
            return fieldNames[field] || field;
        }
        
        // 電話號碼驗證
        function isValidPhone(phone) {
            const phoneRegex = /^[0-9\-\+\(\)\s]{8,15}$/;
            return phoneRegex.test(phone);
        }
        
        // 格式化電話號碼（不足10碼前面補0）
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            
            // 移除所有非數字字符
            const digits = phone.replace(/\D/g, '');
            
            // 如果數字長度為9碼，前面補0
            if (digits.length === 9) {
                return '0' + digits;
            }
            
            // 返回原始號碼（移除格式化字符）
            return digits;
        }
        
        // 電子郵件驗證
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!query) {
                clearHighlights();
                closeSearchResults();
                return;
            }
            
            // 顯示搜索加載動畫
            showSearchLoading();
            
            // 使用防抖優化性能
            clearTimeout(handleSearch.timeout);
            handleSearch.timeout = setTimeout(() => {
                performSearch(query);
            }, 150);
        }
        
        function performSearch(query) {
            // 搜尋所有服務項目（增強版 - 支援同義詞搜索）
            const results = [];
            const categories = mindmapData["2025年 華地產鑽石分會引薦平台"];
            
            // 獲取擴展的搜索詞（包含同義詞）
            const expandedTerms = getExpandedSearchTerms(query);
            
            for (const [categoryName, subCategories] of Object.entries(categories)) {
                for (const [subCategoryName, items] of Object.entries(subCategories)) {
                    items.forEach(item => {
                        const itemLower = item.toLowerCase();
                        let bestScore = 0;
                        let matchedTerm = '';
                        
                        // 檢查每個擴展搜索詞
                        for (const term of expandedTerms) {
                            if (itemLower.includes(term)) {
                                let score = 0;
                                
                                if (itemLower === term) {
                                    score = 100; // 完全匹配
                                } else if (itemLower.startsWith(term)) {
                                    score = 80; // 開頭匹配
                                } else if (itemLower.includes(term)) {
                                    score = 60; // 部分匹配
                                }
                                
                                // 如果原始查詢匹配，給予額外加分
                                if (term === query && score > 0) {
                                    score += 10;
                                }
                                
                                if (score > bestScore) {
                                    bestScore = score;
                                    matchedTerm = term;
                                }
                            }
                        }
                        
                        // 如果找到匹配，添加到結果中
                        if (bestScore > 0) {
                            results.push({
                                category: categoryName,
                                subCategory: subCategoryName,
                                item: item,
                                score: bestScore,
                                matchedTerm: matchedTerm
                            });
                        }
                    });
                }
            }
            
            // 按分數排序
            results.sort((a, b) => b.score - a.score);
            
            // 顯示搜尋結果
            if (results.length > 0) {
                addToSearchHistory(query);
                showSearchResults(results, query);
            } else {
                showNoResults(query);
            }
            
            // 重置選中索引
            selectedResultIndex = -1;
        }
        
        // 顯示搜索加載動畫
        function showSearchLoading() {
            const oldResults = document.getElementById('searchResults');
            if (oldResults) oldResults.remove();
            
            const loadingContainer = document.createElement('div');
            loadingContainer.id = 'searchResults';
            loadingContainer.style.cssText = `
                position: fixed;
                top: 85px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 600px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                padding: 30px;
                text-align: center;
            `;
            
            loadingContainer.innerHTML = `
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top: 15px; color: #666; font-size: 14px;">搜尋中...</div>
            `;
            
            document.body.appendChild(loadingContainer);
        }
        
        // 顯示無結果提示
        function showNoResults(query) {
            const oldResults = document.getElementById('searchResults');
            if (oldResults) oldResults.remove();
            
            const noResultsContainer = document.createElement('div');
            noResultsContainer.id = 'searchResults';
            noResultsContainer.style.cssText = `
                position: fixed;
                top: 85px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 600px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                padding: 30px;
                text-align: center;
            `;
            
            noResultsContainer.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">🔍</div>
                <div style="color: #666; font-size: 16px; margin-bottom: 10px;">找不到「${query}」相關服務</div>
                <div style="color: #999; font-size: 13px;">試試其他關鍵字，或查看下方熱門搜索</div>
            `;
            
            document.body.appendChild(noResultsContainer);
        }
        
        // 顯示搜尋結果
        function showSearchResults(results, query) {
            // 移除舊的結果
            const oldResults = document.getElementById('searchResults');
            if (oldResults) {
                oldResults.remove();
            }
            
            // 創建結果容器
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'searchResults';
            resultsContainer.style.cssText = `
                position: fixed;
                top: 85px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 600px;
                max-height: 400px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                overflow-y: auto;
                padding: 20px;
            `;
            
            let resultsHTML = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                    <strong style="color: #667eea; font-size: 16px;">🔍 搜尋結果：找到 ${results.length} 項服務</strong>
                </div>
            `;
            
            results.forEach((result, index) => {
                // 使用編碼避免特殊字符問題
                const encodedItem = encodeURIComponent(result.item);
                const encodedCategory = encodeURIComponent(result.category);
                const encodedSubCategory = encodeURIComponent(result.subCategory);
                
                // 高亮關鍵字
                const highlightedItem = highlightKeyword(result.item, query);
                const highlightedCategory = highlightKeyword(result.category, query);
                const highlightedSubCategory = highlightKeyword(result.subCategory, query);
                
                resultsHTML += `
                    <div class="search-result-item" onclick="selectSearchResult('${encodedItem}', '${encodedCategory}', '${encodedSubCategory}')" 
                         style="padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid #667eea;"
                         onmouseenter="this.style.background='#e3e8ff'; this.style.transform='translateX(5px)'"
                         onmouseleave="this.style.background='#f8f9fa'; this.style.transform='translateX(0)'">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${highlightedItem}</div>
                        <div style="font-size: 12px; color: #666;">${highlightedCategory} > ${highlightedSubCategory}</div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
            document.body.appendChild(resultsContainer);
        }
        
        // 關閉搜尋結果
        function closeSearchResults() {
            const results = document.getElementById('searchResults');
            if (results) {
                results.remove();
            }
        }
        
        // 選擇搜尋結果
        function selectSearchResult(item, category, subCategory) {
            closeSearchResults();
            // 解碼參數
            const decodedItem = decodeURIComponent(item);
            const decodedCategory = decodeURIComponent(category);
            const decodedSubCategory = decodeURIComponent(subCategory);
            // 顯示該項目的詳細資訊
            showDetails(decodedItem, decodedCategory, decodedSubCategory);
        }

        function clearHighlights() {
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(highlight => {
                highlight.outerHTML = highlight.textContent;
            });
        }
        
        // 一鍵收合所有展開的分類
        function collapseAllCategories() {
            // 移除所有子分類容器
            const subContainers = document.querySelectorAll('.sub-categories');
            subContainers.forEach(container => {
                container.style.opacity = '0';
                container.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    container.remove();
                }, 300);
            });
            
            // 顯示成功提示
            showNotification('✅ 已收合所有展開的分類', 'success');
        }
        
        // 顯示通知訊息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : '#2196f3'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                font-size: 14px;
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 2000);
        }

        // ===== 增強搜索功能 =====
        
        // 搜索歷史管理
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let selectedResultIndex = -1;
        
        // 關鍵詞同義詞映射（讓不同稱呼都能搜尋到相同服務）
        const searchSynonyms = {
            "房仲": ["仲介"],
            "仲介": ["房仲", "住宅仲介", "商業不動產"],
            "住宅仲介": ["房仲", "仲介"],
            "商辦仲介": ["仲介", "商業不動產"],
            "建築師": ["建築設計"],
            "建築設計": ["建築師"],
            "室內設計": ["室內規劃", "空間設計"],
            "BIM": ["建築資訊模型", "BIM建模"],
            "代書": ["地政士"],
            "地政士": ["代書"],
            "物業": ["物業管理", "社區管理"],
            "物業管理": ["物業", "社區管理"],
            "保全": ["安管", "安全維護"],
            "安管": ["保全", "安全維護"],
            "清潔": ["清潔服務", "打掃"],
            "清潔服務": ["清潔", "打掃"],
            "驗屋": ["驗屋服務", "房屋檢測", "專業服務與培訓"],
            "驗屋服務": ["驗屋", "房屋檢測", "專業服務與培訓"],
            "水電": ["水電工程", "水電安裝"],
            "水電工程": ["水電", "水電安裝"],
            "機電": ["機電工程", "機電設備"],
            "機電工程": ["機電", "機電設備"],
            "消防": ["消防工程", "消防設備"],
            "消防工程": ["消防", "消防設備"],
            "弱電": ["弱電工程", "監控系統"],
            "弱電工程": ["弱電", "監控系統"],
            "裝修": ["裝修工程", "室內裝修"],
            "裝修工程": ["裝修", "室內裝修"],
            "泥作": ["泥作工程", "泥工"],
            "泥作工程": ["泥作", "泥工"],
            "鐵工": ["鐵工工程", "鋼構"],
            "鐵工工程": ["鐵工", "鋼構"],
            "木工": ["木作工程", "木工裝潢"],
            "木作工程": ["木工", "木工裝潢"],
            "石材": ["石材工程", "石材安裝"],
            "石材工程": ["石材", "石材安裝"],
            "玻璃": ["玻璃工程", "玻璃安裝"],
            "玻璃工程": ["玻璃", "玻璃安裝"],
            "磁磚": ["磁磚工程", "磁磚鋪設"],
            "磁磚工程": ["磁磚", "磁磚鋪設"],
            "鋁門窗": ["鋁門窗工程", "鋁窗"],
            "鋁門窗工程": ["鋁門窗", "鋁窗"],
            "油漆": ["塗料工程", "油漆粉刷"],
            "塗料工程": ["油漆", "油漆粉刷"],
            "貸款": ["貸款服務", "房貸", "購屋貸款", "理財規劃與資金"],
            "貸款服務": ["貸款", "房貸", "理財規劃與資金"],
            "房貸": ["貸款", "貸款服務", "購屋貸款", "房貸轉增貸", "房貸代償", "理財規劃與資金"],
            "融資": ["建築融資", "開發融資"],
            "建築融資": ["融資", "開發融資"],
            "行銷": ["建案行銷", "數位行銷"],
            "建案行銷": ["行銷", "數位行銷"],
            "租賃": ["租賃服務", "租賃管理"],
            "租賃服務": ["租賃", "租賃管理"],
            "修繕": ["修繕服務", "維修"],
            "修繕服務": ["修繕", "維修"],
            "統包": ["統包工程"],
            "統包工程": ["統包"],
            "檢測": ["檢測服務", "房屋檢測", "專業服務"],
            "檢測服務": ["檢測", "房屋檢測", "專業服務"],
            "環境": ["環境治理", "專業服務"],
            "環境治理": ["環境", "專業服務"],
            "顧問": ["顧問服務", "專業服務"],
            "顧問服務": ["顧問", "專業服務"],
            "市場": ["市場研究", "專業服務"],
            "市場研究": ["市場", "專業服務"],
            "研究": ["市場研究", "專業服務"],
            "建材": ["建材供應"],
            "建材供應": ["建材"],
            "設備": ["施工設備"],
            "施工設備": ["設備"],
            "驗收": ["交付服務", "驗收流程"],
            "交付服務": ["驗收", "驗收流程"],
            "營造": ["營造管理", "營造商"],
            "營造管理": ["營造", "營造商"],
            "投資": ["不動產投資", "房產投資"],
            "不動產投資": ["投資", "房產投資"],
            "估價": ["鑑價服務", "不動產估價師"],
            "鑑價服務": ["估價", "不動產估價師"],
            "律師": ["法律服務", "專業服務"],
            "法律服務": ["律師", "專業服務"],
            "專業服務": ["法律服務", "法規諮詢", "驗屋服務", "人才培訓"],
            "法規": ["法規諮詢", "專業服務"],
            "法規諮詢": ["法規", "專業服務"],
            "人才": ["人才培訓", "專業服務"],
            "人才培訓": ["人才", "專業培訓", "專業服務"],
            "培訓": ["人才培訓", "專業培訓"],
            "會計師": ["稅務規劃", "會計"],
            "稅務規劃": ["會計師", "會計"],
            "SEO": ["SEO優化", "數位行銷"],
            "SEO優化": ["SEO", "數位行銷"],
            "廣告": ["Google廣告", "Facebook廣告", "數位行銷"],
            "Google廣告": ["廣告", "數位行銷"],
            "Facebook廣告": ["廣告", "數位行銷"],
            "攝影": ["建案攝影", "內容行銷"],
            "建案攝影": ["攝影", "內容行銷"],
            "影片": ["建案影片拍攝", "內容行銷"],
            "建案影片拍攝": ["影片", "內容行銷"],
            "分析": ["市場研究", "不動產市場分析"],
            "市場研究": ["分析", "不動產市場分析"],
            "實價": ["實價登錄查詢", "資訊平台"],
            "實價登錄查詢": ["實價", "資訊平台"],
            "591": ["591租屋網", "資訊平台"],
            "591租屋網": ["591", "資訊平台"],
            "維護": ["機電維護", "物業管理"],
            "機電維護": ["維護", "物業管理"],
            "保養": ["電梯保養", "空調保養", "機電維護"],
            "電梯保養": ["保養", "機電維護"],
            "空調保養": ["保養", "機電維護"],
            "保養": ["電梯保養", "空調保養", "機電維護"],
            "園藝": ["園藝維護", "園藝設計"],
            "園藝維護": ["園藝", "園藝設計"],
            "Airbnb": ["短租營運", "Airbnb代營運"],
            "短租營運": ["Airbnb", "Airbnb代營運"],
            "平台": ["物業管理系統", "租賃管理系統", "數位平台"],
            "物業管理系統": ["平台", "數位平台"],
            "租賃管理系統": ["平台", "數位平台"],
            "數位平台": ["平台", "物業管理系統"],
            "法拍": ["特殊渠道", "法拍"],
            "特殊渠道": ["法拍", "代銷"],
            "代銷": ["特殊渠道", "建案行銷"],
            "履約": ["履約保證", "交易服務"],
            "履約保證": ["履約", "交易服務"],
            "過戶": ["過戶服務", "交易服務"],
            "過戶服務": ["過戶", "交易服務"],
            "產權": ["產權調查", "交易服務"],
            "產權調查": ["產權", "交易服務"],
            "信託": ["價金信託", "不動產投資信託"],
            "價金信託": ["信託", "交易服務"],
            "不動產投資信託": ["信託", "不動產投資"],
            "危險": ["危險補強", "特殊工程"],
            "危險補強": ["危險", "特殊工程"],
            "智慧": ["智慧工程", "智慧家電"],
            "智慧工程": ["智慧", "智慧家電"],
            "IoT": ["IoT物聯網", "智慧工程"],
            "IoT物聯網": ["IoT", "智慧工程"],
            "物聯網": ["IoT物聯網", "智慧工程"],
            "自動化": ["自動化控制", "智慧工程"],
            "自動化控制": ["自動化", "智慧工程"],
            "門鎖": ["智慧門鎖", "弱電工程"],
            "智慧門鎖": ["門鎖", "弱電工程"],
            "監測": ["建築科技監測", "結構健康監測", "環境監測"],
            "建築科技監測": ["監測", "智慧工程"],
            "結構健康監測": ["監測", "智慧工程"],
            "環境監測": ["監測", "智慧工程"],
            "能耗": ["能耗分析", "智慧工程"],
            "能耗分析": ["能耗", "智慧工程"],
            "維護": ["預測性維護", "智慧工程"],
            "預測性維護": ["維護", "智慧工程"],
            "防水": ["防水工程", "防水補漏"],
            "防水工程": ["防水", "特殊工程"],
            "防水補漏": ["防水", "修繕服務"],
            "隔熱": ["防水隔熱", "特殊工程"],
            "防水隔熱": ["隔熱", "特殊工程"],
            "帷幕": ["帷幕牆工程", "特殊工程"],
            "帷幕牆工程": ["帷幕", "特殊工程"],
            "隔間": ["隔間工程", "裝修工程"],
            "隔間工程": ["隔間", "裝修工程"],
            "玻璃隔間": ["隔間", "玻璃工程"],
            "天花板": ["天花板工程", "裝修工程"],
            "天花板工程": ["天花板", "裝修工程"],
            "地板": ["地板工程", "實木地板"],
            "地板工程": ["地板", "裝修工程"],
            "實木地板": ["地板", "木作工程"],
            "油漆粉刷": ["油漆", "塗料工程"],
            "磁磚鋪設": ["磁磚", "磁磚工程"],
            "石材安裝": ["石材", "石材工程"],
            "玻璃安裝": ["玻璃", "玻璃工程"],
            "鋁窗": ["鋁窗安裝", "鋁門窗工程"],
            "鋁窗安裝": ["鋁窗", "鋁門窗工程"],
            "氣密窗": ["鋁窗", "鋁門窗工程"],
            "隔音窗": ["鋁窗", "鋁門窗工程"],
            "鋁門": ["鋁門製作", "鋁門窗工程"],
            "鋁門製作": ["鋁門", "鋁門窗工程"],
            "紗窗": ["紗窗安裝", "鋁門窗工程"],
            "紗窗安裝": ["紗窗", "鋁門窗工程"],
            "防水塗料": ["防水", "塗料工程"],
            "隔熱塗料": ["隔熱", "塗料工程"],
            "環保塗料": ["環保", "塗料工程"],
            "藝術塗料": ["泥作", "泥作工程"],
            "清水模": ["泥作", "泥作工程"],
            "仿古泥作": ["泥作", "泥作工程"],
            "室內泥作": ["泥作", "泥作工程"],
            "室外泥作": ["泥作", "泥作工程"],
            "鋼構": ["鋼構工程", "鐵工工程"],
            "鋼構工程": ["鋼構", "鐵工工程"],
            "金屬加工": ["鐵工", "鐵工工程"],
            "焊接": ["焊接修補", "鐵工工程"],
            "焊接修補": ["焊接", "鐵工工程"],
            "結構補強": ["補強", "鐵工工程"],
            "補強": ["結構補強", "鐵工工程"],
            "木工裝潢": ["木工", "木作工程"],
            "櫥櫃": ["櫥櫃製作", "木作工程"],
            "櫥櫃製作": ["櫥櫃", "木作工程"],
            "訂製櫥櫃": ["櫥櫃", "木作工程"],
            "系統家具": ["家具", "木作工程"],
            "訂製傢俱": ["傢俱", "室內設計"],
            "傢俱設計": ["傢俱", "室內設計"],
            "傢俱": ["訂製傢俱", "傢俱設計"],
            "訂製": ["訂製傢俱", "訂製櫥櫃"],
            "訂製傢俱": ["訂製", "室內設計"],
            "訂製櫥櫃": ["訂製", "木作工程"],
            "馬賽克": ["磁磚", "磁磚工程"],
            "大理石磚": ["磁磚", "磁磚工程"],
            "仿古磚": ["磁磚", "磁磚工程"],
            "大理石": ["石材", "石材工程"],
            "花崗岩": ["石材", "石材工程"],
            "人造石": ["石材", "石材工程"],
            "膠合玻璃": ["玻璃", "玻璃工程"],
            "強化玻璃": ["玻璃", "玻璃工程"],
            "給排水": ["給排水設計", "水電工程"],
            "給排水設計": ["給排水", "水電工程"],
            "瓦斯": ["瓦斯系統", "水電工程"],
            "瓦斯系統": ["瓦斯", "水電工程"],
            "熱水器": ["熱水器", "水電工程"],
            "淨水": ["淨水系統", "水電工程"],
            "淨水系統": ["淨水", "水電工程"],
            "水電安裝": ["水電", "水電工程"],
            "電梯": ["電梯", "機電工程"],
            "空調": ["空調系統", "空調安裝保養", "機電工程"],
            "空調系統": ["空調", "機電工程"],
            "空調安裝保養": ["空調", "機電工程"],
            "冷氣": ["冷氣安裝保養", "機電工程"],
            "冷氣安裝保養": ["冷氣", "機電工程"],
            "通風": ["通風系統", "機電工程"],
            "通風系統": ["通風", "機電工程"],
            "節能": ["節能設備", "機電工程"],
            "節能設備": ["節能", "機電工程"],
            "灑水": ["自動灑水", "消防工程"],
            "自動灑水": ["灑水", "消防工程"],
            "警報": ["警報系統", "消防工程"],
            "警報系統": ["警報", "消防工程"],
            "申報": ["消防申報", "消防工程"],
            "消防申報": ["申報", "消防工程"],
            "消防設備": ["消防", "消防工程"],
            "監控": ["監控系統", "弱電工程"],
            "監控系統": ["監控", "弱電工程"],
            "門禁": ["門禁系統", "弱電工程"],
            "門禁系統": ["門禁", "弱電工程"],
            "門禁管理": ["門禁", "物業管理"],
            "網路": ["網路架設", "弱電工程"],
            "網路架設": ["網路", "弱電工程"],
            "智慧系統": ["智慧", "弱電工程"],
            "BIM建模": ["BIM", "BIM服務"],
            "建築資訊模型": ["BIM", "BIM服務"],
            "3D": ["3D可視化", "BIM服務"],
            "3D可視化": ["3D", "BIM服務"],
            "碰撞": ["碰撞檢測", "BIM服務"],
            "碰撞檢測": ["碰撞", "BIM服務"],
            "協同": ["協同作業", "BIM服務"],
            "協同作業": ["協同", "BIM服務"],
            "營建": ["營建管理", "專案管理"],
            "營建管理": ["營建", "專案管理"],
            "時程": ["時程控管", "專案管理"],
            "時程控管": ["時程", "專案管理"],
            "成本": ["成本控管", "專案管理"],
            "成本控管": ["成本", "專案管理"],
            "品質": ["品質管理", "專案管理"],
            "品質管理": ["品質", "專案管理"],
            "風險": ["風險管理", "專案管理"],
            "風險管理": ["風險", "專案管理"],
            "檢測": ["房屋檢測", "檢測服務", "專業服務"],
            "房屋檢測": ["檢測", "檢測服務", "專業服務"],
            "結構檢測": ["檢測", "檢測服務"],
            "漏水": ["漏水檢測", "檢測服務"],
            "漏水檢測": ["漏水", "檢測服務"],
            "空氣": ["空氣品質檢測", "檢測服務"],
            "空氣品質檢測": ["空氣", "檢測服務"],
            "瑕疵": ["瑕疵檢測", "驗屋服務"],
            "瑕疵檢測": ["瑕疵", "驗屋服務"],
            "輻射": ["輻射檢測", "驗屋服務"],
            "輻射檢測": ["輻射", "驗屋服務"],
            "甲醛": ["甲醛檢測", "驗屋服務"],
            "甲醛檢測": ["甲醛", "驗屋服務"],
            "專業驗屋": ["驗屋", "驗屋服務"],
            "商業不動產": ["商辦", "仲介服務"],
            "商辦": ["商業不動產", "仲介服務"],
            "海外": ["海外不動產", "仲介服務"],
            "海外不動產": ["海外", "仲介服務"],
            "房產投資": ["投資", "仲介服務"],
            "特殊物件": ["特殊物件", "交易與資金"],
            "工業廠房": ["廠房", "特殊物件"],
            "廠房": ["工業廠房", "特殊物件"],
            "土地": ["土地買賣", "特殊物件"],
            "土地買賣": ["土地", "特殊物件"],
            "倉儲": ["倉儲用地", "特殊物件"],
            "倉儲用地": ["倉儲", "特殊物件"],
            "預售": ["預售屋", "特殊物件"],
            "預售屋": ["預售", "特殊物件"],
            "成屋": ["成屋", "特殊物件"],
            "代銷": ["代銷", "特殊渠道"],
            "標售": ["標售", "特殊渠道"],
            "都更": ["都更整合", "特殊渠道"],
            "都更整合": ["都更", "特殊渠道"],
            "危老": ["危老整合", "特殊渠道"],
            "危老整合": ["危老", "特殊渠道"],
            "土地開發": ["土地", "地政服務"],
            "地政服務": ["土地開發", "交易與資金"],
            "土地資產傳承": ["土地", "地政服務"],
            "買房": ["買房陪跑服務", "買房陪跑教練", "買房課程", "房屋買賣與交易"],
            "買房陪跑服務": ["買房", "買房陪跑教練", "買房課程", "專業服務與培訓", "培訓與顧問"],
            "買房陪跑教練": ["買房", "買房陪跑服務", "買房課程", "專業服務與培訓", "培訓與顧問"],
            "買房課程": ["買房", "買房陪跑服務", "買房陪跑教練", "專業服務與培訓", "培訓與顧問"],
            "陪跑": ["買房陪跑服務", "買房陪跑教練", "培訓與顧問"],
            "教練": ["買房陪跑教練", "買房陪跑服務", "培訓與顧問"],
            "課程": ["買房課程", "培訓與顧問", "專業服務與培訓"],
            "過戶": ["過戶服務", "交易服務"],
            "購屋": ["購屋貸款", "貸款服務"],
            "購屋貸款": ["購屋", "貸款服務"],
            "成屋貸款": ["成屋", "貸款服務"],
            "轉增貸": ["房貸轉增貸", "貸款服務"],
            "房貸轉增貸": ["轉增貸", "貸款服務"],
            "授信": ["銀行授信", "貸款服務"],
            "銀行授信": ["授信", "貸款服務"],
            "規劃": ["貸款規劃", "貸款服務"],
            "貸款規劃": ["規劃", "貸款服務"],
            "理財型": ["理財型房貸", "貸款服務"],
            "理財型房貸": ["理財型", "貸款服務"],
            "減壓": ["房貸減壓顧問", "貸款服務"],
            "房貸減壓顧問": ["減壓", "貸款服務"],
            "開發": ["開發融資", "建築融資"],
            "開發融資": ["開發", "建築融資"],
            "興建": ["興建資金", "建築融資"],
            "興建資金": ["興建", "建築融資"],
            "週轉": ["週轉金", "建築融資"],
            "週轉金": ["週轉", "建築融資"],
            "工程款": ["工程款融資", "建築融資"],
            "工程款融資": ["工程款", "建築融資"],
            "REITs": ["REITs", "不動產投資"],
            "基金": ["不動產基金", "不動產投資"],
            "不動產基金": ["基金", "不動產投資"],
            "私募": ["私募股權", "不動產投資"],
            "私募股權": ["私募", "不動產投資"],
            "家族": ["家族辦公室", "不動產投資"],
            "家族辦公室": ["家族", "不動產投資"],
            "保險": ["保險資金", "不動產投資"],
            "保險資金": ["保險", "不動產投資"],
            "證券化": ["資產證券化", "不動產投資"],
            "資產證券化": ["證券化", "不動產投資"],
            "建商": ["建商信託", "不動產投資"],
            "建商信託": ["建商", "不動產投資"],
            "投資顧問": ["不動產投資顧問", "不動產投資"],
            "不動產投資顧問": ["投資顧問", "不動產投資"],
            "工程險": ["工程險", "風險保障"],
            "責任險": ["責任險", "風險保障"],
            "產險": ["產險", "風險保障"],
            "工程履約保證": ["履約", "風險保障"],
            "建築履約保證": ["履約", "風險保障"],
            "預付款": ["預付款保證", "風險保障"],
            "預付款保證": ["預付款", "風險保障"],
            "不動產估價師": ["估價", "法律服務"],
            "公證": ["公證人", "法律服務"],
            "公證人": ["公證", "法律服務"],
            "循環": ["循環經濟", "環境設計"],
            "循環經濟": ["循環", "環境設計"],
            "永續": ["永續規劃", "環境設計"],
            "永續規劃": ["永續", "環境設計"],
            "綠建築": ["綠建築設計", "環境設計"],
            "綠建築設計": ["綠建築", "環境設計"],
            "節能設計": ["節能", "環境設計"],
            "環保設計": ["環保", "環境設計"],
            "基礎": ["基礎設計", "結構設計"],
            "基礎設計": ["基礎", "結構設計"],
            "結構計算": ["結構", "結構設計"],
            "抗震": ["抗震設計", "結構設計"],
            "抗震設計": ["抗震", "結構設計"],
            "耐震": ["耐震補強設計", "結構設計"],
            "耐震補強設計": ["耐震", "結構設計"],
            "載重": ["載重分析", "結構設計"],
            "載重分析": ["載重", "結構設計"],
            "隔套": ["合法隔套設計", "特殊規劃"],
            "合法隔套設計": ["隔套", "特殊規劃"],
            "模組化": ["模組化輕裝修", "特殊規劃"],
            "模組化輕裝修": ["模組化", "特殊規劃"],
            "旅宿": ["旅宿資產活化", "特殊規劃"],
            "旅宿資產活化": ["旅宿", "特殊規劃"],
            "機電顧問": ["機電", "機電設計"],
            "消防顧問": ["消防", "機電設計"],
            "弱電顧問": ["弱電", "機電設計"],
            "空調設計": ["空調", "機電設計"],
            "空間規劃": ["空間", "室內設計"],
            "燈光": ["燈光設計", "室內設計"],
            "燈光設計": ["燈光", "室內設計"],
            "軟裝": ["軟裝設計", "室內設計"],
            "軟裝設計": ["軟裝", "室內設計"],
            "商空": ["商空室內設計", "室內設計"],
            "商空室內設計": ["商空", "室內設計"],
            "長照": ["長照空間規劃", "室內設計"],
            "長照空間規劃": ["長照", "室內設計"],
            "都市計畫": ["都市計畫顧問", "建築設計"],
            "都市計畫顧問": ["都市計畫", "建築設計"],
            "景觀": ["景觀設計", "建築設計"],
            "景觀設計": ["景觀", "建築設計"],
            "預售屋代銷": ["預售", "建案行銷"],
            "成屋代銷": ["成屋", "建案行銷"],
            "建案代銷": ["建案", "建案行銷"],
            "豪宅": ["豪宅代銷", "建案行銷"],
            "豪宅代銷": ["豪宅", "建案行銷"],
            "海外代銷": ["海外", "建案行銷"],
            "網站": ["網站建置", "數位行銷"],
            "網站建置": ["網站", "數位行銷"],
            "Instagram": ["Instagram行銷", "數位行銷"],
            "Instagram行銷": ["Instagram", "數位行銷"],
            "YouTube": ["YouTube行銷", "數位行銷"],
            "YouTube行銷": ["YouTube", "數位行銷"],
            "LINE": ["LINE官方帳號", "數位行銷"],
            "LINE官方帳號": ["LINE", "數位行銷"],
            "代操": ["數位廣告代操", "數位行銷"],
            "數位廣告代操": ["代操", "數位行銷"],
            "文宣": ["建案文宣", "內容行銷"],
            "建案文宣": ["文宣", "內容行銷"],
            "新聞稿": ["新聞稿代寫", "內容行銷"],
            "新聞稿代寫": ["新聞稿", "內容行銷"],
            "直播": ["直播銷售", "內容行銷"],
            "直播銷售": ["直播", "內容行銷"],
            "短影音": ["短影音製作", "內容行銷"],
            "短影音製作": ["短影音", "內容行銷"],
            "品牌": ["品牌企劃", "傳統行銷"],
            "品牌企劃": ["品牌", "傳統行銷"],
            "企劃": ["行銷企劃", "傳統行銷"],
            "行銷企劃": ["企劃", "傳統行銷"],
            "媒體": ["媒體投放", "傳統行銷"],
            "媒體投放": ["媒體", "傳統行銷"],
            "活動": ["活動企劃", "傳統行銷"],
            "活動企劃": ["活動", "傳統行銷"],
            "招牌": ["招牌製作", "傳統行銷"],
            "招牌製作": ["招牌", "傳統行銷"],
            "會場": ["會場佈置", "傳統行銷"],
            "會場佈置": ["會場", "傳統行銷"],
            "可行性": ["可行性評估", "市場研究"],
            "可行性評估": ["可行性", "市場研究"],
            "投資評估": ["投資", "市場研究"],
            "租金": ["租金評估", "市場研究"],
            "租金評估": ["租金", "市場研究"],
            "價格": ["價格分析", "市場研究"],
            "價格分析": ["價格", "市場研究"],
            "不動產市場分析": ["市場", "市場研究"],
            "房產資訊網": ["房產", "資訊平台"],
            "信義": ["信義房屋網", "資訊平台"],
            "信義房屋網": ["信義", "資訊平台"],
            "永慶": ["永慶房屋網", "資訊平台"],
            "永慶房屋網": ["永慶", "資訊平台"],
            "社區": ["社區管理", "物業管理"],
            "社區管理": ["社區", "物業管理"],
            "大樓": ["大樓管理", "物業管理"],
            "大樓管理": ["大樓", "物業管理"],
            "設施": ["設施維護", "物業管理"],
            "設施維護": ["設施", "物業管理"],
            "物業顧問": ["物業", "物業管理"],
            "安全維護": ["安全", "物業管理"],
            "巡邏": ["巡邏服務", "安全維護"],
            "巡邏服務": ["巡邏", "安全維護"],
            "防盜": ["防盜系統", "安全維護"],
            "防盜系統": ["防盜", "安全維護"],
            "消防安全檢修": ["安全", "安全維護"],
            "定期": ["定期清潔", "清潔服務"],
            "定期清潔": ["定期", "清潔服務"],
            "深度": ["深度清潔", "清潔服務"],
            "深度清潔": ["深度", "清潔服務"],
            "外牆": ["外牆清洗", "清潔服務"],
            "外牆清洗": ["外牆", "清潔服務"],
            "除蟲": ["除蟲消毒", "清潔服務"],
            "除蟲消毒": ["除蟲", "清潔服務"],
            "保養": ["電梯保養", "機電維護"],
            "空調保養": ["空調", "機電維護"],
            "監控維護": ["監控", "機電維護"],
            "園藝設計": ["園藝", "園藝維護"],
            "植栽": ["植栽養護", "園藝維護"],
            "植栽養護": ["植栽", "園藝維護"],
            "景觀維護": ["景觀", "園藝維護"],
            "租客": ["租客服務", "租賃服務"],
            "租客服務": ["租客", "租賃服務"],
            "租約": ["租約管理", "租賃服務"],
            "租約管理": ["租約", "租賃服務"],
            "代收": ["租金代收", "租賃服務"],
            "租金代收": ["代收", "租賃服務"],
            "包租": ["包租代管", "租賃服務"],
            "包租代管": ["包租", "租賃服務"],
            "短期": ["短期租賃", "租賃服務"],
            "短期租賃": ["短期", "租賃服務"],
            "牆面": ["牆面修補", "修繕服務"],
            "牆面修補": ["牆面", "修繕服務"],
            "門窗": ["門窗維修", "修繕服務"],
            "門窗維修": ["門窗", "修繕服務"],
            "訪客": ["訪客管理系統", "數位平台"],
            "訪客管理系統": ["訪客", "數位平台"],
            "報修": ["維修報修系統", "數位平台"],
            "維修報修系統": ["報修", "數位平台"],
            "社區APP": ["APP", "數位平台"],
            "短期租賃管理": ["短期", "短租營運"],
            "預訂": ["預訂管理", "短租營運"],
            "預訂管理": ["預訂", "短租營運"],
            "清潔調配": ["清潔", "短租營運"],
            "客服": ["客服支援", "短租營運"],
            "客服支援": ["客服", "短租營運"],
            "Airbnb代營運": ["Airbnb", "短租營運"],
            "吊車": ["吊車", "施工設備"],
            "泵車": ["泵車", "施工設備"],
            "高空": ["高空作業", "施工設備"],
            "高空作業": ["高空", "施工設備"],
            "測量": ["測量儀器", "施工設備"],
            "測量儀器": ["測量", "施工設備"],
            "切割": ["切割設備", "施工設備"],
            "切割設備": ["切割", "施工設備"],
            "焊接設備": ["焊接", "施工設備"],
            "粗清": ["粗清", "施工清潔"],
            "細清": ["細清", "施工清潔"],
            "廢棄物": ["廢棄物處理", "施工清潔"],
            "廢棄物處理": ["廢棄物", "施工清潔"],
            "總包": ["總包", "營造管理"],
            "分包": ["分包管理", "營造管理"],
            "分包管理": ["分包", "營造管理"],
            "營造商": ["營造", "營造管理"],
            "營建整合": ["營建", "營造管理"],
            "鋼筋": ["鋼筋", "建材供應"],
            "混凝土": ["混凝土", "建材供應"],
            "模板": ["模板", "建材供應"],
            "隔熱材料": ["隔熱", "建材供應"],
            "防火": ["防火建材", "建材供應"],
            "防火建材": ["防火", "建材供應"],
            "綠建材": ["綠", "建材供應"],
            "輕隔間": ["隔間", "建材供應"],
            "照明": ["照明設備", "建材供應"],
            "照明設備": ["照明", "建材供應"],
            "系統櫃": ["櫃", "建材供應"],
            "窗簾": ["窗簾窗飾", "建材供應"],
            "窗簾窗飾": ["窗簾", "建材供應"],
            "驗收流程": ["驗收", "交付服務"],
            "點交": ["點交服務", "交付服務"],
            "點交服務": ["點交", "交付服務"],
            "使用說明": ["說明", "交付服務"],
            "建築法規": ["法規", "法規諮詢"],
            "環保法規": ["環保", "法規諮詢"],
            "ESG": ["ESG／碳盤查顧問", "法規諮詢"],
            "ESG／碳盤查顧問": ["ESG", "法規諮詢"],
            "碳盤查": ["ESG／碳盤查顧問", "法規諮詢"],
            "消防法規": ["消防", "法規諮詢"],
            "水土保持": ["水土保持法規", "法規諮詢"],
            "水土保持法規": ["水土保持", "法規諮詢"],
            "遺產": ["遺產規劃", "稅務規劃"],
            "遺產規劃": ["遺產", "稅務規劃"],
            "信託與受託機構": ["信託", "稅務規劃"],
            "節稅": ["節稅規劃", "稅務規劃"],
            "節稅規劃": ["節稅", "稅務規劃"],
            "不動產稅務規劃": ["稅務", "稅務規劃"],
            "房屋買賣": ["房屋買賣與交易", "仲介服務", "交易服務"],
            "房屋買賣與交易": ["房屋買賣", "仲介服務", "交易服務"],
            "理財": ["理財規劃", "理財顧問", "投資理財", "理財規劃與資金"],
            "理財規劃": ["理財", "理財顧問", "投資理財", "理財規劃與資金"],
            "理財規劃與資金": ["理財", "理財規劃", "貸款服務", "稅務規劃"],
            "投資理財": ["理財", "理財規劃", "理財顧問"],
            "房貸": ["購屋貸款", "房貸轉增貸", "房貸代償", "貸款服務", "理財規劃與資金"],
            "房貸代償": ["房貸", "貸款服務"],
            "富邦人壽": ["保險", "保險服務", "壽險", "理財規劃與資金"],
            "國泰人壽": ["保險", "保險服務", "壽險"],
            "新光人壽": ["保險", "保險服務", "壽險"],
            "南山人壽": ["保險", "保險服務", "壽險"],
            "保險": ["保險服務", "富邦人壽", "國泰人壽", "新光人壽", "南山人壽", "壽險", "產險"],
            "保險服務": ["保險", "富邦人壽", "理財規劃與資金"],
            "壽險": ["保險", "保險服務", "富邦人壽"],
            "產險": ["保險", "保險服務", "產物保險"],
            "仲介": ["仲介服務", "住宅仲介", "商業不動產"],
            "仲介服務": ["仲介", "房屋買賣與交易"],
            "不動產經紀": ["仲介", "仲介服務"],
            "點交過戶": ["過戶", "交易服務"],
            "中古屋": ["成屋", "特殊物件"],
            "新成屋": ["成屋", "特殊物件"],
            "重劃區開發": ["土地開發", "特殊渠道"],
            "不動產登記": ["地政", "地政服務"],
            "信用貸款": ["貸款", "貸款服務"],
            "企業貸款": ["貸款", "貸款服務"],
            "土地融資": ["融資", "建築融資"],
            "建築融資規劃": ["融資", "建築融資"],
            "不動產證券化": ["投資", "不動產投資"],
            "火險": ["保險", "風險保障"],
            "地震險": ["保險", "風險保障"],
            "財產移轉規劃": ["稅務", "稅務規劃"],
            "裝潢設計": ["裝潢", "室內裝潢", "設計與規劃"],
            "裝潢": ["裝潢設計", "室內裝潢"],
            "室內裝潢": ["裝潢", "裝潢設計"],
            "軟裝設計": ["軟裝", "軟裝佈置", "設計與規劃"],
            "軟裝": ["軟裝設計", "軟裝佈置"],
            "軟裝佈置": ["軟裝", "軟裝設計"],
            "傢俱": ["傢俱採購", "傢俱設計", "訂製傢俱", "傢俱配置"],
            "傢俱配置": ["傢俱", "軟裝設計"],
            "窗簾設計": ["窗簾", "軟裝設計"],
            "燈飾搭配": ["燈飾", "軟裝設計"],
            "藝術擺設": ["擺設", "軟裝設計"],
            "天花板設計": ["天花板", "裝潢設計"],
            "牆面設計": ["牆面", "裝潢設計"],
            "地板設計": ["地板", "裝潢設計"],
            "色彩規劃": ["色彩", "裝潢設計"],
            "照明設計": ["照明", "燈光設計"],
            "燈光規劃": ["燈光", "燈光設計"],
            "氛圍營造": ["氛圍", "燈光設計"],
            "智能照明設計": ["智能照明", "燈光設計"],
            "多功能傢俱": ["傢俱", "傢俱設計"],
            "居家收納設計": ["收納", "傢俱設計"],
            "修繕": ["修繕服務", "工程規劃與修繕"],
            "修繕服務": ["修繕", "工程規劃與修繕"],
            "房屋修繕": ["修繕", "修繕服務"],
            "老屋翻新": ["翻新", "修繕服務"],
            "漏水修繕": ["漏水", "修繕服務"],
            "牆面修補": ["修補", "修繕服務"],
            "傢俱採購": ["傢俱", "傢俱傢電與建材"],
            "傢俱設計": ["傢俱", "室內設計", "設計與規劃"],
            "訂製傢俱": ["傢俱", "室內設計", "傢俱採購", "設計與規劃"],
            "家電": ["家電採購", "家電"],
            "家電採購": ["家電", "傢俱傢電與建材"],
            "寢具": ["寢具採購", "寢具"],
            "寢具採購": ["寢具", "傢俱傢電與建材"],
            "建材": ["建材採購", "建材供應", "基礎建材", "結構建材"],
            "建材採購": ["建材", "傢俱傢電與建材"],
            "建材供應": ["建材", "工程規劃與修繕"],
            "基礎建材": ["建材", "建材供應", "建材採購"],
            "結構建材": ["建材", "建材供應", "建材採購"],
            "購買": ["傢俱採購", "家電採購", "寢具採購", "建材採購"],
            "採購": ["傢俱採購", "家電採購", "寢具採購", "建材採購"],
            "系統家具": ["系統傢俱", "木作工程", "傢俱採購"],
            "系統傢俱": ["系統家具", "傢俱採購"],
            "木作建材": ["木作", "木作工程", "建材採購"]
        };
        
        // 獲取同義詞的擴展搜索詞
        function getExpandedSearchTerms(query) {
            const terms = [query];
            if (searchSynonyms[query]) {
                terms.push(...searchSynonyms[query]);
            }
            return terms;
        }

        // 初始化搜索功能
        function initEnhancedSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClearBtn = document.getElementById('searchClearBtn');
            
            // 添加鍵盤事件監聽
            searchInput.addEventListener('keydown', handleSearchKeydown);
            
            // 添加焦點事件
            searchInput.addEventListener('focus', showSearchSuggestions);
            
            // 更新清除按鈕顯示
            searchInput.addEventListener('input', function() {
                searchClearBtn.style.opacity = this.value ? '1' : '0';
            });
        }

        // 處理搜索鍵盤事件
        function handleSearchKeydown(e) {
            const results = document.getElementById('searchResults');
            if (!results) return;
            
            const resultItems = results.querySelectorAll('.search-result-item');
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedResultIndex = Math.min(selectedResultIndex + 1, resultItems.length - 1);
                    updateSelectedResult(resultItems);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedResultIndex = Math.max(selectedResultIndex - 1, -1);
                    updateSelectedResult(resultItems);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedResultIndex >= 0 && resultItems[selectedResultIndex]) {
                        resultItems[selectedResultIndex].click();
                    }
                    break;
                case 'Escape':
                    closeSearchResults();
                    document.getElementById('searchInput').blur();
                    break;
            }
        }

        // 更新選中的搜索結果
        function updateSelectedResult(resultItems) {
            resultItems.forEach((item, index) => {
                if (index === selectedResultIndex) {
                    item.classList.add('highlight');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('highlight');
                }
            });
        }

        // 顯示搜索建議（歷史記錄和熱門搜索）
        function showSearchSuggestions() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (query) return; // 有輸入時不顯示建議
            
            closeSearchResults();
            
            // 創建建議容器
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.id = 'searchResults';
            suggestionsContainer.style.cssText = `
                position: fixed;
                top: 85px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 600px;
                max-height: 400px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                overflow-y: auto;
                padding: 20px;
            `;
            
            let suggestionsHTML = '';
            
            // 顯示搜索歷史
            if (searchHistory.length > 0) {
                suggestionsHTML += `
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <strong style="color: #667eea; font-size: 14px;">🕐 最近搜索</strong>
                        </div>
                        <div>
                            ${searchHistory.slice(0, 5).map(term => `
                                <div class="search-history-item" onclick="searchFromHistory('${term}')">
                                    <span class="search-history-icon">🕐</span>
                                    <span>${term}</span>
                                    <span class="search-history-delete" onclick="removeFromHistory('${term}', event)">✕</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 顯示熱門搜索
            const popularSearches = getPopularSearches();
            if (popularSearches.length > 0) {
                suggestionsHTML += `
                    <div>
                        <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                            <strong style="color: #667eea; font-size: 14px;">🔥 熱門搜索</strong>
                        </div>
                        <div class="popular-tags">
                            ${popularSearches.map(term => `
                                <span class="popular-tag" onclick="searchFromHistory('${term}')">${term}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            suggestionsContainer.innerHTML = suggestionsHTML;
            document.body.appendChild(suggestionsContainer);
        }

        // 從歷史記錄搜索
        function searchFromHistory(term) {
            document.getElementById('searchInput').value = term;
            document.getElementById('searchInput').dispatchEvent(new Event('input'));
        }

        // 移除搜索歷史
        function removeFromHistory(term, event) {
            event.stopPropagation();
            searchHistory = searchHistory.filter(t => t !== term);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            showSearchSuggestions();
        }

        // 獲取熱門搜索
        function getPopularSearches() {
            return [
                '室內設計', '水電工程', '油漆', '木工', 
                '冷氣', '清潔', '律師', '會計師'
            ];
        }

        // 添加到搜索歷史
        function addToSearchHistory(query) {
            // 移除重複項
            searchHistory = searchHistory.filter(t => t !== query);
            // 添加到開頭
            searchHistory.unshift(query);
            // 限制歷史記錄數量
            searchHistory = searchHistory.slice(0, 10);
            // 保存到本地存儲
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
            clearHighlights();
            closeSearchResults();
            selectedResultIndex = -1;
        }

        // 高亮關鍵字
        function highlightKeyword(text, keyword) {
            if (!keyword) return text;
            
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // 拖拽功能
        function startDrag(e) {
            if (e.target.closest('.branch-node, .sub-node, .center-node')) return;
            isDragging = true;
            dragStart.x = e.clientX;
            dragStart.y = e.clientY;
            document.getElementById('mindmapContainer').classList.add('dragging');
        }

        function drag(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStart.x;
            const deltaY = e.clientY - dragStart.y;
            
            const container = document.getElementById('mindmapContainer');
            container.scrollLeft -= deltaX;
            container.scrollTop -= deltaY;
            
            dragStart.x = e.clientX;
            dragStart.y = e.clientY;
        }

        function endDrag() {
            isDragging = false;
            document.getElementById('mindmapContainer').classList.remove('dragging');
        }

        // 滾輪滑動功能
        function handleZoom(e) {
            e.preventDefault();
            const container = document.getElementById('mindmapContainer');
            const scrollAmount = 50; // 每次滾動的像素數
            
            if (e.deltaY > 0) {
                // 向下滾動
                container.scrollTop += scrollAmount;
            } else {
                // 向上滾動
                container.scrollTop -= scrollAmount;
            }
        }

        function zoomIn() {
            setZoom(currentZoom + 0.2);
        }

        function zoomOut() {
            setZoom(currentZoom - 0.2);
        }

        function setZoom(zoom) {
            currentZoom = Math.max(0.3, Math.min(2, zoom));
            const content = document.getElementById('mindmapContent');
            content.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        // 鍵盤快捷鍵
        function handleKeydown(e) {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    if (isExpanded) collapseMindmap(); else expandMindmap();
                    break;
                case 'e':
                case 'E':
                    e.preventDefault();
                    expandAll();
                    break;
                case 'c':
                case 'C':
                    e.preventDefault();
                    collapseAll();
                    break;
                case 'r':
                case 'R':
                    e.preventDefault();
                    resetView();
                    break;
                case 'Escape':
                    closeDetails();
                    break;
            }
        }

        // 控制函數
        function expandAll() {
            expandMindmap();
        }

        function collapseAll() {
            collapseMindmap();
        }

        function resetView() {
            collapseAll();
            setZoom(1);
            document.getElementById('mindmapContent').style.transform = 'scale(1)';
            setTimeout(() => {
                expandMindmap();
            }, 100);
        }

        function exportPNG() {
            const container = document.getElementById('mindmapContainer');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            html2canvas(container).then(canvas => {
                const link = document.createElement('a');
                link.download = '華泰不動產心智圖.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        // 測試引薦資料保存功能
        function testReferralData() {
            console.log('=== 引薦資料測試 ===');
            console.log('當前引薦資料庫:', referralData);
            
            const savedData = localStorage.getItem('referralData');
            console.log('本地存儲的引薦資料:', savedData ? JSON.parse(savedData) : '無');
            
            // 測試添加一個引薦資料
            const testReferral = {
                referrerCode: 'TEST001',
                companyName: '測試公司',
                phone: '0912-345-678',
                lineId: 'test_line',
                area: '台北市',
                note: '測試引薦',
                referralDate: new Date().toISOString()
            };
            
            const testService = '測試服務';
            referralData[testService] = [testReferral];
            localStorage.setItem('referralData', JSON.stringify(referralData));
            
            console.log('測試引薦資料已添加:', testReferral);
            console.log('更新後的引薦資料庫:', referralData);
        }
        
        // 測試直接添加引薦人功能
        function testDirectAddReferral() {
            console.log('=== 測試直接添加引薦人 ===');
            
            // 模擬點擊項目
            const testItem = '泥作';
            const testCategory = '🔺 上游｜供應端與原材料';
            const testSubCategory = '基礎建材';
            
            // 設置currentDetails
            currentDetails = {
                item: testItem,
                category: testCategory,
                subCategory: testSubCategory
            };
            
            console.log('設置currentDetails:', currentDetails);
            
            // 測試addReferral函數
            console.log('測試addReferral函數...');
            addReferral();
            
            console.log('如果看到引薦登記表單，表示功能正常');
        }
        
        // 測試Apps Script連接
        async function testAppsScriptConnection() {
            console.log('=== 測試 Apps Script 連接 ===');
            console.log('Apps Script URL:', SHEET_CONFIG.APPS_SCRIPT_URL);
            
            try {
                // 使用GET請求測試連接
                const response = await fetch(SHEET_CONFIG.APPS_SCRIPT_URL + '?test=1');
                const result = await response.json();
                
                if (response.ok) {
                    console.log('✅ Apps Script 連接成功');
                    return true;
                } else {
                    console.error('❌ Apps Script 連接失敗:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ Apps Script 連接錯誤:', error);
                console.log('嘗試使用表單提交方式...');
                return testWithFormSubmission();
            }
        }
        
        // 使用表單提交方式測試（避免CORS問題，不會跳出）
        function testWithFormSubmission() {
            console.log('=== 使用表單提交方式測試（隱藏 iframe） ===');
            
            // 創建隱藏 iframe
            const iframe = document.createElement('iframe');
            iframe.name = 'test_' + Date.now();
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = SHEET_CONFIG.APPS_SCRIPT_URL;
            form.target = iframe.name;
            form.style.display = 'none';
            
            const testData = {
                action: 'test',
                timestamp: new Date().toISOString()
            };
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(testData);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            
            // 清理
            setTimeout(() => {
                try {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                } catch (e) {
                    console.warn('清理測試表單時發生錯誤:', e);
                }
            }, 1000);
            
            console.log('✅ 表單提交測試已發送（隱藏提交，不會跳出）');
            return true;
        }
        
        // 測試引薦資料提交
        async function testReferralSubmission() {
            console.log('=== 測試引薦資料提交 ===');
            
            const testData = [
                new Date().toISOString(),
                '測試服務',
                'TEST001',
                '測試公司',
                '0912-345-678',
                'test_line',
                '台北市',
                '測試引薦'
            ];
            
            console.log('測試資料:', testData);
            
            try {
                const success = await submitToAppsScript(testData, 'referral');
                if (success) {
                    console.log('✅ 引薦資料提交成功');
                    alert('✅ 引薦資料提交成功！請檢查Google Sheets。');
                } else {
                    console.log('❌ 引薦資料提交失敗');
                    alert('❌ 引薦資料提交失敗，請檢查Console錯誤訊息。');
                }
                return success;
            } catch (error) {
                console.error('❌ 引薦資料提交錯誤:', error);
                alert('❌ 引薦資料提交錯誤: ' + error.message);
                return false;
            }
        }
        
        // 顯示資料查看功能
        function showDataView() {
            const accessLogs = JSON.parse(localStorage.getItem('contactAccessLogs') || '[]');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            
            // 計算統計數據
            const totalReferrals = Object.values(referralData).reduce((sum, refs) => {
                return sum + (Array.isArray(refs) ? refs.length : 1);
            }, 0);
            
            // 創建資料查看容器
            const dataContainer = document.createElement('div');
            dataContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const dataDialog = document.createElement('div');
            dataDialog.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8f9fa);
                padding: 0;
                border-radius: 20px;
                width: 95%;
                max-width: 900px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1);
                animation: slideUp 0.4s ease-out;
            `;
            
            let dataHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .data-header {
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 20px 20px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .data-header h3 {
                        margin: 0;
                        font-size: 24px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .close-btn {
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 28px;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                    }
                    .close-btn:hover {
                        background: rgba(255,255,255,0.3);
                        transform: rotate(90deg);
                    }
                    .data-content {
                        padding: 30px;
                    }
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 15px;
                        margin-bottom: 30px;
                    }
                    .stat-card {
                        background: linear-gradient(135deg, #f8f9ff, #ffffff);
                        border: 2px solid #e3e8ff;
                        border-radius: 15px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
                        transition: all 0.3s ease;
                    }
                    .stat-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
                    }
                    .stat-icon {
                        font-size: 32px;
                        margin-bottom: 8px;
                    }
                    .stat-number {
                        font-size: 28px;
                        font-weight: 700;
                        color: #667eea;
                        margin: 8px 0;
                    }
                    .stat-label {
                        font-size: 13px;
                        color: #666;
                        font-weight: 600;
                    }
                    .section-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #333;
                        margin: 25px 0 12px 0;
                        padding-bottom: 8px;
                        border-bottom: 3px solid #667eea;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .referral-list {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    @media (max-width: 768px) {
                        .stats-grid {
                            grid-template-columns: repeat(3, 1fr);
                            gap: 10px;
                        }
                        .stat-card {
                            padding: 12px;
                        }
                        .stat-icon {
                            font-size: 28px;
                            margin-bottom: 6px;
                        }
                        .stat-number {
                            font-size: 24px;
                            margin: 6px 0;
                        }
                        .stat-label {
                            font-size: 12px;
                        }
                        .referral-list {
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                        }
                        .referral-item {
                            padding: 12px;
                        }
                        .referral-service {
                            font-size: 14px;
                        }
                        .referral-count {
                            font-size: 12px;
                        }
                        .section-title {
                            font-size: 16px;
                            margin: 20px 0 10px 0;
                        }
                        .data-content {
                            padding: 20px 15px;
                        }
                        .data-header {
                            padding: 15px 20px;
                        }
                        .data-header h3 {
                            font-size: 20px;
                        }
                    }
                    @media (max-width: 480px) {
                        .stats-grid {
                            grid-template-columns: repeat(3, 1fr);
                            gap: 8px;
                        }
                        .stat-card {
                            padding: 10px 8px;
                        }
                        .stat-icon {
                            font-size: 24px;
                            margin-bottom: 4px;
                        }
                        .stat-number {
                            font-size: 20px;
                            margin: 4px 0;
                        }
                        .stat-label {
                            font-size: 11px;
                        }
                        .referral-list {
                            grid-template-columns: repeat(2, 1fr);
                            gap: 8px;
                        }
                        .referral-item {
                            padding: 10px;
                        }
                        .referral-service {
                            font-size: 13px;
                        }
                        .referral-count {
                            font-size: 11px;
                        }
                        .log-item {
                            padding: 12px;
                        }
                        .log-service {
                            font-size: 14px;
                        }
                        .log-info {
                            font-size: 12px;
                        }
                        .log-time {
                            font-size: 11px;
                        }
                    }
                    .referral-item {
                        background: linear-gradient(135deg, #f8f9fa, #ffffff);
                        border-left: 4px solid #667eea;
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        transition: all 0.3s ease;
                    }
                    .referral-item:hover {
                        transform: translateX(5px);
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
                    }
                    .referral-service {
                        font-weight: 700;
                        color: #333;
                        font-size: 15px;
                        margin-bottom: 5px;
                    }
                    .referral-count {
                        color: #667eea;
                        font-weight: 600;
                        font-size: 13px;
                    }
                    .log-list {
                        max-height: 300px;
                        overflow-y: auto;
                    }
                    .log-item {
                        background: linear-gradient(135deg, #fff9e6, #ffffff);
                        border-left: 4px solid #ff9800;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 12px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        transition: all 0.3s ease;
                    }
                    .log-item:hover {
                        transform: translateX(5px);
                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.2);
                    }
                    .log-service {
                        font-weight: 700;
                        color: #333;
                        font-size: 15px;
                        margin-bottom: 5px;
                    }
                    .log-info {
                        color: #666;
                        font-size: 13px;
                        margin: 5px 0;
                    }
                    .log-time {
                        color: #999;
                        font-size: 12px;
                        margin-top: 8px;
                    }
                    .empty-state {
                        text-align: center;
                        padding: 40px;
                        color: #999;
                        font-size: 16px;
                    }
                    ::-webkit-scrollbar {
                        width: 8px;
                    }
                    ::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 4px;
                    }
                    ::-webkit-scrollbar-thumb {
                        background: #667eea;
                        border-radius: 4px;
                    }
                    ::-webkit-scrollbar-thumb:hover {
                        background: #5a6fd8;
                    }
                </style>
                
                <div class="data-header">
                    <h3>📊 資料查看</h3>
                    <button class="close-btn" onclick="closeDataView()">×</button>
                </div>
                
                <div class="data-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📋</div>
                            <div class="stat-number">${Object.keys(referralData).length}</div>
                            <div class="stat-label">服務項目</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">👥</div>
                            <div class="stat-number">${totalReferrals}</div>
                            <div class="stat-label">總引薦人數</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📝</div>
                            <div class="stat-number">${accessLogs.length}</div>
                            <div class="stat-label">使用記錄數</div>
                        </div>
                    </div>
                    
                    ${Object.keys(referralData).length > 0 ? `
                        <div class="section-title">📋 引薦資料詳情</div>
                        <div class="referral-list">
                            ${Object.keys(referralData).map(service => {
                                const referrals = Array.isArray(referralData[service]) ? referralData[service] : [referralData[service]];
                                return `
                                    <div class="referral-item">
                                        <div class="referral-service">${service}</div>
                                        <div class="referral-count">${referrals.length} 位引薦人</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
                            <div>暫無引薦資料</div>
                        </div>
                    `}
                    
                    ${accessLogs.length > 0 ? `
                        <div class="section-title">📝 最近使用記錄</div>
                        <div class="log-list">
                            ${accessLogs.slice(-5).reverse().map(log => {
                                const time = new Date(log.accessTime).toLocaleString('zh-TW');
                                return `
                                    <div class="log-item">
                                        <div class="log-service">${log.serviceItem}</div>
                                        <div class="log-info">引薦人：${log.referrerCode}</div>
                                        ${log.memberCode ? `<div class="log-info">成員編號：${log.memberCode}</div>` : ''}
                                        <div class="log-time">${time}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
                            <div>暫無使用記錄</div>
                        </div>
                    `}
                </div>
            `;
            
            dataDialog.innerHTML = dataHTML;
            dataContainer.appendChild(dataDialog);
            document.body.appendChild(dataContainer);
        }
        
        // 關閉資料查看
        function closeDataView() {
            const dataContainer = document.querySelector('div[style*="z-index: 2000"]');
            if (dataContainer) {
                dataContainer.remove();
            }
        }
        
        // 測試會員搜索功能（可在控制台調用）
        window.testMemberSearch = async function(code) {
            console.log('🧪 測試會員搜索功能');
            console.log('輸入編號:', code);
            
            // 重新載入會員資料
            memberDataCache = null;
            memberDataCacheTime = null;
            
            const memberData = await loadMemberData();
            console.log('📊 會員資料數量:', Object.keys(memberData).length);
            
            // 測試搜索
            const result = await searchMemberName(code);
            console.log('🎯 搜索結果:', result || '未找到');
            
            return { memberData, result };
        };
        
        // 查看當前會員資料（可在控制台調用）
        window.showMemberData = function() {
            try {
                if (memberDataCache) {
                    console.log('📊 當前會員資料緩存:');
                    // 創建不包含密碼的副本用於顯示
                    const sanitizedData = {};
                    Object.keys(memberDataCache).forEach(code => {
                        const member = memberDataCache[code];
                        sanitizedData[code] = {
                            name: member.name,
                            professionalCategory: member.professionalCategory
                        };
                    });
                    console.table(sanitizedData);
                } else {
                    console.log('📊 當前會員資料緩存: 無');
                }
                console.log('📊 緩存時間:', memberDataCacheTime ? new Date(memberDataCacheTime).toLocaleString() : '無');
                console.log('📊 會員資料數量:', memberDataCache ? Object.keys(memberDataCache).length : 0);
            } catch (error) {
                console.error('查看會員資料時發生錯誤:', error);
            }
            
            return memberDataCache;
        };
    </script>
    
    <!-- 引入html2canvas庫用於匯出功能 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 版權聲明 -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); padding: 8px; text-align: center; font-size: 11px; color: #666; z-index: 1000; border-top: 1px solid #e0e0e0;">
        © 2025 華地產鑽石分會 版權所有 | 引薦平台系統
    </div>
</body>
</html>